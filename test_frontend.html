<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>å‰ç«¯åŠŸèƒ½æµ‹è¯•</title>
    <script src="https://cdn.jsdelivr.net/npm/plotly.js@2.27.0/dist/plotly.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; }
        .success { color: green; }
        .error { color: red; }
        .warning { color: orange; }
        #test-chart { width: 100%; height: 400px; margin: 10px 0; }
    </style>
</head>
<body>
    <h1>ğŸ“Š å‰ç«¯åŠŸèƒ½æµ‹è¯•é¡µé¢</h1>
    
    <div class="test-section">
        <h2>æµ‹è¯•1: Plotlyåº“åŠ è½½</h2>
        <div id="test1-result">æ£€æµ‹ä¸­...</div>
    </div>
    
    <div class="test-section">
        <h2>æµ‹è¯•2: APIè¿æ¥æµ‹è¯•</h2>
        <div id="test2-result">æ£€æµ‹ä¸­...</div>
    </div>
    
    <div class="test-section">
        <h2>æµ‹è¯•3: æ•°æ®å®Œæ•´æ€§æµ‹è¯•</h2>
        <div id="test3-result">æ£€æµ‹ä¸­...</div>
    </div>
    
    <div class="test-section">
        <h2>æµ‹è¯•4: Kçº¿å›¾æ¸²æŸ“æµ‹è¯•</h2>
        <div id="test4-result">æ£€æµ‹ä¸­...</div>
        <div id="test-chart"></div>
    </div>
    
    <script>
        // æµ‹è¯•1: Plotlyåº“
        function test1() {
            const result = document.getElementById('test1-result');
            if (typeof Plotly !== 'undefined') {
                result.innerHTML = '<span class="success">âœ… Plotlyåº“åŠ è½½æˆåŠŸ</span>';
                result.innerHTML += `<br>ç‰ˆæœ¬: ${Plotly.version || 'æœªçŸ¥'}`;
                return true;
            } else {
                result.innerHTML = '<span class="error">âŒ Plotlyåº“æœªåŠ è½½</span>';
                return false;
            }
        }
        
        // æµ‹è¯•2: APIè¿æ¥
        async function test2() {
            const result = document.getElementById('test2-result');
            try {
                const response = await fetch('http://127.0.0.1:5000/api/latest_date');
                const data = await response.json();
                result.innerHTML = '<span class="success">âœ… APIè¿æ¥æˆåŠŸ</span>';
                result.innerHTML += `<br>æœ€æ–°æ—¥æœŸ: ${data.date}`;
                return true;
            } catch (error) {
                result.innerHTML = `<span class="error">âŒ APIè¿æ¥å¤±è´¥: ${error.message}</span>`;
                return false;
            }
        }
        
        // æµ‹è¯•3: æ•°æ®å®Œæ•´æ€§
        async function test3() {
            const result = document.getElementById('test3-result');
            try {
                const response = await fetch('http://127.0.0.1:5000/api/stock/603027?days=120');
                const data = await response.json();
                
                if (!data.success) {
                    result.innerHTML = `<span class="error">âŒ APIè¿”å›é”™è¯¯: ${data.error}</span>`;
                    return false;
                }
                
                // æ£€æŸ¥å¿…è¦å­—æ®µ
                const required = ['dates', 'open', 'close', 'high', 'low', 'volume',
                                'ma5', 'ma20', 'ma60', 'trend_short', 'trend_long',
                                'dif', 'dea', 'macd', 'k', 'd', 'j', 'signals'];
                
                const missing = required.filter(f => !(f in data));
                
                if (missing.length > 0) {
                    result.innerHTML = `<span class="error">âŒ ç¼ºå¤±å­—æ®µ: ${missing.join(', ')}</span>`;
                    return false;
                }
                
                result.innerHTML = '<span class="success">âœ… æ•°æ®å®Œæ•´</span>';
                result.innerHTML += `<br>æ•°æ®ç‚¹: ${data.dates.length}`;
                result.innerHTML += `<br>ä¿¡å·æ•°: B1=${data.signals.filter(s => s.type === 'B1').length}, `;
                result.innerHTML += `B2=${data.signals.filter(s => s.type === 'B2').length}, `;
                result.innerHTML += `S1=${data.signals.filter(s => s.type === 'S1').length}`;
                
                return data;
            } catch (error) {
                result.innerHTML = `<span class="error">âŒ æµ‹è¯•å¤±è´¥: ${error.message}</span>`;
                return false;
            }
        }
        
        // æµ‹è¯•4: Kçº¿å›¾æ¸²æŸ“
        async function test4(data) {
            const result = document.getElementById('test4-result');
            
            if (!data) {
                result.innerHTML = '<span class="warning">âš ï¸ è·³è¿‡ï¼ˆæ•°æ®è·å–å¤±è´¥ï¼‰</span>';
                return false;
            }
            
            try {
                // æå–ä¿¡å·
                const b1Signals = (data.signals || []).filter(s => s.type === 'B1');
                const b2Signals = (data.signals || []).filter(s => s.type === 'B2');
                const s1Signals = (data.signals || []).filter(s => s.type === 'S1');
                
                // ç®€å•Kçº¿å›¾
                const candlestick = {
                    x: data.dates,
                    open: data.open,
                    high: data.high,
                    low: data.low,
                    close: data.close,
                    type: 'candlestick',
                    name: 'Kçº¿'
                };
                
                // è¶‹åŠ¿çº¿
                const trendShort = {
                    x: data.dates,
                    y: data.trend_short,
                    type: 'scatter',
                    mode: 'lines',
                    name: 'çŸ­æœŸè¶‹åŠ¿',
                    line: {color: '#FF6B6B', width: 2}
                };
                
                const trendLong = {
                    x: data.dates,
                    y: data.trend_long,
                    type: 'scatter',
                    mode: 'lines',
                    name: 'é•¿æœŸè¶‹åŠ¿',
                    line: {color: '#1976D2', width: 2}
                };
                
                // B1æ ‡è®°
                const b1Markers = {
                    x: b1Signals.map(s => s.date),
                    y: b1Signals.map(s => s.price * 0.97),
                    mode: 'markers+text',
                    type: 'scatter',
                    name: 'B1ä¹°ç‚¹',
                    marker: {color: '#00C853', size: 15, symbol: 'triangle-up'},
                    text: b1Signals.map(() => 'B1'),
                    textposition: 'bottom center'
                };
                
                const chartData = [candlestick, trendShort, trendLong];
                if (b1Signals.length > 0) chartData.push(b1Markers);
                
                const layout = {
                    title: `${data.code} - æµ‹è¯•å›¾è¡¨ [B1:${b1Signals.length} B2:${b2Signals.length} S1:${s1Signals.length}]`,
                    xaxis: { type: 'date', rangeslider: {visible: false} },
                    yaxis: { title: 'ä»·æ ¼' },
                    height: 400
                };
                
                await Plotly.newPlot('test-chart', chartData, layout);
                
                result.innerHTML = '<span class="success">âœ… Kçº¿å›¾æ¸²æŸ“æˆåŠŸ</span>';
                result.innerHTML += `<br>å›¾è¡¨åŒ…å«: Kçº¿ + è¶‹åŠ¿çº¿ + äº¤æ˜“ä¿¡å·`;
                return true;
            } catch (error) {
                result.innerHTML = `<span class="error">âŒ æ¸²æŸ“å¤±è´¥: ${error.message}</span>`;
                console.error('æ¸²æŸ“é”™è¯¯:', error);
                return false;
            }
        }
        
        // è¿è¡Œæ‰€æœ‰æµ‹è¯•
        async function runAllTests() {
            console.log('å¼€å§‹æµ‹è¯•...');
            
            const test1Result = test1();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            const test2Result = await test2();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            const test3Data = await test3();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await test4(test3Data);
            
            console.log('æµ‹è¯•å®Œæˆï¼');
        }
        
        // é¡µé¢åŠ è½½åè¿è¡Œæµ‹è¯•
        window.addEventListener('load', () => {
            setTimeout(runAllTests, 1000);
        });
    </script>
</body>
</html>

