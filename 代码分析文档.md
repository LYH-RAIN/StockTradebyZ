# StockTradebyZ ä»£ç åº“è¯¦ç»†åˆ†ææ–‡æ¡£

## ğŸ“‹ ç›®å½•
1. [é¡¹ç›®æ¦‚è¿°](#é¡¹ç›®æ¦‚è¿°)
2. [æ•´ä½“æ¶æ„](#æ•´ä½“æ¶æ„)
3. [æ ¸å¿ƒæ¨¡å—è¯¦è§£](#æ ¸å¿ƒæ¨¡å—è¯¦è§£)
4. [æ•°æ®æµç¨‹](#æ•°æ®æµç¨‹)
5. [æŠ€æœ¯æŒ‡æ ‡è¯´æ˜](#æŠ€æœ¯æŒ‡æ ‡è¯´æ˜)
6. [é€‰è‚¡ç­–ç•¥è¯¦è§£](#é€‰è‚¡ç­–ç•¥è¯¦è§£)
7. [äºŒæ¬¡å¼€å‘æŒ‡å—](#äºŒæ¬¡å¼€å‘æŒ‡å—)
8. [å¸¸è§é—®é¢˜ä¸ä¼˜åŒ–å»ºè®®](#å¸¸è§é—®é¢˜ä¸ä¼˜åŒ–å»ºè®®)

---

## ğŸ¯ é¡¹ç›®æ¦‚è¿°

### é¡¹ç›®å®šä½
è¿™æ˜¯ä¸€ä¸ªåŸºäº **Zå“¥æˆ˜æ³•** çš„é‡åŒ–é€‰è‚¡ç³»ç»Ÿï¼Œä½¿ç”¨ Python å®ç°ï¼Œä¸“æ³¨äº **Aè‚¡å¸‚åœº**çš„æŠ€æœ¯é¢é€‰è‚¡ã€‚æ ¸å¿ƒæ€æƒ³æ˜¯é€šè¿‡å¤šä¸ªæŠ€æœ¯æŒ‡æ ‡çš„ç»„åˆï¼Œç­›é€‰å‡ºå¤„äºä½ä½ä¸”å…·å¤‡ä¸Šæ¶¨æ½œåŠ›çš„è‚¡ç¥¨ã€‚

### æ ¸å¿ƒç‰¹ç‚¹
- **æ•°æ®æº**ï¼šä½¿ç”¨ Tushare è·å–Aè‚¡æ—¥çº¿è¡Œæƒ…ï¼ˆå‰å¤æƒæ•°æ®ï¼‰
- **ç­–ç•¥ä¸°å¯Œ**ï¼šå†…ç½®5ç§æˆç†Ÿçš„é‡åŒ–é€‰è‚¡ç­–ç•¥
- **é«˜æ€§èƒ½**ï¼šæ”¯æŒå¤šçº¿ç¨‹å¹¶å‘æ•°æ®è·å–ä¸å¤„ç†
- **å¯é…ç½®**ï¼šé€šè¿‡ JSON é…ç½®æ–‡ä»¶çµæ´»è°ƒæ•´ç­–ç•¥å‚æ•°
- **çŸ¥è¡Œåˆä¸€**ï¼šèå…¥"çŸ¥è¡ŒçŸ­çº¿/é•¿çº¿"çº¦æŸï¼Œå¼ºåŒ–é£æ§

### æŠ€æœ¯æ ˆ
```
è¯­è¨€ï¼šPython 3.11/3.12
æ ¸å¿ƒä¾èµ–ï¼š
  - pandas (2.3.0): æ•°æ®å¤„ç†
  - tushare (1.4.21): è¡Œæƒ…æ•°æ®è·å–
  - scipy (1.14.1): ä¿¡å·å¤„ç†ï¼ˆå³°å€¼æ£€æµ‹ï¼‰
  - tqdm (4.66.4): è¿›åº¦æ¡æ˜¾ç¤º
  - numpy: æ•°å€¼è®¡ç®—
```

---

## ğŸ—ï¸ æ•´ä½“æ¶æ„

### ç›®å½•ç»“æ„
```
StockTradebyZ/
â”œâ”€â”€ fetch_kline.py              # æ•°æ®è·å–æ¨¡å—ï¼ˆTushareï¼‰
â”œâ”€â”€ select_stock.py             # é€‰è‚¡æ‰§è¡Œå…¥å£
â”œâ”€â”€ Selector.py                 # ç­–ç•¥æ ¸å¿ƒï¼ˆ5ä¸ªé€‰æ‹©å™¨ç±»ï¼‰
â”œâ”€â”€ SectorShift.py              # è¡Œä¸šåˆ†æï¼ˆJå€¼åˆ†å¸ƒç»Ÿè®¡ï¼‰
â”œâ”€â”€ find_stock_by_price_concurrent.py  # æŒ‰ä»·æ ¼æŸ¥è‚¡ç¥¨å·¥å…·
â”œâ”€â”€ configs.json                # ç­–ç•¥å‚æ•°é…ç½®
â”œâ”€â”€ stocklist.csv               # è‚¡ç¥¨æ± ï¼ˆ5431æ”¯è‚¡ç¥¨ï¼‰
â”œâ”€â”€ appendix.json               # é™„åŠ æ•°æ®ï¼ˆç¤ºä¾‹è‚¡ç¥¨ï¼‰
â”œâ”€â”€ requirements.txt            # ä¾èµ–æ¸…å•
â”œâ”€â”€ data/                       # è¡Œæƒ…CSVå­˜å‚¨ç›®å½•
â”œâ”€â”€ fetch.log                   # æ•°æ®æŠ“å–æ—¥å¿—
â””â”€â”€ select_results.log          # é€‰è‚¡ç»“æœæ—¥å¿—
```

### æ¨¡å—å…³ç³»å›¾
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ stocklist.csv   â”‚â”€â”€â”€â”€â”
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  configs.json   â”‚  â”‚ fetch_kline.py   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                    â”‚
         â”‚                    â–¼
         â”‚            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚            â”‚  data/*.csv  â”‚
         â”‚            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                    â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                      â–¼
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚ select_stock.py  â”‚
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â–¼
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚   Selector.py    â”‚â”€â”€â†’ é€‰è‚¡ç»“æœ
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”§ æ ¸å¿ƒæ¨¡å—è¯¦è§£

### 1. `fetch_kline.py` - æ•°æ®è·å–æ¨¡å—

#### æ ¸å¿ƒåŠŸèƒ½
ä» Tushare è·å– Aè‚¡æ—¥çº¿è¡Œæƒ…æ•°æ®ï¼ˆå‰å¤æƒï¼‰ï¼Œæ”¯æŒæ’é™¤åˆ›ä¸šæ¿/ç§‘åˆ›æ¿/åŒ—äº¤æ‰€ã€‚

#### å…³é”®è®¾è®¡
```python
# æ•°æ®è·å–ç­–ç•¥
- æ•°æ®æºï¼šTushare ts.pro_bar()
- å¤æƒæ–¹å¼ï¼šqfqï¼ˆå‰å¤æƒï¼Œç¡®ä¿å†å²ä»·æ ¼è¿ç»­æ€§ï¼‰
- ä¿å­˜ç­–ç•¥ï¼šå…¨é‡è¦†ç›–ï¼ˆæ¯æ¬¡è¿è¡Œå®Œå…¨é‡å†™CSVï¼‰
- å¹¶å‘æ§åˆ¶ï¼šThreadPoolExecutorï¼ˆé»˜è®¤6çº¿ç¨‹ï¼‰
- é™æµå¤„ç†ï¼šæ£€æµ‹å°ç¦å…³é”®å­—ï¼Œè§¦å‘600ç§’å†·å´
```

#### é‡è¦å‡½æ•°è§£æ

**1. `_to_ts_code(code: str) -> str`**
```python
# åŠŸèƒ½ï¼šå°†6ä½ä»£ç è½¬æ¢ä¸ºTushareæ ‡å‡†æ ¼å¼
# ç¤ºä¾‹ï¼š
#   600000 â†’ 600000.SHï¼ˆä¸Šæµ·ä¸»æ¿ï¼‰
#   000001 â†’ 000001.SZï¼ˆæ·±åœ³ä¸»æ¿ï¼‰
#   688001 â†’ 688001.SHï¼ˆç§‘åˆ›æ¿ï¼‰
#   300001 â†’ 300001.SZï¼ˆåˆ›ä¸šæ¿ï¼‰
#   430001 â†’ 430001.BJï¼ˆåŒ—äº¤æ‰€ï¼‰
```

**2. `_get_kline_tushare(code, start, end) -> pd.DataFrame`**
```python
# åŠŸèƒ½ï¼šè°ƒç”¨Tushare APIè·å–å•åªè‚¡ç¥¨Kçº¿
# è¿”å›åˆ—ï¼šdate, open, close, high, low, volume
# å¼‚å¸¸å¤„ç†ï¼š
#   - æ£€æµ‹é™æµ/å°ç¦ â†’ æŠ›å‡º RateLimitError
#   - å…¶ä»–å¼‚å¸¸ç›´æ¥æŠ›å‡º
```

**3. `load_codes_from_stocklist(stocklist_csv, exclude_boards)`**
```python
# åŠŸèƒ½ï¼šä»stocklist.csvè¯»å–è‚¡ç¥¨æ± å¹¶è¿‡æ»¤æ¿å—
# exclude_boards é€‰é¡¹ï¼š
#   - gem: æ’é™¤åˆ›ä¸šæ¿ï¼ˆ300/301å¼€å¤´ï¼‰
#   - star: æ’é™¤ç§‘åˆ›æ¿ï¼ˆ688å¼€å¤´ï¼‰
#   - bj: æ’é™¤åŒ—äº¤æ‰€ï¼ˆ.BJåç¼€æˆ–4/8å¼€å¤´ï¼‰
```

**4. `fetch_one(code, start, end, out_dir)`**
```python
# åŠŸèƒ½ï¼šæŠ“å–å•æ”¯è‚¡ç¥¨å¹¶ä¿å­˜ä¸ºCSV
# é‡è¯•æœºåˆ¶ï¼š
#   1) æœ€å¤š3æ¬¡å°è¯•
#   2) å°ç¦é”™è¯¯ â†’ å†·å´600ç§’
#   3) æ™®é€šé”™è¯¯ â†’ é€’å¢ç­‰å¾…ï¼ˆ15/30/45ç§’ï¼‰
# ä¿å­˜æ–¹å¼ï¼šç›´æ¥è¦†ç›–å†™å…¥ï¼Œä¸åšå¢é‡åˆå¹¶
```

#### ä½¿ç”¨ç¤ºä¾‹
```bash
# è·å–2024å¹´è‡³ä»Šçš„æ•°æ®ï¼Œæ’é™¤åˆ›ä¸šæ¿å’Œç§‘åˆ›æ¿
python fetch_kline.py \
  --start 20240101 \
  --end today \
  --stocklist ./stocklist.csv \
  --exclude-boards gem star \
  --out ./data \
  --workers 6
```

#### é™æµå¤„ç†æœºåˆ¶
```python
# æ£€æµ‹å…³é”®å­—åˆ—è¡¨
BAN_PATTERNS = (
    "è®¿é—®é¢‘ç¹", "è¯·ç¨å", "è¶…è¿‡é¢‘ç‡", "é¢‘ç¹è®¿é—®",
    "too many requests", "429",
    "forbidden", "403",
    "max retries exceeded"
)

# è§¦å‘æ¡ä»¶ï¼šå¼‚å¸¸ä¿¡æ¯åŒ…å«ä»»ä¸€å…³é”®å­—
# å“åº”åŠ¨ä½œï¼š
#   1. è®°å½•è­¦å‘Šæ—¥å¿—
#   2. éšæœºç¡çœ  540-720ç§’ï¼ˆ600Â±20%ï¼‰
#   3. é‡è¯•å½“å‰è‚¡ç¥¨
```

---

### 2. `Selector.py` - ç­–ç•¥æ ¸å¿ƒæ¨¡å—

è¿™æ˜¯æ•´ä¸ªç³»ç»Ÿæœ€å¤æ‚çš„æ¨¡å—ï¼ŒåŒ…å«ï¼š
- **é€šç”¨æŠ€æœ¯æŒ‡æ ‡è®¡ç®—**ï¼ˆ8ä¸ªå‡½æ•°ï¼‰
- **5ä¸ªé€‰è‚¡å™¨ç±»**ï¼ˆæ¯ä¸ªå¯¹åº”ä¸€ç§ç­–ç•¥ï¼‰

#### 2.1 é€šç”¨æŠ€æœ¯æŒ‡æ ‡å‡½æ•°

**â‘  `compute_kdj(df, n=9) -> pd.DataFrame`**
```python
# åŠŸèƒ½ï¼šè®¡ç®—KDJæŒ‡æ ‡ï¼ˆéšæœºæŒ‡æ ‡ï¼‰
# ç®—æ³•ï¼š
#   1. RSV = (æ”¶ç›˜ - Næ—¥æœ€ä½) / (Næ—¥æœ€é«˜ - Næ—¥æœ€ä½) Ã— 100
#   2. K = 2/3 Ã— Kå‰ + 1/3 Ã— RSVï¼ˆåˆå€¼50ï¼‰
#   3. D = 2/3 Ã— Då‰ + 1/3 Ã— Kï¼ˆåˆå€¼50ï¼‰
#   4. J = 3K - 2D
# åº”ç”¨ï¼šJå€¼è¶Šä½ï¼Œè¡¨ç¤ºè¶…å–ï¼Œæ½œåœ¨åå¼¹æœºä¼š
```

**â‘¡ `compute_bbi(df) -> pd.Series`**
```python
# åŠŸèƒ½ï¼šè®¡ç®—BBIå¤šç©ºæŒ‡æ ‡ï¼ˆBull and Bear Indexï¼‰
# å…¬å¼ï¼šBBI = (MA3 + MA6 + MA12 + MA24) / 4
# æ„ä¹‰ï¼šç»¼åˆçŸ­ä¸­é•¿æœŸå‡çº¿ï¼Œåˆ¤æ–­å¤šç©ºè¶‹åŠ¿
```

**â‘¢ `compute_rsv(df, n) -> pd.Series`**
```python
# åŠŸèƒ½ï¼šè®¡ç®—RSVï¼ˆåŸå§‹éšæœºå€¼ï¼‰
# ç‰¹æ®Šå¤„ç†ï¼š
#   - åˆ†å­ï¼šæ”¶ç›˜ - Næ—¥æœ€ä½ä»·çš„æœ€ä½
#   - åˆ†æ¯ï¼šNæ—¥æ”¶ç›˜ä»·çš„æœ€é«˜ - Næ—¥æœ€ä½ä»·çš„æœ€ä½
# åŒºåˆ«äºæ ‡å‡†KDJä¸­çš„RSVè®¡ç®—æ–¹å¼
```

**â‘£ `compute_dif(df, fast=12, slow=26) -> pd.Series`**
```python
# åŠŸèƒ½ï¼šè®¡ç®—MACDçš„DIFçº¿
# å…¬å¼ï¼šDIF = EMA(12) - EMA(26)
# åº”ç”¨ï¼šDIF > 0 è¡¨ç¤ºçŸ­æœŸè¶‹åŠ¿å¼ºäºé•¿æœŸï¼Œçœ‹æ¶¨ä¿¡å·
```

**â‘¤ `bbi_deriv_uptrend(...) -> bool`**
```python
# åŠŸèƒ½ï¼šåˆ¤æ–­BBIæ˜¯å¦æ•´ä½“ä¸Šå‡
# æ ¸å¿ƒé€»è¾‘ï¼š
#   1. é€‰å–æœ€åwæ ¹Kçº¿ï¼ˆmin_window â‰¤ w â‰¤ max_windowï¼‰
#   2. å½’ä¸€åŒ–ï¼šBBI_norm = BBI / BBI[èµ·ç‚¹]
#   3. è®¡ç®—ä¸€é˜¶å·®åˆ†ï¼šÎ” = BBI_norm[t] - BBI_norm[t-1]
#   4. æ£€æŸ¥ï¼šÎ”çš„å‰q_thresholdåˆ†ä½æ•° â‰¥ 0
# å‚æ•°è¯´æ˜ï¼š
#   - q_threshold=0ï¼šè¦æ±‚å…¨ç¨‹å•è°ƒä¸é™
#   - q_threshold=0.2ï¼šå…è®¸20%çš„æ—¶é—´å›æ’¤
```

**â‘¥ `compute_zx_lines(df) -> (ZXDQ, ZXDKX)`**
```python
# åŠŸèƒ½ï¼šè®¡ç®—çŸ¥è¡ŒçŸ­çº¿/é•¿çº¿
# å…¬å¼ï¼š
#   ZXDQï¼ˆçŸ­æœŸçº¿ï¼‰= EMA(EMA(æ”¶ç›˜,10),10)
#   ZXDKXï¼ˆé•¿æœŸçº¿ï¼‰= [MA14 + MA28 + MA57 + MA114] / 4
# åº”ç”¨ï¼šåˆ¤æ–­"çŸ¥è¡Œåˆä¸€"çº¦æŸæ¡ä»¶
```

**â‘¦ `passes_day_constraints_today(df) -> bool`**
```python
# åŠŸèƒ½ï¼šç»Ÿä¸€å½“æ—¥è¿‡æ»¤æ¡ä»¶
# æ¡ä»¶1ï¼šæ¶¨è·Œå¹… < 2%ï¼ˆç»å¯¹å€¼ï¼‰
#   è®¡ç®—ï¼š|æ”¶ç›˜today / æ”¶ç›˜yesterday - 1| < 0.02
# æ¡ä»¶2ï¼šæŒ¯å¹… < 7%
#   è®¡ç®—ï¼š(æœ€é«˜ - æœ€ä½) / æœ€ä½ < 0.07
# æ„ä¹‰ï¼šæ’é™¤å‰§çƒˆæ³¢åŠ¨çš„è‚¡ç¥¨ï¼Œé™ä½é£é™©
```

**â‘§ `zx_condition_at_positions(df, pos) -> bool`**
```python
# åŠŸèƒ½ï¼šæ£€æŸ¥æŒ‡å®šä½ç½®çš„çŸ¥è¡Œçº¦æŸ
# å¯é€‰æ¡ä»¶ï¼š
#   1. require_close_gt_long: æ”¶ç›˜ > é•¿æœŸçº¿
#   2. require_short_gt_long: çŸ­æœŸçº¿ > é•¿æœŸçº¿
# åº”ç”¨åœºæ™¯ï¼š
#   - å°‘å¦‡/è¡¥ç¥¨/å¡«å‘æˆ˜æ³•ï¼šä¸¤è€…éƒ½è¦æ±‚
#   - SuperB1æˆ˜æ³•ï¼šå½“æ—¥ä»…è¦æ±‚çŸ­>é•¿
```

**â‘¨ `last_valid_ma_cross_up(close, ma, lookback_n) -> Optional[int]`**
```python
# åŠŸèƒ½ï¼šæŸ¥æ‰¾æœ€åä¸€æ¬¡æœ‰æ•ˆä¸Šç©¿MAçš„ä½ç½®
# å®šä¹‰"æœ‰æ•ˆä¸Šç©¿"ï¼š
#   - å‰ä¸€æ—¥ï¼šæ”¶ç›˜ < MA
#   - å½“æ—¥ï¼šæ”¶ç›˜ â‰¥ MA
# è¿”å›ï¼šæ•´æ•°ä½ç½®ï¼ˆç”¨äºilocç´¢å¼•ï¼‰ï¼Œæœªæ‰¾åˆ°è¿”å›None
```

#### 2.2 äº”å¤§é€‰è‚¡å™¨ç±»è¯¦è§£

---

### **ç­–ç•¥1ï¼šBBIKDJSelectorï¼ˆå°‘å¦‡æˆ˜æ³•ï¼‰**

**é€‚ç”¨åœºæ™¯**ï¼šå¯»æ‰¾BBIç¨³æ­¥ä¸Šå‡ä¸”KDJä½ä½çš„è‚¡ç¥¨

**æ ¸å¿ƒé€»è¾‘**
```python
1. ä»·æ ¼æ³¢åŠ¨çº¦æŸ
   - æœ€è¿‘max_windowæ ¹Kçº¿çš„æ”¶ç›˜ä»·æ³¢åŠ¨ â‰¤ price_range_pct
   - è®¡ç®—ï¼š(åŒºé—´æœ€é«˜ / åŒºé—´æœ€ä½ - 1) â‰¤ 100%
   
2. BBIä¸Šå‡è¶‹åŠ¿
   - ä½¿ç”¨ bbi_deriv_uptrend() æ£€æµ‹
   - å…è®¸ bbi_q_thresholdï¼ˆ20%ï¼‰çš„å›æ’¤
   
3. KDJä½ä½ï¼ˆåŒé‡åˆ¤å®šï¼‰
   - ç»å¯¹åˆ¤å®šï¼šJ < 15
   - ç›¸å¯¹åˆ¤å®šï¼šJ â‰¤ æœ€è¿‘120æ—¥Jå€¼çš„10%åˆ†ä½
   - æ»¡è¶³ä»»ä¸€å³å¯
   
4. MACDå¤šå¤´
   - DIF > 0ï¼ˆçŸ­æœŸå‡çº¿é«˜äºé•¿æœŸï¼‰
   
5. MA60æ¡ä»¶
   - å½“æ—¥æ”¶ç›˜ â‰¥ MA60
   - æœ€è¿‘120æ—¥å†…å­˜åœ¨æœ‰æ•ˆä¸Šç©¿MA60
   
6. çŸ¥è¡Œçº¦æŸï¼ˆå½“æ—¥ï¼‰
   - æ”¶ç›˜ > é•¿æœŸçº¿
   - çŸ­æœŸçº¿ > é•¿æœŸçº¿
```

**å‚æ•°é…ç½®**
```json
{
  "j_threshold": 15,          // Jå€¼ç»å¯¹é˜ˆå€¼
  "bbi_min_window": 20,       // BBIæ£€æµ‹æœ€å°çª—å£
  "max_window": 120,          // æœ€å¤§å›çœ‹çª—å£
  "price_range_pct": 1,       // ä»·æ ¼æ³¢åŠ¨ä¸Šé™ï¼ˆ100%ï¼‰
  "bbi_q_threshold": 0.2,     // BBIå…è®¸å›æ’¤æ¯”ä¾‹
  "j_q_threshold": 0.10       // Jå€¼ç›¸å¯¹é˜ˆå€¼åˆ†ä½
}
```

**ä»£ç å…³é”®ç‚¹**
```python
def _passes_filters(self, hist: pd.DataFrame) -> bool:
    # Step 1: ç»Ÿä¸€å½“æ—¥è¿‡æ»¤
    if not passes_day_constraints_today(hist):
        return False
    
    # Step 2: ä»·æ ¼æ³¢åŠ¨æ£€æŸ¥
    win = hist.tail(self.max_window)
    high, low = win["close"].max(), win["close"].min()
    if (high / low - 1) > self.price_range_pct:
        return False
    
    # Step 3: BBIä¸Šå‡æ£€æŸ¥
    hist["BBI"] = compute_bbi(hist)
    if not bbi_deriv_uptrend(hist["BBI"], ...):
        return False
    
    # Step 4: KDJåŒé‡æ£€æŸ¥
    kdj = compute_kdj(hist)
    j_today = float(kdj.iloc[-1]["J"])
    j_quantile = j_window.quantile(self.j_q_threshold)
    if not (j_today < self.j_threshold or j_today <= j_quantile):
        return False
    
    # Step 5-7: MACDã€MA60ã€çŸ¥è¡Œçº¦æŸ
    ...
```

---

### **ç­–ç•¥2ï¼šSuperB1Selectorï¼ˆSuperB1æˆ˜æ³•ï¼‰**

**é€‚ç”¨åœºæ™¯**ï¼šåœ¨ç›˜æ•´åæ•æ‰å›è°ƒä¹°ç‚¹

**æ ¸å¿ƒé€»è¾‘**
```python
1. å†å²åŒ¹é…ï¼ˆå¯»æ‰¾t_mï¼‰
   - åœ¨æœ€è¿‘lookback_nï¼ˆ10æ—¥ï¼‰å†…
   - è‡³å°‘å­˜åœ¨ä¸€æ—¥æ»¡è¶³BBIKDJSelector
   - è¯¥æ—¥è®°ä¸ºt_m
   
2. ç›˜æ•´åŒºé—´æ£€æŸ¥
   - ä»t_måˆ°å‰ä¸€æ—¥çš„æ”¶ç›˜ä»·
   - æ³¢åŠ¨ç‡ â‰¤ close_vol_pctï¼ˆ2%ï¼‰
   - è®¡ç®—ï¼š(åŒºé—´æœ€é«˜/åŒºé—´æœ€ä½ - 1) â‰¤ 0.02
   
3. å½“æ—¥ä¸‹è·Œ
   - (å‰ä¸€æ—¥æ”¶ç›˜ - å½“æ—¥æ”¶ç›˜) / å‰ä¸€æ—¥æ”¶ç›˜ â‰¥ 2%
   
4. Jå€¼æä½
   - J < 10 æˆ– J â‰¤ 10%åˆ†ä½
   
5. çŸ¥è¡Œçº¦æŸï¼ˆåˆ†é˜¶æ®µï¼‰
   - t_må½“æ—¥ï¼šæ”¶ç›˜>é•¿æœŸçº¿ ä¸” çŸ­æœŸçº¿>é•¿æœŸçº¿
   - å½“æ—¥ï¼šä»…è¦æ±‚ çŸ­æœŸçº¿>é•¿æœŸçº¿
```

**å‚æ•°é…ç½®**
```json
{
  "lookback_n": 10,           // å›çœ‹çª—å£
  "close_vol_pct": 0.02,      // ç›˜æ•´åŒºé—´æ³¢åŠ¨ä¸Šé™
  "price_drop_pct": 0.02,     // å½“æ—¥ä¸‹è·Œå¹…åº¦
  "j_threshold": 10,
  "j_q_threshold": 0.10,
  "B1_params": {              // åµŒå¥—çš„BBIKDJSelectorå‚æ•°
    "j_threshold": 15,
    "bbi_min_window": 20,
    "max_window": 120,
    "price_range_pct": 1,
    "bbi_q_threshold": 0.3,   // æ³¨æ„ï¼šè¿™é‡Œå…è®¸30%å›æ’¤
    "j_q_threshold": 0.10
  }
}
```

**ä»£ç å…³é”®ç‚¹**
```python
# Step 1: æœç´¢t_m
lb_hist = hist.tail(self.lookback_n + 1)
for idx in lb_hist.index[:-1]:
    # æ£€æŸ¥è¯¥æ—¥æ˜¯å¦æ»¡è¶³BBIKDJSelector
    if self.bbi_selector._passes_filters(hist.loc[:idx]):
        # æ£€æŸ¥åç»­åŒºé—´æ˜¯å¦ç›˜æ•´
        stable_seg = hist.loc[tm_idx : hist.index[-2], "close"]
        if (high/low - 1) <= self.close_vol_pct:
            tm_idx = idx
            break

# Step 2: t_må½“æ—¥çŸ¥è¡Œçº¦æŸæ£€æŸ¥
tm_pos = hist.index.get_loc(tm_idx)
if not zx_condition_at_positions(hist, 
    require_close_gt_long=True,   # t_må½“æ—¥ä¸¤è€…éƒ½è¦æ±‚
    require_short_gt_long=True, 
    pos=tm_pos):
    return False

# Step 3: å½“æ—¥çŸ¥è¡Œçº¦æŸæ£€æŸ¥
if not zx_condition_at_positions(hist,
    require_close_gt_long=False,  # å½“æ—¥ä»…è¦æ±‚çŸ­>é•¿
    require_short_gt_long=True,
    pos=None):
    return False
```

---

### **ç­–ç•¥3ï¼šBBIShortLongSelectorï¼ˆè¡¥ç¥¨æˆ˜æ³•ï¼‰**

**é€‚ç”¨åœºæ™¯**ï¼šæ•æ‰çŸ­æœŸå›è°ƒåçš„åå¼¹

**æ ¸å¿ƒé€»è¾‘**
```python
1. BBIä¸Šå‡
   - åŒå°‘å¦‡æˆ˜æ³•çš„BBIæ£€æµ‹
   
2. é•¿æœŸRSVå¼ºåŠ¿
   - æœ€è¿‘mï¼ˆ5ï¼‰æ—¥å†…
   - RSV_longï¼ˆ21æ—¥ï¼‰å…¨éƒ¨ â‰¥ 75
   
3. çŸ­æœŸRSVåºåˆ—ç»“æ„
   - RSV_shortï¼ˆ5æ—¥ï¼‰å‡ºç°"å…ˆâ‰¥75ï¼Œå<25"çš„æ¨¡å¼
   - å³ï¼šç»å†é«˜ä½å›è½
   
4. å½“æ—¥çŸ­æœŸRSVå›å‡
   - RSV_short â‰¥ 75
   
5. MACDå¤šå¤´
   - DIF > 0
   
6. çŸ¥è¡Œçº¦æŸ
   - æ”¶ç›˜>é•¿æœŸçº¿ ä¸” çŸ­æœŸçº¿>é•¿æœŸçº¿
```

**å‚æ•°é…ç½®**
```json
{
  "n_short": 5,               // çŸ­æœŸRSVå‘¨æœŸ
  "n_long": 21,               // é•¿æœŸRSVå‘¨æœŸ
  "m": 5,                     // å›çœ‹å¤©æ•°
  "bbi_min_window": 2,
  "max_window": 120,
  "bbi_q_threshold": 0.2,
  "upper_rsv_threshold": 75,  // RSVé«˜ä½é˜ˆå€¼
  "lower_rsv_threshold": 25   // RSVä½ä½é˜ˆå€¼
}
```

**ä»£ç å…³é”®ç‚¹**
```python
# Step 1: è®¡ç®—RSV
hist["RSV_short"] = compute_rsv(hist, self.n_short)
hist["RSV_long"] = compute_rsv(hist, self.n_long)

# Step 2: æœ€è¿‘mæ—¥æ£€æŸ¥
win = hist.iloc[-self.m:]

# é•¿æœŸRSVå…¨éƒ¨é«˜ä½
long_ok = (win["RSV_long"] >= 75).all()

# çŸ­æœŸRSVåºåˆ—ç»“æ„æ£€æŸ¥
short_series = win["RSV_short"]
mask_upper = short_series >= 75
mask_lower = short_series < 25

# å¯»æ‰¾"å…ˆä¸Šåä¸‹"æ¨¡å¼
has_upper_then_lower = False
if mask_upper.any():
    upper_indices = np.where(mask_upper.to_numpy())[0]
    for i in upper_indices:
        # æ£€æŸ¥iä¹‹åæ˜¯å¦æœ‰ä½ä½
        if mask_lower.iloc[i+1:].any():
            has_upper_then_lower = True
            break

# å½“æ—¥å›å‡
end_ok = short_series.iloc[-1] >= 75

# ä¸‰è€…éƒ½è¦æ»¡è¶³
return long_ok and has_upper_then_lower and end_ok
```

---

### **ç­–ç•¥4ï¼šPeakKDJSelectorï¼ˆå¡«å‘æˆ˜æ³•ï¼‰**

**é€‚ç”¨åœºæ™¯**ï¼šä»·æ ¼å›åˆ°å‰æœŸå³°å€¼é™„è¿‘çš„ä½å¸æœºä¼š

**æ ¸å¿ƒé€»è¾‘**
```python
1. å³°å€¼æ£€æµ‹
   - ä½¿ç”¨scipy.signal.find_peaksæ£€æµ‹oc_maxå³°å€¼
   - oc_max = max(å¼€ç›˜ä»·, æ”¶ç›˜ä»·)
   - å‚æ•°ï¼šdistance=6, prominence=0.5
   
2. å‚ç…§å³°é€‰æ‹©
   - æœ€æ–°å³°è®°ä¸ºpeak_t
   - å›æº¯å¯»æ‰¾peak_(t-n)ï¼Œè¦æ±‚ï¼š
     a) oc_t > oc_(t-n)ï¼ˆæœ€æ–°å³°æ›´é«˜ï¼‰
     b) åŒºé—´å†…å…¶ä»–å³°ä¸"æŠ¬é«˜é—¨æ§›"
     c) oc_(t-n) > åŒºé—´æœ€ä½æ”¶ç›˜ä»· Ã— (1 + gap_threshold)
   
3. å½“æ—¥ä»·æ ¼æ¥è¿‘å‚ç…§å³°
   - |å½“æ—¥æ”¶ç›˜ - peak_(t-n).close| / peak_(t-n).close â‰¤ 3%
   
4. KDJä½ä½
   - J < 10 æˆ– J â‰¤ 10%åˆ†ä½
   
5. çŸ¥è¡Œçº¦æŸ
   - æ”¶ç›˜>é•¿æœŸçº¿ ä¸” çŸ­æœŸçº¿>é•¿æœŸçº¿
```

**å‚æ•°é…ç½®**
```json
{
  "j_threshold": 10,
  "max_window": 120,
  "fluc_threshold": 0.03,     // ä»·æ ¼æ³¢åŠ¨é˜ˆå€¼ï¼ˆ3%ï¼‰
  "j_q_threshold": 0.10,
  "gap_threshold": 0.2        // å³°å€¼é—¨æ§›ï¼ˆ20%ï¼‰
}
```

**ä»£ç å…³é”®ç‚¹**
```python
# Step 1: è®¡ç®—oc_maxå¹¶æ£€æµ‹å³°å€¼
hist["oc_max"] = hist[["open", "close"]].max(axis=1)
peaks_df = _find_peaks(hist, column="oc_max", 
                       distance=6, prominence=0.5)

# Step 2: å¯»æ‰¾å‚ç…§å³°
peak_t = peaks_df.iloc[-1]  # æœ€æ–°å³°
oc_t = peak_t.oc_max

for idx in range(len(peaks_df)-2, -1, -1):
    peak_prev = peaks_df.iloc[idx]
    oc_prev = peak_prev.oc_max
    
    # æ¡ä»¶1ï¼šæœ€æ–°å³°æ›´é«˜
    if oc_t <= oc_prev:
        continue
    
    # æ¡ä»¶2ï¼šä¸­é—´å³°ä¸æŠ¬é«˜é—¨æ§›
    if len(peaks_df) >= 3:
        inter_oc = peaks_df.loc[idx+1:len(peaks_df)-2, "oc_max"]
        if not (inter_oc < oc_prev).all():
            continue
    
    # æ¡ä»¶3ï¼šå³°å€¼é«˜äºåŒºé—´æœ€ä½20%
    mask = (hist["date"] > peak_prev.date) & (hist["date"] < peak_t.date)
    min_close = hist.loc[mask, "close"].min()
    if oc_prev <= min_close * (1 + self.gap_threshold):
        continue
    
    # æ‰¾åˆ°åˆé€‚çš„å‚ç…§å³°
    target_peak = peak_prev
    break

# Step 3: ä»·æ ¼æ¥è¿‘åº¦æ£€æŸ¥
close_today = hist.iloc[-1]["close"]
fluc_pct = abs(close_today - target_peak.close) / target_peak.close
if fluc_pct > self.fluc_threshold:
    return False
```

**å³°å€¼æ£€æµ‹å¯è§†åŒ–ç†è§£**
```
ä»·æ ¼
 ^
 |     peak_(t-n)        peak_t
 |        /\              /\
 |       /  \            /  \
 |      /    \__________/    \
 |     /      åŒºé—´æœ€ä½         \
 |____/________________________\___> æ—¶é—´
      ^                        ^
   å‚ç…§å³°                    æœ€æ–°å³°
   
è¦æ±‚ï¼š
1. peak_t.oc_max > peak_(t-n).oc_max
2. åŒºé—´å†…å…¶ä»–å³° < peak_(t-n)
3. peak_(t-n) > åŒºé—´æœ€ä½ Ã— 1.2
4. å½“æ—¥æ”¶ç›˜æ¥è¿‘ peak_(t-n).closeï¼ˆÂ±3%ï¼‰
```

---

### **ç­–ç•¥5ï¼šMA60CrossVolumeWaveSelectorï¼ˆä¸Šç©¿60æ”¾é‡æˆ˜æ³•ï¼‰**

**é€‚ç”¨åœºæ™¯**ï¼šçªç ´60æ—¥å‡çº¿ä¸”æ”¾é‡çš„å¼ºåŠ¿è‚¡

---

### **ç­–ç•¥6ï¼šBreakoutPreviousHighSelectorï¼ˆå‡ºå‘æˆ˜æ³•/çªç ´å‰é«˜æˆ˜æ³•ï¼‰**

**é€‚ç”¨åœºæ™¯**ï¼šå‰é«˜çªç ´+æ”¾é‡ç¡®è®¤ï¼Œæ•æ‰è°ƒæ•´åçš„äºŒæ¬¡å¯åŠ¨æœºä¼š

**æ ¸å¿ƒé€»è¾‘**
```python
1. KDJä½ä½
   - J < 15 æˆ– J â‰¤ 10%åˆ†ä½
   
2. æœ‰æ•ˆä¸Šç©¿MA60
   - æœ€è¿‘lookback_nï¼ˆ25æ—¥ï¼‰å†…å­˜åœ¨ä¸Šç©¿
   - ä¸Šç©¿å®šä¹‰ï¼šå‰ä¸€æ—¥<MA60ï¼Œå½“æ—¥â‰¥MA60
   
3. ä¸Šæ¶¨æ³¢æ®µæ”¾é‡
   - ç¡®å®šä¸Šç©¿æ—¥T
   - åœ¨[T, ä»Šå¤©]åŒºé—´å†…æ‰¾Highæœ€å¤§æ—¥Tmax
   - ä¸Šæ¶¨æ³¢æ®µ=[T, Tmax]
   - è¦æ±‚ï¼šæ³¢æ®µæ—¥å‡é‡ â‰¥ å‰ç½®çª—å£æ—¥å‡é‡ Ã— 1.8
   
4. MA60æ–œç‡ä¸ºæ­£
   - æœ€è¿‘5æ—¥MA60åšçº¿æ€§å›å½’
   - æ–œç‡k > 0
   
5. çŸ¥è¡Œçº¦æŸ
   - æ”¶ç›˜>é•¿æœŸçº¿ ä¸” çŸ­æœŸçº¿>é•¿æœŸçº¿
```

**å‚æ•°é…ç½®**
```json
{
  "lookback_n": 25,           // å›çœ‹çª—å£
  "vol_multiple": 1.8,        // é‡èƒ½å€æ•°
  "j_threshold": 15,
  "j_q_threshold": 0.10,
  "ma60_slope_days": 5,       // æ–œç‡è®¡ç®—å¤©æ•°
  "max_window": 120
}
```

**ä»£ç å…³é”®ç‚¹**
```python
# Step 1: æŸ¥æ‰¾ä¸Šç©¿ç‚¹T
hist["MA60"] = hist["close"].rolling(60).mean()
t_pos = last_valid_ma_cross_up(hist["close"], hist["MA60"], 
                                lookback_n=self.lookback_n)

# Step 2: ç¡®å®šä¸Šæ¶¨æ³¢æ®µ[T, Tmax]
seg_T_to_today = hist.iloc[t_pos:]
tmax_label = seg_T_to_today["high"].idxmax()  # Highæœ€å¤§æ—¥
int_pos_Tmax = hist.index.get_loc(tmax_label)

wave = hist.iloc[t_pos : int_pos_Tmax + 1]
wave_len = len(wave)

# Step 3: é‡èƒ½å¯¹æ¯”
# å‰ç½®çª—å£ï¼š[T-wave_len, T-1]ï¼ˆæœ€å¤šæˆªæ–­ä¸º10æ—¥ï¼‰
pre_start_pos = max(0, t_pos - min(wave_len, 10))
pre = hist.iloc[pre_start_pos : t_pos]

wave_avg_vol = wave["volume"].mean()
pre_avg_vol = pre["volume"].mean()

if wave_avg_vol < self.vol_multiple * pre_avg_vol:
    return False

# Step 4: MA60æ–œç‡æ£€æŸ¥
def _ma_slope_positive(series, days):
    seg = series.tail(days)
    x = np.arange(len(seg))
    k, _ = np.polyfit(x, seg.values, 1)  # ä¸€é˜¶æ‹Ÿåˆ
    return k > 0

if not self._ma_slope_positive(hist["MA60"], 5):
    return False
```

**é‡èƒ½å¯¹æ¯”å›¾ç¤º**
```
æˆäº¤é‡
 ^
 |    T(ä¸Šç©¿æ—¥)     Tmax
 |       |          |
 |    â”Œâ”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â” ä¸Šæ¶¨æ³¢æ®µ
 |    â”‚  â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“  â”‚ å¹³å‡é‡A
 |    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
 | â”Œâ”€â”€â”´â”€â”€â”
 | â”‚ â–’â–’â–’ â”‚ å‰ç½®çª—å£å¹³å‡é‡B
 | â””â”€â”€â”€â”€â”€â”˜
 |___|__________________> æ—¶é—´
 
è¦æ±‚ï¼šA â‰¥ 1.8 Ã— B
```

---

### **ç­–ç•¥6ï¼šBreakoutPreviousHighSelectorï¼ˆå‡ºå‘æˆ˜æ³•ï¼‰**

**é€‚ç”¨åœºæ™¯**ï¼šå‰é«˜çªç ´+æ”¾é‡ç¡®è®¤ï¼Œæ•æ‰è°ƒæ•´åçš„äºŒæ¬¡å¯åŠ¨æœºä¼š

**æ ¸å¿ƒé€»è¾‘**
```python
1. å½¢æ€è¯†åˆ«ï¼ˆå®Œæ•´èµ°åŠ¿ç»“æ„ï¼‰
   - ç¬¬ä¸€æ³¢æ‹‰å‡ï¼šè‚¡ä»·ä»åº•éƒ¨å¿«é€Ÿæ‹‰å‡ï¼Œåˆ›å‡ºé˜¶æ®µæ–°é«˜
   - é«˜ä½å›è°ƒï¼šå†²é«˜åå¼€å§‹å›è½è°ƒæ•´ï¼ˆå›è°ƒ5%-25%ï¼‰
   - å¹³å°éœ‡è¡ï¼šè‚¡ä»·åœ¨MA5/MA10å’ŒMA20/MA30ä¹‹é—´æ¨ªç›˜æ•´ç†
   - ç¼©é‡æ´—ç›˜ï¼šéœ‡è¡æœŸé—´æˆäº¤é‡é€æ­¥èç¼©ï¼ˆâ‰¤å‰æœŸæ‹‰å‡çš„60%ï¼‰
   
2. ä¹°å…¥æ—¶æœº
   - æ”¾é‡çªç ´ï¼šå½“æ—¥æˆäº¤é‡ â‰¥ éœ‡è¡æœŸå¹³å‡é‡ Ã— 2å€
   - æ¥è¿‘å‰é«˜ï¼šå½“æ—¥ä»·æ ¼è·ç¦»å‰é«˜ â‰¤ 15%
   - å‡çº¿é…åˆï¼šçŸ­æœŸå‡çº¿å‘ä¸Šï¼Œé•¿æœŸå‡çº¿æ”¯æ’‘
   
3. çœŸçªç ´åˆ¤æ–­
   - æˆäº¤é‡æ”¾å¤§å€æ•°ç¬¦åˆè¦æ±‚ï¼ˆé‡æ¯”â‰¥2ï¼‰
   - æ¢æ‰‹ç‡å……åˆ†ï¼ˆæ¢æ‰‹ç‡ä»£ç†æŒ‡æ ‡åˆæ ¼ï¼‰
   - å‡çº¿ç³»ç»Ÿæ”¶æ•›æˆ–å¤šå¤´æ’åˆ—
   - éœ‡è¡æœŸé—´æ˜æ˜¾ç¼©é‡ï¼ˆç›¸å¯¹æ‹‰å‡æœŸï¼‰
   
4. çŸ¥è¡Œçº¦æŸ
   - æ”¶ç›˜ > é•¿æœŸçº¿
   - çŸ­æœŸçº¿ > é•¿æœŸçº¿
```

**å‚æ•°é…ç½®**
```json
{
  "lookback_days": 60,              // å›çœ‹çª—å£ï¼ˆå¯»æ‰¾å‰é«˜ï¼‰
  "consolidation_min_days": 5,     // éœ‡è¡æ•´ç†æœ€å°å¤©æ•°
  "consolidation_max_days": 30,    // éœ‡è¡æ•´ç†æœ€å¤§å¤©æ•°
  "approach_pct": 0.15,            // æ¥è¿‘å‰é«˜çš„è·ç¦»ï¼ˆ15%ä»¥å†…ï¼‰
  "vol_ratio_threshold": 2.0,      // çªç ´æ—¥é‡æ¯”é˜ˆå€¼ï¼ˆ2å€ï¼‰
  "turnover_threshold": 0.05,      // çªç ´æ—¥æ¢æ‰‹ç‡é˜ˆå€¼ï¼ˆ5%ï¼‰
  "consolidation_shrink_ratio": 0.6,  // éœ‡è¡æœŸç¼©é‡æ¯”ä¾‹ï¼ˆâ‰¤60%ï¼‰
  "pullback_pct_min": 0.05,        // å›è°ƒå¹…åº¦ä¸‹é™ï¼ˆ5%ï¼‰
  "pullback_pct_max": 0.25,        // å›è°ƒå¹…åº¦ä¸Šé™ï¼ˆ25%ï¼‰
  "ma_converge_threshold": 0.05,   // å‡çº¿æ”¶æ•›é˜ˆå€¼ï¼ˆ5%ï¼‰
  "max_window": 120
}
```

**ä»£ç å…³é”®ç‚¹**
```python
# Step 1: å¯»æ‰¾å‰é«˜
def _find_previous_high(hist):
    # åœ¨lookback_daysçª—å£å†…å¯»æ‰¾æœ€é«˜ç‚¹
    # ä½¿ç”¨scipy.find_peaksæ£€æµ‹æ˜¾è‘—å³°å€¼
    peaks_df = _find_peaks(window, column="high", 
                          distance=5, prominence=0.5)
    # é€‰æ‹©æœ€é«˜çš„å³°å€¼ä½œä¸ºå‰é«˜
    ...

# Step 2: æ£€æŸ¥éœ‡è¡æ•´ç†é˜¶æ®µ
def _check_consolidation_phase(hist, high_idx):
    # ä»å‰é«˜ä¹‹ååˆ°å½“æ—¥å‰ä¸€æ—¥
    consol_seg = hist.iloc[high_idx + 1 : -1]
    
    # æ£€æŸ¥è‚¡ä»·æ˜¯å¦åœ¨å‡çº¿ä¹‹é—´éœ‡è¡
    # è‡³å°‘60%çš„æ—¶é—´åœ¨é•¿æœŸå‡çº¿ä¸Šæ–¹
    between_ma_ratio = (close >= long_ma * 0.98).sum() / len(consol_seg)
    ...

# Step 3: å›è°ƒå¹…åº¦æ£€æŸ¥
after_high = hist.iloc[high_idx + 1 : -1]
pullback_low = after_high['close'].min()
pullback_pct = (high_price - pullback_low) / high_price

if not (0.05 <= pullback_pct <= 0.25):
    return False

# Step 4: å½“æ—¥æ¥è¿‘å‰é«˜æ£€æŸ¥
close_today = hist.iloc[-1]['close']
distance_to_high = abs(close_today - high_price) / high_price

if close_today < high_price:
    # åœ¨ä¸‹æ–¹æ¥è¿‘ï¼ˆâ‰¤15%ï¼‰
    if distance_to_high > 0.15:
        return False
else:
    # å·²çªç ´ï¼Œä½†ä¸èƒ½ç¦»å¤ªè¿œï¼ˆâ‰¤5%ï¼‰
    if distance_to_high > 0.05:
        return False

# Step 5: æ”¾é‡æ£€æŸ¥
vol_today = hist.iloc[-1]['volume']
vol_ratio = vol_today / consol_avg_vol  # ç›¸å¯¹éœ‡è¡æœŸ

if vol_ratio < 2.0:
    return False

# Step 6: éœ‡è¡æœŸç¼©é‡æ£€æŸ¥
rally_avg_vol = hist.iloc[high_idx-5:high_idx+1]['volume'].mean()
shrink_ratio = consol_avg_vol / rally_avg_vol

if shrink_ratio > 0.6:  # éœ‡è¡æœŸæ²¡æœ‰æ˜æ˜¾ç¼©é‡
    return False

# Step 7: å‡çº¿ç³»ç»Ÿæ£€æŸ¥
# çŸ­æœŸå‡çº¿å‘ä¸Šï¼ˆMA5æˆ–MA10æ‹å¤´å‘ä¸Šï¼‰
ma5_slope = ma5_today - hist.iloc[-3]['MA5']
ma10_slope = ma10_today - hist.iloc[-3]['MA10']

if not (ma5_slope > 0 or ma10_slope > 0):
    return False

# é•¿æœŸå‡çº¿æ”¯æ’‘ï¼ˆä»·æ ¼åœ¨MA20/MA30ä¸Šæ–¹ï¼‰
if not (close_today >= ma20_today * 0.98 or 
        close_today >= ma30_today * 0.98):
    return False

# å‡çº¿æ”¶æ•›æˆ–å¤šå¤´æ’åˆ—
ma_spread = abs(short_ma_avg - long_ma_avg) / long_ma_avg
if not (ma_spread < 0.05 or short_ma_avg >= long_ma_avg):
    return False
```

**å½¢æ€è¯†åˆ«å¯è§†åŒ–**
```
ä»·æ ¼
 ^
 |              å‰é«˜â—
 |             /  \
 |            /    \å›è°ƒ5-25%
 |           /      \___éœ‡è¡æ•´ç†___
 |          /         â–¬â–¬â–¬â–¬â–¬â–¬â–¬      \
 |         /    MA5/MA10å‹åŠ› â–¬      â†—æ”¾é‡çªç ´
 |        /     MA20/MA30æ”¯æ’‘  â–¬    â—å½“æ—¥
 |       /                        â–¬/
 |______/___________________________\___> æ—¶é—´
       æ‹‰å‡æœŸ   å‰é«˜  éœ‡è¡æœŸ(5-30å¤©)  çªç ´æ—¥
       
æˆäº¤é‡
 ^
 |     â–“â–“â–“        æ‹‰å‡æ”¾é‡
 |     â–“â–“â–“
 |     â–“â–“â–“  â–‘â–‘â–‘   éœ‡è¡ç¼©é‡(â‰¤60%)
 |     â–“â–“â–“  â–‘â–‘â–‘                â–“â–“â–“  çªç ´æ”¾é‡(â‰¥2å€)
 |_____|____|___________________|____> æ—¶é—´

è¦ç‚¹ï¼š
1. å‰é«˜æ˜ç¡®ï¼ˆæœ€è¿‘60æ—¥å†…çš„å³°å€¼ï¼‰
2. å›è°ƒé€‚åº¦ï¼ˆ5%-25%ï¼‰
3. éœ‡è¡ç¼©é‡ï¼ˆæˆäº¤é‡èç¼©è‡³æ‹‰å‡æœŸçš„60%ä»¥å†…ï¼‰
4. çªç ´æ”¾é‡ï¼ˆé‡æ¯”â‰¥2ï¼‰
5. å‡çº¿æ”¶æ•›æˆ–å¤šå¤´æ’åˆ—
```

**æ“ä½œè¦ç‚¹**
```
ä¹°å…¥æ—¶æœºï¼š
âœ“ 9:35-10:00: å¼€ç›˜åæ”¾é‡çªç ´ï¼Œç¡®è®¤å¼ºåŠ¿
âœ“ 10:00-10:30: å›è¸©çŸ­æœŸå‡çº¿ä¸ç ´ï¼ŒäºŒæ¬¡ä¸Šæ”»
âœ“ 13:30-14:00: åˆåç»§ç»­æ”¾é‡ä¸Šæ”»ï¼Œç¡®è®¤çªç ´æœ‰æ•ˆ

æ­¢æŸä½ï¼š
âœ— è·Œç ´çŸ­æœŸå‡çº¿(MA5/MA10)æ­¢æŸï¼ŒäºæŸ-3%è‡³-5%
âœ— æ”¾é‡ä¸‹è·Œï¼Œè·Œç ´é•¿æœŸå‡çº¿æœæ–­æ¸…ä»“

æ­¢ç›ˆä½ï¼š
âœ“ ç¬¬ä¸€ç›®æ ‡ï¼šå‰é«˜+5%ï¼Œå–å‡º30%
âœ“ ç¬¬äºŒç›®æ ‡ï¼šå‰é«˜+10%ï¼Œå–å‡º40%
âœ“ ç¬¬ä¸‰ç›®æ ‡ï¼šå‰é«˜+15%ä»¥ä¸Šï¼Œå–å‡ºå‰©ä½™30%

çœŸçªç ´ vs å‡çªç ´ï¼š
çœŸçªç ´ï¼š
  âœ“ æ”¾é‡æ˜æ˜¾ï¼ˆé‡æ¯”â‰¥2ï¼Œæ¢æ‰‹ç‡â‰¥5%ï¼‰
  âœ“ çªç ´æœæ–­ï¼Œä¸æ‹–æ³¥å¸¦æ°´
  âœ“ çªç ´åä¸å›å¤´ï¼Œæˆ–å›è¸©ä¸ç ´
  âœ“ æ¬¡æ—¥ç»§ç»­æ”¾é‡ä¸Šæ”»

å‡çªç ´ï¼š
  âœ— æ”¾é‡ä¸æ˜æ˜¾ï¼Œé‡èƒ½ä¸è¶³
  âœ— å†²é«˜å›è½ï¼Œä¸Šå½±çº¿è¾ƒé•¿
  âœ— çªç ´åå¿«é€Ÿå›è½ï¼Œè·Œç ´çªç ´ä½
  âœ— æ¬¡æ—¥ç¼©é‡ä¸‹è·Œæˆ–æ¨ªç›˜
```

**ä¸‰çœ‹ä¸‰ä¸åšåŸåˆ™**
```
ä¸‰çœ‹ï¼š
1. çœ‹é‡èƒ½ï¼šæ”¾é‡æ˜¯çªç ´çš„å¿…è¦æ¡ä»¶
2. çœ‹ä½ç½®ï¼šå¿…é¡»æ¥è¿‘å‰é«˜ï¼Œä¸èƒ½è·ç¦»å¤ªè¿œ
3. çœ‹è¶‹åŠ¿ï¼šå‡çº¿ç³»ç»Ÿå¿…é¡»å‘ä¸Šï¼Œä¸åšç©ºå¤´æ’åˆ—

ä¸‰ä¸åšï¼š
1. ä¸åšç¼©é‡çªç ´ï¼šé‡èƒ½ä¸è¶³çš„çªç ´ä¸å‚ä¸
2. ä¸åšè¿œç¦»å‰é«˜ï¼šè·ç¦»å‰é«˜è¶…è¿‡20%çš„ä¸åš
3. ä¸åšç ´ä½è‚¡ç¥¨ï¼šè·Œç ´é•¿æœŸå‡çº¿çš„ä¸åš
```

---

### 3. `select_stock.py` - é€‰è‚¡æ‰§è¡Œå…¥å£

#### æ ¸å¿ƒåŠŸèƒ½
- åŠ è½½é…ç½®æ–‡ä»¶ï¼ˆ`configs.json`ï¼‰
- æ‰¹é‡è¯»å–è¡Œæƒ…æ•°æ®ï¼ˆ`data/`ç›®å½•ï¼‰
- åŠ¨æ€å®ä¾‹åŒ–é€‰æ‹©å™¨ç±»
- æ‰§è¡Œé€‰è‚¡å¹¶è¾“å‡ºç»“æœ

#### å…³é”®å‡½æ•°

**1. `load_data(data_dir, codes) -> Dict[str, pd.DataFrame]`**
```python
# åŠŸèƒ½ï¼šæ‰¹é‡åŠ è½½è‚¡ç¥¨CSV
# è¿”å›ï¼š{è‚¡ç¥¨ä»£ç : DataFrame}
# å¤„ç†ï¼š
#   - è‡ªåŠ¨è·³è¿‡ä¸å­˜åœ¨çš„æ–‡ä»¶
#   - è§£ædateåˆ—ä¸ºdatetime
#   - æŒ‰æ—¥æœŸå‡åºæ’åˆ—
```

**2. `load_config(cfg_path) -> List[Dict]`**
```python
# åŠŸèƒ½ï¼šè¯»å–å¹¶è§£æconfigs.json
# å…¼å®¹ä¸‰ç§æ ¼å¼ï¼š
#   1. å•ä¸ªå¯¹è±¡ï¼š{"class": "BBIKDJSelector", ...}
#   2. å¯¹è±¡æ•°ç»„ï¼š[{...}, {...}]
#   3. åµŒå¥—ç»“æ„ï¼š{"selectors": [{...}]}
```

**3. `instantiate_selector(cfg) -> (alias, selector)`**
```python
# åŠŸèƒ½ï¼šåŠ¨æ€å®ä¾‹åŒ–é€‰æ‹©å™¨
# æµç¨‹ï¼š
#   1. ä»é…ç½®è¯»å–classåç§°
#   2. ä½¿ç”¨importlibåŠ è½½Selectoræ¨¡å—
#   3. é€šè¿‡getattrè·å–ç±»
#   4. è§£åŒ…paramså­—å…¸å®ä¾‹åŒ–
# ç¤ºä¾‹ï¼š
cfg = {
    "class": "BBIKDJSelector",
    "alias": "å°‘å¦‡æˆ˜æ³•",
    "params": {"j_threshold": 15, ...}
}
alias, selector = instantiate_selector(cfg)
# alias = "å°‘å¦‡æˆ˜æ³•"
# selector = BBIKDJSelector(j_threshold=15, ...)
```

#### æ‰§è¡Œæµç¨‹
```python
def main():
    # 1. è§£æå‘½ä»¤è¡Œå‚æ•°
    args = parse_args()
    
    # 2. åŠ è½½è‚¡ç¥¨æ± 
    codes = [f.stem for f in Path(args.data_dir).glob("*.csv")]
    
    # 3. åŠ è½½è¡Œæƒ…æ•°æ®
    data = load_data(Path(args.data_dir), codes)
    
    # 4. ç¡®å®šäº¤æ˜“æ—¥
    trade_date = pd.to_datetime(args.date) if args.date else \
                 max(df["date"].max() for df in data.values())
    
    # 5. éå†æ‰§è¡Œé€‰æ‹©å™¨
    for cfg in load_config(Path(args.config)):
        if not cfg.get("activate", True):
            continue  # è·³è¿‡æœªæ¿€æ´»çš„ç­–ç•¥
        
        alias, selector = instantiate_selector(cfg)
        picks = selector.select(trade_date, data)
        
        # 6. è¾“å‡ºç»“æœ
        logger.info(f"[{alias}] ç¬¦åˆæ¡ä»¶: {len(picks)}åª")
        logger.info(", ".join(picks))
```

---

### 4. `SectorShift.py` - è¡Œä¸šåˆ†ææ¨¡å—

#### æ ¸å¿ƒåŠŸèƒ½
è®¡ç®—Jå€¼ä½äºé˜ˆå€¼çš„è‚¡ç¥¨åœ¨å„è¡Œä¸šçš„åˆ†å¸ƒæƒ…å†µã€‚

#### å…³é”®å‡½æ•°

**`compute_j_industry_distribution(...) -> Dict`**
```python
# å‚æ•°ï¼š
#   data_dir: è¡Œæƒ…æ•°æ®ç›®å½•
#   stocklist_path: è‚¡ç¥¨æ¸…å•è·¯å¾„
#   j_threshold: Jå€¼é˜ˆå€¼ï¼ˆé»˜è®¤15ï¼‰
#   trade_date: æŒ‡å®šäº¤æ˜“æ—¥ï¼ˆå¯é€‰ï¼‰
#   export_excel_path: å¯¼å‡ºExcelè·¯å¾„ï¼ˆå¯é€‰ï¼‰

# æµç¨‹ï¼š
1. æ‰«ædata_dirè·å–è‚¡ç¥¨ä»£ç åˆ—è¡¨
2. åŠ è½½è¡Œæƒ…å¹¶è®¡ç®—æ¯åªè‚¡ç¥¨çš„Jå€¼
3. ä»stocklist.csvè¯»å–è¡Œä¸šä¿¡æ¯
4. ç­›é€‰J<é˜ˆå€¼çš„è‚¡ç¥¨
5. æŒ‰è¡Œä¸šç»Ÿè®¡æ•°é‡
6. å¯é€‰å¯¼å‡ºExcel

# è¿”å›æ ¼å¼ï¼š
{
  "meta": {
    "total_codes": 5431,
    "selected_count": 234,
    "j_threshold": 15.0,
    "trade_date": "2025-09-10"
  },
  "industry_counts": [
    {"è¡Œä¸š": "é“¶è¡Œ", "è‚¡ç¥¨æ•°": 12},
    {"è¡Œä¸š": "æˆ¿åœ°äº§", "è‚¡ç¥¨æ•°": 8},
    ...
  ]
}
```

#### ä½¿ç”¨ç¤ºä¾‹
```bash
# æŸ¥çœ‹2025-09-10æ—¥J<15çš„è¡Œä¸šåˆ†å¸ƒ
python SectorShift.py \
  --data_dir ./data \
  --stocklist stocklist.csv \
  --j_threshold 15 \
  --trade_date 20250910
```

---

### 5. `find_stock_by_price_concurrent.py` - ä»·æ ¼æŸ¥è¯¢å·¥å…·

#### æ ¸å¿ƒåŠŸèƒ½
é«˜æ€§èƒ½å¹¶å‘æŸ¥æ‰¾å†å²ä¸Šè¾¾åˆ°æŒ‡å®šä»·æ ¼çš„è‚¡ç¥¨ã€‚

#### å…³é”®è®¾è®¡
```python
# å¹¶å‘ç­–ç•¥ï¼š
- æ•°æ®åŠ è½½ï¼šProcessPoolExecutorï¼ˆè¿›ç¨‹æ± ï¼‰
- ä»·æ ¼æŸ¥è¯¢ï¼šProcessPoolExecutorï¼ˆè¿›ç¨‹æ± ï¼‰
- é»˜è®¤å¹¶å‘æ•°ï¼šCPUæ ¸å¿ƒæ•°

# æ”¯æŒåŠŸèƒ½ï¼š
- æŒ‰æ”¶ç›˜ä»·/æœ€é«˜ä»·/æœ€ä½ä»·æŸ¥è¯¢
- æŒ‡å®šæ—¥æœŸåŒºé—´
- ä»·æ ¼å®¹å·®è®¾ç½®
- æ€§èƒ½åŸºå‡†æµ‹è¯•
```

#### ä½¿ç”¨ç¤ºä¾‹
```bash
# æŸ¥æ‰¾æ”¶ç›˜ä»·åœ¨9.99-10.01ä¹‹é—´çš„è‚¡ç¥¨ï¼ˆ2024å¹´ï¼‰
python find_stock_by_price_concurrent.py 10.0 \
  --data-dir ./data \
  --price-type close \
  --start-date 2024-01-01 \
  --end-date 2024-12-31 \
  --tolerance 0.01 \
  --benchmark
```

---

## ğŸ“Š æ•°æ®æµç¨‹

### å®Œæ•´æ•°æ®ç”Ÿå‘½å‘¨æœŸ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Phase 1: æ•°æ®å‡†å¤‡                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  1. å‡†å¤‡stocklist.csvï¼ˆè‚¡ç¥¨æ± ï¼‰
     - æ ¼å¼ï¼šts_code, symbol, name, area, industry
     - æ¥æºï¼šTushareã€ä¸œæ–¹è´¢å¯Œç­‰
     
  2. é…ç½®Tushare Token
     export TUSHARE_TOKEN="your_token_here"

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Phase 2: æ•°æ®è·å–                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  python fetch_kline.py --start 20240101 --end today
  
  â†’ å¹¶å‘æŠ“å–ï¼ˆ6çº¿ç¨‹ï¼‰
  â†’ é™æµæ£€æµ‹ä¸é‡è¯•
  â†’ å…¨é‡è¦†ç›–ä¿å­˜
  
  è¾“å‡ºï¼šdata/000001.csv, data/000002.csv, ...

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Phase 3: æ•°æ®å­˜å‚¨æ ¼å¼                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  CSVæ ¼å¼ï¼ˆdata/XXXXXX.csvï¼‰ï¼š
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ date       â”‚ open  â”‚ close â”‚ high  â”‚ low   â”‚ volume â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚ 2024-01-02 â”‚ 10.50 â”‚ 10.80 â”‚ 10.90 â”‚ 10.40 â”‚ 123456 â”‚
  â”‚ 2024-01-03 â”‚ 10.75 â”‚ 10.60 â”‚ 10.85 â”‚ 10.55 â”‚ 98765  â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Phase 4: é€‰è‚¡æ‰§è¡Œ                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  python select_stock.py --date 2025-09-10
  
  â†’ è¯»å–configs.json
  â†’ åŠ è½½data/*.csv
  â†’ é€ä¸ªæ‰§è¡Œé€‰æ‹©å™¨
  â†’ è¾“å‡ºåˆ°æ§åˆ¶å° + select_results.log

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Phase 5: ç»“æœåˆ†æ                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  - æŸ¥çœ‹é€‰è‚¡ç»“æœæ—¥å¿—
  - åˆ†æè¡Œä¸šåˆ†å¸ƒï¼ˆSectorShift.pyï¼‰
  - æŒ‰ä»·æ ¼ç­›é€‰ï¼ˆfind_stock_by_price_concurrent.pyï¼‰
```

---

## ğŸ§® æŠ€æœ¯æŒ‡æ ‡è¯´æ˜

### 1. KDJæŒ‡æ ‡ï¼ˆéšæœºæŒ‡æ ‡ï¼‰

**è®¡ç®—å…¬å¼**
```
RSV(N) = (C - LN) / (HN - LN) Ã— 100
K(t) = 2/3 Ã— K(t-1) + 1/3 Ã— RSV(t)
D(t) = 2/3 Ã— D(t-1) + 1/3 Ã— K(t)
J(t) = 3 Ã— K(t) - 2 Ã— D(t)

å…¶ä¸­ï¼š
C = æ”¶ç›˜ä»·
LN = Næ—¥å†…æœ€ä½ä»·
HN = Næ—¥å†…æœ€é«˜ä»·
K(0) = D(0) = 50
```

**å«ä¹‰è§£é‡Š**
- **RSV**ï¼šåŸå§‹éšæœºå€¼ï¼Œè¡¡é‡å½“å‰ä»·æ ¼åœ¨Næ—¥å†…çš„ç›¸å¯¹ä½ç½®
- **Kå€¼**ï¼šå¿«é€ŸéšæœºæŒ‡æ ‡ï¼Œå¯¹RSVè¿›è¡Œå¹³æ»‘
- **Då€¼**ï¼šæ…¢é€ŸéšæœºæŒ‡æ ‡ï¼Œå¯¹Kå€¼è¿›è¡ŒäºŒæ¬¡å¹³æ»‘
- **Jå€¼**ï¼šè¶…å¿«é€ŸæŒ‡æ ‡ï¼ŒJ = 3K - 2Dï¼Œæ”¾å¤§Kå’ŒDçš„å·®è·

**åº”ç”¨è§„åˆ™**
```
J < 0ï¼šä¸¥é‡è¶…å–ï¼Œå¼ºåå¼¹ä¿¡å·
0 < J < 10ï¼šè¶…å–åŒºåŸŸï¼Œå…³æ³¨ä¹°å…¥
10 < J < 20ï¼šä½ä½åŒºåŸŸï¼Œå¯èƒ½å½¢æˆåº•éƒ¨
20 < J < 80ï¼šæ­£å¸¸æ³¢åŠ¨åŒºé—´
J > 80ï¼šè¶…ä¹°åŒºåŸŸï¼Œæ³¨æ„é£é™©
J > 100ï¼šä¸¥é‡è¶…ä¹°ï¼Œå¯èƒ½å›è°ƒ
```

### 2. BBIæŒ‡æ ‡ï¼ˆå¤šç©ºæŒ‡æ•°ï¼‰

**è®¡ç®—å…¬å¼**
```
BBI = (MA3 + MA6 + MA12 + MA24) / 4
```

**å«ä¹‰è§£é‡Š**
- ç»¼åˆçŸ­æœŸï¼ˆ3æ—¥ï¼‰ã€çŸ­ä¸­æœŸï¼ˆ6æ—¥ï¼‰ã€ä¸­æœŸï¼ˆ12æ—¥ï¼‰ã€ä¸­é•¿æœŸï¼ˆ24æ—¥ï¼‰å‡çº¿
- æ˜¯å¤šæ¡å‡çº¿çš„å¹³å‡å€¼ï¼Œä»£è¡¨å¤šç©ºåŠ›é‡çš„å¹³è¡¡ç‚¹

**åº”ç”¨è§„åˆ™**
```
ä»·æ ¼ > BBIï¼šå¤šå¤´å¸‚åœºï¼Œå¯æŒæœ‰
ä»·æ ¼ < BBIï¼šç©ºå¤´å¸‚åœºï¼Œè§‚æœ›
BBIä¸Šå‡ï¼šå¤šå¤´åŠ›é‡å¢å¼º
BBIä¸‹é™ï¼šç©ºå¤´åŠ›é‡å¢å¼º
```

### 3. MACDæŒ‡æ ‡

**è®¡ç®—å…¬å¼**
```
DIF = EMA(12) - EMA(26)
DEA = EMA(DIF, 9)
MACD = (DIF - DEA) Ã— 2
```

**æœ¬é¡¹ç›®ä½¿ç”¨**
ä»…ä½¿ç”¨DIFçº¿åˆ¤æ–­çŸ­æœŸè¶‹åŠ¿ï¼š
- DIF > 0ï¼šçŸ­æœŸå¼ºäºé•¿æœŸï¼Œçœ‹æ¶¨
- DIF < 0ï¼šçŸ­æœŸå¼±äºé•¿æœŸï¼Œçœ‹è·Œ

### 4. RSVæŒ‡æ ‡ï¼ˆæ”¹è¿›ç‰ˆï¼‰

**æ ‡å‡†å…¬å¼**
```
RSV = (C - LN) / (HN - LN) Ã— 100
```

**æœ¬é¡¹ç›®æ”¹è¿›å…¬å¼**
```python
# compute_rsv()å‡½æ•°
low_n = df["low"].rolling(n).min()        # Næ—¥æœ€ä½ä»·çš„æœ€ä½
high_close_n = df["close"].rolling(n).max()  # Næ—¥æ”¶ç›˜ä»·çš„æœ€é«˜
rsv = (close - low_n) / (high_close_n - low_n) Ã— 100
```

**æ”¹è¿›åŸå› **
- åˆ†å­ï¼šä½¿ç”¨æ”¶ç›˜ä»·ç›¸å¯¹äºNæ—¥æœ€ä½ä»·
- åˆ†æ¯ï¼šä½¿ç”¨Næ—¥æ”¶ç›˜ä»·æœ€é«˜-Næ—¥æœ€ä½ä»·æœ€ä½
- æ›´å…³æ³¨æ”¶ç›˜ä»·çš„ç›¸å¯¹ä½ç½®ï¼Œè¿‡æ»¤æ—¥å†…æå€¼å¹²æ‰°

### 5. MAå‡çº¿

**å¸¸ç”¨å‘¨æœŸ**
```
MA5ï¼šè¶…çŸ­æœŸè¶‹åŠ¿
MA10ï¼šçŸ­æœŸè¶‹åŠ¿
MA20ï¼šæœˆçº¿è¶‹åŠ¿
MA60ï¼šå­£çº¿è¶‹åŠ¿ï¼ˆæœ¬é¡¹ç›®é‡ç‚¹ä½¿ç”¨ï¼‰
MA120ï¼šåŠå¹´çº¿
MA250ï¼šå¹´çº¿
```

**MA60ç‰¹æ®Šåœ°ä½**
- ä»£è¡¨3ä¸ªæœˆï¼ˆçº¦60ä¸ªäº¤æ˜“æ—¥ï¼‰çš„å¹³å‡æˆæœ¬
- æœ‰æ•ˆä¸Šç©¿MA60å¸¸è¢«è§†ä¸ºä¸­æœŸè¶‹åŠ¿è½¬å¼º
- æœ¬é¡¹ç›®å¤šä¸ªç­–ç•¥è¦æ±‚ä»·æ ¼ä½äºMA60ä¸Šæ–¹

### 6. çŸ¥è¡ŒçŸ­/é•¿çº¿

**è®¡ç®—å…¬å¼**
```
ZXDQï¼ˆçŸ­æœŸçº¿ï¼‰= EMA(EMA(C, 10), 10)
ZXDKXï¼ˆé•¿æœŸçº¿ï¼‰= [MA14 + MA28 + MA57 + MA114] / 4
```

**åº”ç”¨åœºæ™¯**
```
æ”¶ç›˜ > é•¿æœŸçº¿ï¼šä»·æ ¼å¤„äºé•¿æœŸæ”¯æ’‘ä¸Šæ–¹
çŸ­æœŸçº¿ > é•¿æœŸçº¿ï¼šçŸ­æœŸè¶‹åŠ¿å¼ºäºé•¿æœŸ
ä¸¤è€…åŒæ—¶æ»¡è¶³ï¼šçŸ¥è¡Œåˆä¸€ï¼Œä¿¡å·æœ€å¼º
```

---

## ğŸ” é€‰è‚¡ç­–ç•¥è¯¦è§£

### ç­–ç•¥å¯¹æ¯”è¡¨

| ç­–ç•¥ | é€‚ç”¨å¸‚åœº | æŒä»“å‘¨æœŸ | é£é™©ç­‰çº§ | æ ¸å¿ƒæŒ‡æ ‡ |
|------|----------|----------|----------|----------|
| å°‘å¦‡æˆ˜æ³• | éœ‡è¡å¸‚/ç‰›å¸‚åˆæœŸ | ä¸­çŸ­æœŸï¼ˆ1-3å‘¨ï¼‰ | ä¸­ | BBI+KDJ+MA60 |
| SuperB1æˆ˜æ³• | ç›˜æ•´åä¸‹è·Œ | çŸ­æœŸï¼ˆ3-10æ—¥ï¼‰ | ä¸­é«˜ | BBIKDJSelectoråµŒå¥—+å›è°ƒ |
| è¡¥ç¥¨æˆ˜æ³• | å¼ºåŠ¿è‚¡å›è°ƒ | çŸ­æœŸï¼ˆ3-7æ—¥ï¼‰ | é«˜ | RSVåŒå‘¨æœŸ+BBI |
| å¡«å‘æˆ˜æ³• | éœ‡è¡å¸‚ | ä¸­æœŸï¼ˆ1-4å‘¨ï¼‰ | ä¸­ | å³°å€¼+KDJ |
| ä¸Šç©¿60æ”¾é‡æˆ˜æ³• | çªç ´è¡Œæƒ… | ä¸­é•¿æœŸï¼ˆ2-8å‘¨ï¼‰ | ä¸­ä½ | MA60+é‡èƒ½+æ–œç‡ |
| å‡ºå‘æˆ˜æ³• | å‰é«˜çªç ´ | ä¸­çŸ­æœŸï¼ˆ1-3å‘¨ï¼‰ | ä¸­é«˜ | å‰é«˜+é‡èƒ½+å‡çº¿ |

### ç­–ç•¥é€‰æ‹©å†³ç­–æ ‘

```
å½“å‰å¸‚åœºçŠ¶æ€ï¼Ÿ
â”œâ”€ éœ‡è¡å¸‚
â”‚  â”œâ”€ ä»·æ ¼åœ¨MA60é™„è¿‘ â†’ å°‘å¦‡æˆ˜æ³•
â”‚  â””â”€ ä»·æ ¼å›åˆ°å‰æœŸå³°å€¼ â†’ å¡«å‘æˆ˜æ³•
â”‚
â”œâ”€ ç›˜æ•´çªç ´
â”‚  â”œâ”€ å·²ä¸Šç©¿MA60ä¸”æ”¾é‡ â†’ ä¸Šç©¿60æ”¾é‡æˆ˜æ³•
â”‚  â”œâ”€ ç›˜æ•´åå°å¹…ä¸‹è·Œ â†’ SuperB1æˆ˜æ³•
â”‚  â””â”€ æ¨ªç›˜åæ¥è¿‘å‰é«˜ â†’ å‡ºå‘æˆ˜æ³• â­æ–°å¢
â”‚
â””â”€ å¼ºåŠ¿è‚¡å›è°ƒ
   â””â”€ RSVä»é«˜ä½å›è½ååå¼¹ â†’ è¡¥ç¥¨æˆ˜æ³•
```

### å‚æ•°è°ƒä¼˜å»ºè®®

**ä¿å®ˆå‹æŠ•èµ„è€…**
```json
{
  "j_threshold": 10,         // é™ä½Jå€¼é—¨æ§›ï¼Œæ›´ä¸¥æ ¼
  "bbi_q_threshold": 0.1,    // å‡å°‘BBIå›æ’¤å®¹å¿åº¦
  "price_range_pct": 0.5,    // ç¼©å°ä»·æ ¼æ³¢åŠ¨èŒƒå›´
  "vol_multiple": 2.0        // æé«˜é‡èƒ½è¦æ±‚
}
```

**æ¿€è¿›å‹æŠ•èµ„è€…**
```json
{
  "j_threshold": 20,         // æé«˜Jå€¼é—¨æ§›ï¼Œæ•æ‰æ›´å¤šæœºä¼š
  "bbi_q_threshold": 0.3,    // å…è®¸æ›´å¤šBBIå›æ’¤
  "price_range_pct": 1.5,    // æ‰©å¤§ä»·æ ¼æ³¢åŠ¨èŒƒå›´
  "vol_multiple": 1.5        // é™ä½é‡èƒ½è¦æ±‚
}
```

---

## ğŸ› ï¸ äºŒæ¬¡å¼€å‘æŒ‡å—

### 1. æ·»åŠ æ–°çš„é€‰è‚¡ç­–ç•¥

**æ­¥éª¤ï¼š**

**â‘  åœ¨`Selector.py`ä¸­åˆ›å»ºæ–°ç±»**
```python
class MyNewSelector:
    """
    ä½ çš„ç­–ç•¥è¯´æ˜
    """
    def __init__(
        self,
        param1: float = 10.0,
        param2: int = 20,
    ) -> None:
        self.param1 = param1
        self.param2 = param2
    
    def _passes_filters(self, hist: pd.DataFrame) -> bool:
        """å•æ”¯è‚¡ç¥¨è¿‡æ»¤é€»è¾‘"""
        # 1. ç»Ÿä¸€å½“æ—¥è¿‡æ»¤
        if not passes_day_constraints_today(hist):
            return False
        
        # 2. ä½ çš„ç­–ç•¥é€»è¾‘
        # ...
        
        # 3. çŸ¥è¡Œçº¦æŸï¼ˆå¯é€‰ï¼‰
        if not zx_condition_at_positions(hist, 
            require_close_gt_long=True, 
            require_short_gt_long=True):
            return False
        
        return True
    
    def select(
        self, 
        date: pd.Timestamp, 
        data: Dict[str, pd.DataFrame]
    ) -> List[str]:
        """æ‰¹é‡é€‰è‚¡æ¥å£"""
        picks: List[str] = []
        for code, df in data.items():
            hist = df[df["date"] <= date]
            if hist.empty:
                continue
            if self._passes_filters(hist):
                picks.append(code)
        return picks
```

**â‘¡ åœ¨`configs.json`ä¸­æ·»åŠ é…ç½®**
```json
{
  "selectors": [
    ...,
    {
      "class": "MyNewSelector",
      "alias": "æˆ‘çš„ç­–ç•¥",
      "activate": true,
      "params": {
        "param1": 15.0,
        "param2": 30
      }
    }
  ]
}
```

**â‘¢ è¿è¡Œæµ‹è¯•**
```bash
python select_stock.py --date 2025-09-10
```

### 2. æ·»åŠ æ–°çš„æŠ€æœ¯æŒ‡æ ‡

**åœ¨`Selector.py`é¡¶éƒ¨æ·»åŠ å‡½æ•°**
```python
def compute_my_indicator(df: pd.DataFrame, n: int = 20) -> pd.Series:
    """
    è®¡ç®—ä½ çš„æŒ‡æ ‡
    
    Parameters
    ----------
    df : pd.DataFrame
        åŒ…å«OHLCVçš„DataFrame
    n : int
        è®¡ç®—å‘¨æœŸ
    
    Returns
    -------
    pd.Series
        æŒ‡æ ‡åºåˆ—
    """
    # ç¤ºä¾‹ï¼šè®¡ç®—çœŸå®æ³¢å¹…ï¼ˆATRï¼‰
    high_low = df["high"] - df["low"]
    high_close = abs(df["high"] - df["close"].shift(1))
    low_close = abs(df["low"] - df["close"].shift(1))
    
    tr = pd.concat([high_low, high_close, low_close], axis=1).max(axis=1)
    atr = tr.rolling(window=n, min_periods=1).mean()
    
    return atr
```

**åœ¨ç­–ç•¥ä¸­ä½¿ç”¨**
```python
class MyNewSelector:
    def _passes_filters(self, hist: pd.DataFrame) -> bool:
        hist["ATR"] = compute_my_indicator(hist, n=14)
        
        # ä½¿ç”¨ATRåˆ¤æ–­æ³¢åŠ¨ç‡
        atr_today = hist["ATR"].iloc[-1]
        if atr_today < 0.5:  # æ³¢åŠ¨ç‡è¿‡ä½
            return False
        
        # ... å…¶ä»–é€»è¾‘
```

### 3. ä¿®æ”¹æ•°æ®æº

**åœºæ™¯ï¼šä»æœ¬åœ°æ•°æ®åº“è¯»å–è€ŒéCSV**

**ä¿®æ”¹`select_stock.py`çš„`load_data`å‡½æ•°**
```python
import sqlite3

def load_data(db_path: Path, codes: Iterable[str]) -> Dict[str, pd.DataFrame]:
    """ä»SQLiteæ•°æ®åº“åŠ è½½æ•°æ®"""
    conn = sqlite3.connect(db_path)
    frames: Dict[str, pd.DataFrame] = {}
    
    for code in codes:
        query = f"""
        SELECT date, open, close, high, low, volume
        FROM kline
        WHERE code = '{code}'
        ORDER BY date
        """
        try:
            df = pd.read_sql(query, conn, parse_dates=["date"])
            if not df.empty:
                frames[code] = df
        except Exception as e:
            logger.warning(f"è¯»å–{code}å¤±è´¥: {e}")
    
    conn.close()
    return frames
```

### 4. å¹¶è¡ŒåŒ–é€‰è‚¡

**åœºæ™¯ï¼šåŠ é€Ÿå¤šåªè‚¡ç¥¨çš„è¿‡æ»¤å¤„ç†**

**ä¿®æ”¹é€‰æ‹©å™¨çš„`select`æ–¹æ³•**
```python
from concurrent.futures import ProcessPoolExecutor, as_completed

class BBIKDJSelector:
    def select(
        self, 
        date: pd.Timestamp, 
        data: Dict[str, pd.DataFrame],
        max_workers: int = 4
    ) -> List[str]:
        """å¹¶è¡Œé€‰è‚¡"""
        def check_one(item):
            code, df = item
            hist = df[df["date"] <= date].tail(self.max_window + 20)
            return code if self._passes_filters(hist) else None
        
        picks: List[str] = []
        with ProcessPoolExecutor(max_workers=max_workers) as executor:
            futures = {executor.submit(check_one, item): item[0] 
                      for item in data.items()}
            
            for future in as_completed(futures):
                result = future.result()
                if result:
                    picks.append(result)
        
        return sorted(picks)
```

### 5. æ·»åŠ å›æµ‹åŠŸèƒ½

**åˆ›å»ºæ–°æ–‡ä»¶`backtest.py`**
```python
import pandas as pd
from pathlib import Path
from typing import Dict, List
from Selector import BBIKDJSelector
from select_stock import load_data

def backtest(
    data: Dict[str, pd.DataFrame],
    selector: BBIKDJSelector,
    start_date: str,
    end_date: str,
    hold_days: int = 5
) -> pd.DataFrame:
    """
    ç®€å•å›æµ‹æ¡†æ¶
    
    Parameters
    ----------
    data : è¡Œæƒ…æ•°æ®
    selector : é€‰æ‹©å™¨å®ä¾‹
    start_date : å›æµ‹èµ·å§‹æ—¥æœŸ
    end_date : å›æµ‹ç»“æŸæ—¥æœŸ
    hold_days : æŒæœ‰å¤©æ•°
    
    Returns
    -------
    pd.DataFrame : å›æµ‹ç»“æœ
    """
    # è·å–æ‰€æœ‰äº¤æ˜“æ—¥
    all_dates = sorted(set(
        date for df in data.values() 
        for date in df["date"]
    ))
    
    start = pd.to_datetime(start_date)
    end = pd.to_datetime(end_date)
    test_dates = [d for d in all_dates if start <= d <= end]
    
    results = []
    
    for date in test_dates:
        # æ‰§è¡Œé€‰è‚¡
        picks = selector.select(date, data)
        
        # è®¡ç®—æ”¶ç›Š
        for code in picks:
            df = data[code]
            buy_idx = df[df["date"] == date].index
            if len(buy_idx) == 0:
                continue
            
            buy_idx = buy_idx[0]
            sell_idx = min(buy_idx + hold_days, len(df) - 1)
            
            buy_price = df.loc[buy_idx, "close"]
            sell_price = df.loc[sell_idx, "close"]
            pct_return = (sell_price / buy_price - 1) * 100
            
            results.append({
                "date": date,
                "code": code,
                "buy_price": buy_price,
                "sell_price": sell_price,
                "return_pct": pct_return,
                "hold_days": sell_idx - buy_idx
            })
    
    return pd.DataFrame(results)

# ä½¿ç”¨ç¤ºä¾‹
if __name__ == "__main__":
    data_dir = Path("./data")
    codes = [f.stem for f in data_dir.glob("*.csv")]
    data = load_data(data_dir, codes)
    
    selector = BBIKDJSelector(
        j_threshold=15,
        bbi_min_window=20,
        max_window=120,
        price_range_pct=1.0,
        bbi_q_threshold=0.2,
        j_q_threshold=0.10
    )
    
    results = backtest(
        data, 
        selector, 
        "2024-01-01", 
        "2024-12-31", 
        hold_days=5
    )
    
    # ç»Ÿè®¡åˆ†æ
    print(f"æ€»äº¤æ˜“æ¬¡æ•°: {len(results)}")
    print(f"å¹³å‡æ”¶ç›Šç‡: {results['return_pct'].mean():.2f}%")
    print(f"èƒœç‡: {(results['return_pct'] > 0).sum() / len(results) * 100:.2f}%")
    print(f"æœ€å¤§æ”¶ç›Š: {results['return_pct'].max():.2f}%")
    print(f"æœ€å¤§äºæŸ: {results['return_pct'].min():.2f}%")
```

### 6. æ·»åŠ å®æ—¶ç›‘æ§

**åˆ›å»ºæ–°æ–‡ä»¶`monitor.py`**
```python
import time
import schedule
from datetime import datetime
from select_stock import main as select_main

def job():
    """å®šæ—¶é€‰è‚¡ä»»åŠ¡"""
    print(f"\n{'='*50}")
    print(f"æ‰§è¡Œæ—¶é—´: {datetime.now()}")
    print(f"{'='*50}\n")
    
    # æ‰§è¡Œé€‰è‚¡
    select_main()
    
    print(f"\nä¸‹æ¬¡æ‰§è¡Œæ—¶é—´: {datetime.now().replace(hour=15, minute=0)}")

# è®¾ç½®å®šæ—¶ä»»åŠ¡
schedule.every().day.at("15:00").do(job)  # æ¯å¤©15:00æ‰§è¡Œ

print("é€‰è‚¡ç›‘æ§å·²å¯åŠ¨...")
print("å°†åœ¨æ¯å¤©15:00æ‰§è¡Œé€‰è‚¡")

while True:
    schedule.run_pending()
    time.sleep(60)  # æ¯åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
```

---

## âš ï¸ å¸¸è§é—®é¢˜ä¸ä¼˜åŒ–å»ºè®®

### å¸¸è§é—®é¢˜

**Q1: Tushareé™æµæ€ä¹ˆåŠï¼Ÿ**
```
é—®é¢˜ï¼šæŠ“å–æ—¶é¢‘ç¹é‡åˆ°"è®¿é—®é¢‘ç¹"é”™è¯¯
è§£å†³æ–¹æ¡ˆï¼š
1. é™ä½å¹¶å‘æ•°ï¼š--workers 3
2. åˆ†æ‰¹æ¬¡æŠ“å–ï¼šæŒ‰æ¿å—åˆ†å¼€æŠ“å–
3. å‡çº§Tushareç§¯åˆ†ï¼šæé«˜APIè°ƒç”¨é¢‘ç‡
4. ä½¿ç”¨ä»˜è´¹ç‰ˆï¼šæ— é™æµé™åˆ¶
```

**Q2: é€‰è‚¡ç»“æœä¸ºç©ºï¼Ÿ**
```
é—®é¢˜ï¼šæ‰€æœ‰ç­–ç•¥éƒ½è¿”å›ç©ºåˆ—è¡¨
æ’æŸ¥æ­¥éª¤ï¼š
1. æ£€æŸ¥æ•°æ®å®Œæ•´æ€§ï¼š
   - ç¡®è®¤data/ç›®å½•æœ‰CSVæ–‡ä»¶
   - æ‰“å¼€å‡ ä¸ªCSVç¡®è®¤æ•°æ®æ ¼å¼æ­£ç¡®
   
2. æ£€æŸ¥äº¤æ˜“æ—¥ï¼š
   - ç¡®è®¤--dateå‚æ•°æ˜¯äº¤æ˜“æ—¥
   - æˆ–çœç•¥--dateä½¿ç”¨æœ€æ–°æ•°æ®
   
3. æ”¾å®½å‚æ•°ï¼š
   - æé«˜j_thresholdï¼ˆå¦‚20ï¼‰
   - å¢å¤§bbi_q_thresholdï¼ˆå¦‚0.3ï¼‰
   - æ‰©å¤§price_range_pctï¼ˆå¦‚1.5ï¼‰
   
4. æŸ¥çœ‹æ—¥å¿—ï¼š
   - æ£€æŸ¥select_results.log
   - ç¡®è®¤æ˜¯å¦æœ‰æŠ¥é”™ä¿¡æ¯
```

**Q3: å†…å­˜å ç”¨è¿‡é«˜ï¼Ÿ**
```
é—®é¢˜ï¼šè¿è¡Œæ—¶å†…å­˜è¾¾åˆ°æ•°GB
åŸå› ï¼šä¸€æ¬¡æ€§åŠ è½½æ‰€æœ‰è‚¡ç¥¨æ•°æ®
è§£å†³æ–¹æ¡ˆï¼š
1. æ‰¹é‡å¤„ç†ï¼š
   def select_batch(codes, batch_size=100):
       for i in range(0, len(codes), batch_size):
           batch = codes[i:i+batch_size]
           data = load_data(data_dir, batch)
           picks = selector.select(date, data)
           yield picks

2. ä½¿ç”¨featheræ ¼å¼ï¼š
   # ä¿å­˜
   df.to_feather(f"data/{code}.feather")
   # è¯»å–ï¼ˆæ›´å¿«ä¸”å†…å­˜å‹å¥½ï¼‰
   df = pd.read_feather(f"data/{code}.feather")
```

**Q4: è‚¡ç¥¨æ± å¦‚ä½•æ›´æ–°ï¼Ÿ**
```
é—®é¢˜ï¼šstocklist.csvä¸­çš„è‚¡ç¥¨å¯èƒ½é€€å¸‚æˆ–æ–°ä¸Šå¸‚
è§£å†³æ–¹æ¡ˆï¼š
1. å®šæœŸä»Tushareè·å–ï¼š
   import tushare as ts
   pro = ts.pro_api()
   
   # è·å–æ‰€æœ‰è‚¡ç¥¨
   df = pro.stock_basic(
       exchange='',
       list_status='L',  # ä¸Šå¸‚çŠ¶æ€
       fields='ts_code,symbol,name,area,industry'
   )
   df.to_csv("stocklist.csv", index=False)

2. æ‰‹åŠ¨ç»´æŠ¤ï¼š
   - åˆ é™¤é€€å¸‚è‚¡ç¥¨è¡Œ
   - æ·»åŠ æ–°ä¸Šå¸‚è‚¡ç¥¨
```

### æ€§èƒ½ä¼˜åŒ–å»ºè®®

**1. æ•°æ®å­˜å‚¨ä¼˜åŒ–**
```python
# ä½¿ç”¨Parquetæ ¼å¼ï¼ˆå‹ç¼©ç‡é«˜ï¼Œè¯»å–å¿«ï¼‰
df.to_parquet(f"data/{code}.parquet", compression='snappy')
df = pd.read_parquet(f"data/{code}.parquet")

# æˆ–ä½¿ç”¨HDF5ï¼ˆæ”¯æŒå¤æ‚æŸ¥è¯¢ï¼‰
store = pd.HDFStore("data/kline.h5")
store[code] = df
df = store[code]
```

**2. æŒ‡æ ‡è®¡ç®—ä¼˜åŒ–**
```python
# ä½¿ç”¨numbaåŠ é€Ÿ
from numba import jit

@jit(nopython=True)
def fast_kdj(close, high, low, n=9):
    """JITç¼–è¯‘çš„KDJè®¡ç®—"""
    # ... å®ç°é€»è¾‘
    return K, D, J

# ä½¿ç”¨ta-libåº“ï¼ˆCè¯­è¨€å®ç°ï¼Œæå¿«ï¼‰
import talib
K, D = talib.STOCH(high, low, close)
J = 3 * K - 2 * D
```

**3. é€‰è‚¡å¹¶è¡ŒåŒ–**
```python
# ä½¿ç”¨joblibï¼ˆæ¯”ProcessPoolExecutoræ›´ç®€å•ï¼‰
from joblib import Parallel, delayed

def select_parallel(date, data, selector):
    def check(item):
        code, df = item
        hist = df[df["date"] <= date]
        return code if selector._passes_filters(hist) else None
    
    results = Parallel(n_jobs=-1)(
        delayed(check)(item) for item in data.items()
    )
    
    return [r for r in results if r is not None]
```

**4. å†…å­˜ä¼˜åŒ–**
```python
# å‡å°‘DataFrameæ‹·è´
def _passes_filters(self, hist: pd.DataFrame) -> bool:
    # ä¸å¥½ï¼šå¤šæ¬¡æ‹·è´
    hist = hist.copy()
    hist["BBI"] = compute_bbi(hist)
    hist["KDJ"] = compute_kdj(hist)
    
    # å¥½ï¼šåªåœ¨å¿…è¦æ—¶æ‹·è´
    bbi = compute_bbi(hist)
    kdj = compute_kdj(hist)
    
    # åŸåœ°ä¿®æ”¹ï¼ˆæœ€å¿«ï¼Œä½†è¦å°å¿ƒå‰¯ä½œç”¨ï¼‰
    hist.loc[:, "BBI"] = compute_bbi(hist)
```

### ç›‘æ§ä¸å‘Šè­¦

**åˆ›å»º`alert.py`å®ç°å¾®ä¿¡é€šçŸ¥**
```python
import requests

def send_wechat_alert(picks: List[str], strategy: str):
    """é€šè¿‡ä¼ä¸šå¾®ä¿¡æœºå™¨äººå‘é€é€‰è‚¡ç»“æœ"""
    webhook = "https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=YOUR_KEY"
    
    content = f"""
é€‰è‚¡æé†’
ç­–ç•¥ï¼š{strategy}
æ—¶é—´ï¼š{datetime.now().strftime('%Y-%m-%d %H:%M')}
ç¬¦åˆæ¡ä»¶ï¼š{len(picks)}åª

è‚¡ç¥¨ä»£ç ï¼š
{', '.join(picks[:20])}
{'...' if len(picks) > 20 else ''}
    """
    
    data = {
        "msgtype": "text",
        "text": {"content": content}
    }
    
    requests.post(webhook, json=data)

# åœ¨select_stock.pyä¸­è°ƒç”¨
picks = selector.select(trade_date, data)
if picks:
    send_wechat_alert(picks, alias)
```

---

## ğŸ“š é™„å½•

### A. é…ç½®æ–‡ä»¶å®Œæ•´ç¤ºä¾‹

```json
{
  "selectors": [
    {
      "class": "BBIKDJSelector",
      "alias": "å°‘å¦‡æˆ˜æ³•",
      "activate": true,
      "params": {
        "j_threshold": 15,
        "bbi_min_window": 20,
        "max_window": 120,
        "price_range_pct": 1,
        "bbi_q_threshold": 0.2,
        "j_q_threshold": 0.10
      }
    },
    {
      "class": "SuperB1Selector",
      "alias": "SuperB1æˆ˜æ³•",
      "activate": true,
      "params": {
        "lookback_n": 10,
        "close_vol_pct": 0.02,
        "price_drop_pct": 0.02,
        "j_threshold": 10,
        "j_q_threshold": 0.10,
        "B1_params": {
          "j_threshold": 15,
          "bbi_min_window": 20,
          "max_window": 120,
          "price_range_pct": 1,
          "bbi_q_threshold": 0.3,
          "j_q_threshold": 0.10
        }
      }
    },
    {
      "class": "BBIShortLongSelector",
      "alias": "è¡¥ç¥¨æˆ˜æ³•",
      "activate": true,
      "params": {
        "n_short": 5,
        "n_long": 21,
        "m": 5,
        "bbi_min_window": 2,
        "max_window": 120,
        "bbi_q_threshold": 0.2,
        "upper_rsv_threshold": 75,
        "lower_rsv_threshold": 25
      }
    },
    {
      "class": "PeakKDJSelector",
      "alias": "å¡«å‘æˆ˜æ³•",
      "activate": true,
      "params": {
        "j_threshold": 10,
        "max_window": 120,
        "fluc_threshold": 0.03,
        "j_q_threshold": 0.10,
        "gap_threshold": 0.2
      }
    },
    {
      "class": "MA60CrossVolumeWaveSelector",
      "alias": "ä¸Šç©¿60æ”¾é‡æˆ˜æ³•",
      "activate": true,
      "params": {
        "lookback_n": 25,
        "vol_multiple": 1.8,
        "j_threshold": 15,
        "j_q_threshold": 0.10,
        "ma60_slope_days": 5,
        "max_window": 120
      }
    }
  ]
}
```

### B. å‘½ä»¤é€ŸæŸ¥è¡¨

```bash
# æ•°æ®è·å–
python fetch_kline.py --start 20240101 --end today --workers 6

# é€‰è‚¡æ‰§è¡Œ
python select_stock.py --date 2025-09-10

# è¡Œä¸šåˆ†æ
python SectorShift.py --j_threshold 15 --trade_date 20250910

# ä»·æ ¼æŸ¥è¯¢
python find_stock_by_price_concurrent.py 10.0 --tolerance 0.01

# æŸ¥çœ‹æ—¥å¿—
tail -f select_results.log
```

### C. æ•°æ®åº“Schemaï¼ˆå¯é€‰ï¼‰

```sql
-- åˆ›å»ºè¡Œæƒ…è¡¨
CREATE TABLE kline (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    code TEXT NOT NULL,
    date DATE NOT NULL,
    open REAL,
    close REAL,
    high REAL,
    low REAL,
    volume REAL,
    UNIQUE(code, date)
);

CREATE INDEX idx_code ON kline(code);
CREATE INDEX idx_date ON kline(date);

-- åˆ›å»ºé€‰è‚¡ç»“æœè¡¨
CREATE TABLE select_results (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    code TEXT NOT NULL,
    strategy TEXT NOT NULL,
    select_date DATE NOT NULL,
    create_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_select_date ON select_results(select_date);
```

---

## ğŸ“ æ€»ç»“

### ä»£ç è´¨é‡è¯„ä¼°

**ä¼˜ç‚¹ï¼š**
âœ… æ¶æ„æ¸…æ™°ï¼Œæ¨¡å—èŒè´£æ˜ç¡®
âœ… æŠ€æœ¯æŒ‡æ ‡è®¡ç®—å‡†ç¡®ï¼Œæœ‰æ•°å­¦ä¾æ®
âœ… ç­–ç•¥é€»è¾‘å®Œæ•´ï¼Œæ³¨é‡Šè¯¦ç»†
âœ… æ”¯æŒå¹¶å‘ï¼Œæ€§èƒ½è¾ƒå¥½
âœ… é…ç½®åŒ–è®¾è®¡ï¼Œæ˜“äºè°ƒå‚

**å¯ä¼˜åŒ–ç‚¹ï¼š**
âš ï¸ ç¼ºå°‘å•å…ƒæµ‹è¯•
âš ï¸ ç¼ºå°‘å›æµ‹æ¡†æ¶
âš ï¸ æ•°æ®å­˜å‚¨å¯ä¼˜åŒ–ï¼ˆCSVâ†’Parquet/HDF5ï¼‰
âš ï¸ ç¼ºå°‘å®æ—¶ç›‘æ§ä¸å‘Šè­¦
âš ï¸ ç¼ºå°‘é£é™©æ§åˆ¶æ¨¡å—ï¼ˆæ­¢æŸ/ä»“ä½ç®¡ç†ï¼‰

### é€‚ç”¨äººç¾¤

**é€‚åˆï¼š**
- ç†Ÿæ‚‰Pythonç¼–ç¨‹çš„é‡åŒ–äº¤æ˜“çˆ±å¥½è€…
- äº†è§£æŠ€æœ¯åˆ†æçš„ä¸ªäººæŠ•èµ„è€…
- éœ€è¦è‡ªåŠ¨åŒ–é€‰è‚¡å·¥å…·çš„äº¤æ˜“è€…

**ä¸é€‚åˆï¼š**
- å®Œå…¨ä¸æ‡‚ç¼–ç¨‹çš„ç”¨æˆ·ï¼ˆéœ€å­¦ä¹ PythonåŸºç¡€ï¼‰
- è¿½æ±‚é«˜é¢‘äº¤æ˜“çš„ç”¨æˆ·ï¼ˆæœ¬ç³»ç»Ÿä¸ºæ—¥çº¿ç­–ç•¥ï¼‰
- éœ€è¦å®ç›˜è‡ªåŠ¨äº¤æ˜“çš„ç”¨æˆ·ï¼ˆä»…é€‰è‚¡ï¼Œä¸å«äº¤æ˜“åŠŸèƒ½ï¼‰

### äºŒæ¬¡å¼€å‘å»ºè®®ä¼˜å…ˆçº§

**é«˜ä¼˜å…ˆçº§ï¼š**
1. æ·»åŠ å›æµ‹æ¡†æ¶ï¼ˆéªŒè¯ç­–ç•¥æœ‰æ•ˆæ€§ï¼‰
2. å®ç°é£é™©æ§åˆ¶æ¨¡å—ï¼ˆæ­¢æŸ/ä»“ä½ï¼‰
3. æ·»åŠ å®æ—¶ç›‘æ§ä¸å‘Šè­¦

**ä¸­ä¼˜å…ˆçº§ï¼š**
4. ä¼˜åŒ–æ•°æ®å­˜å‚¨ï¼ˆæ€§èƒ½æå‡ï¼‰
5. æ·»åŠ æ›´å¤šç­–ç•¥ï¼ˆä¸°å¯Œé€‰æ‹©ï¼‰
6. å®ç°å‚æ•°è‡ªåŠ¨ä¼˜åŒ–ï¼ˆé—ä¼ ç®—æ³•/ç½‘æ ¼æœç´¢ï¼‰

**ä½ä¼˜å…ˆçº§ï¼š**
7. æ·»åŠ Webç•Œé¢ï¼ˆå¯è§†åŒ–ï¼‰
8. æ¥å…¥å®ç›˜äº¤æ˜“API
9. åˆ†å¸ƒå¼éƒ¨ç½²

---

## ğŸ™ è‡´è°¢

æ„Ÿè°¢ **@Zettaranc**ï¼ˆZå“¥ï¼‰åœ¨Bilibiliçš„æ— ç§åˆ†äº«ï¼Œä¸ºæœ¬é¡¹ç›®æä¾›äº†æ ¸å¿ƒç­–ç•¥æ€æƒ³ã€‚

é¡¹ç›®åœ°å€ï¼šhttps://github.com/your-repo/StockTradebyZ

---

**âš ï¸ å…è´£å£°æ˜ï¼š**
æœ¬é¡¹ç›®ä»…ä¾›å­¦ä¹ ä¸æŠ€æœ¯ç ”ç©¶ä¹‹ç”¨ï¼Œä¸æ„æˆä»»ä½•æŠ•èµ„å»ºè®®ã€‚è‚¡å¸‚æœ‰é£é™©ï¼Œå…¥å¸‚éœ€è°¨æ…ã€‚ä½¿ç”¨æœ¬é¡¹ç›®äº§ç”Ÿçš„ä»»ä½•ç›ˆäºï¼Œå‡ç”±ä½¿ç”¨è€…è‡ªè¡Œæ‰¿æ‹…ã€‚

