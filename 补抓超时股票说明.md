# 补抓超时股票说明

## 功能说明

已为 `fetch_kline.py` 添加 `--codes` 参数，支持传入股票代码数组，用于抓取指定的股票数据。

## 使用方法

### 方法1：使用便捷脚本（推荐）

已创建 `fetch_timeout_stocks.sh` 脚本，包含所有56只超时的股票代码。

```bash
# 设置token
export TUSHARE_TOKEN="你的token"

# 运行脚本
./fetch_timeout_stocks.sh
```

### 方法2：直接使用Python命令

```bash
# 设置token
export TUSHARE_TOKEN="你的token"

# 抓取指定股票
python3 fetch_kline.py \
    --start 20240101 \
    --end today \
    --codes "001367 001368 001373 001376 001378 001379" \
    --out ./data \
    --workers 3
```

### 方法3：自定义股票列表

```bash
export TUSHARE_TOKEN="你的token"

# 抓取任意股票
python3 fetch_kline.py \
    --codes "000001 000002 600000 300001" \
    --workers 3
```

## 参数说明

| 参数 | 说明 | 示例 |
|------|------|------|
| `--codes` | 股票代码列表（空格分隔） | `"000001 000002 600000"` |
| `--start` | 起始日期 | `20240101` |
| `--end` | 结束日期 | `today` |
| `--out` | 输出目录 | `./data` |
| `--workers` | 并发数（建议3-4避免超时） | `3` |

## 超时股票列表

以下56只股票在之前的抓取中因接口超时未获取：

```
001367 001368 001373 001376 001378 001379
002521 002522 002523 002526 002527 002528
300029 300031 300032 300033 300034 300035
300572 300573 300575 300576 300577 300578
301107 301108 301109 301110 301111 301112
600189 600193 600195 600196 600197 600198
603206 603207 603208 603209 603210 603211
605296 605298 605299 605300 605303 605305
688598 688599 688600 688601 688602 688603
```

## 注意事项

1. **并发数设置**：
   - 建议使用 `--workers 3` 或 `--workers 4`
   - 过高的并发可能导致超时或限流

2. **优先级**：
   - `--codes` 参数优先级高于 `--stocklist`
   - 当指定 `--codes` 时，会忽略 `--stocklist` 参数

3. **自动重试**：
   - 脚本会自动重试失败的股票（最多3次）
   - 每次重试间隔会递增（20秒、40秒、60秒）

4. **数据覆盖**：
   - 每次运行会覆盖已有的CSV文件
   - 确保备份重要数据

## 验证结果

抓取完成后，验证数据是否完整：

```bash
# 检查文件是否存在
ls data/001367.csv data/002521.csv data/300029.csv

# 查看文件行数（正常应该有200+行）
wc -l data/001367.csv data/002521.csv
```

## 示例输出

```
==========================================
开始抓取超时股票数据
==========================================
股票数量: 56只
数据目录: ./data
日期范围: 2024-01-01 至 今天
并发数: 3 (降低并发避免超时)
==========================================
2024-11-21 21:00:00 [INFO] 使用指定的股票代码列表，共 56 只股票
2024-11-21 21:00:01 [INFO] 开始抓取 56 支股票 | 数据源:Tushare(日线,qfq) | 日期:20240101 → 20241121 | 排除:无
下载进度: 100%|████████████████████████████████| 56/56 [05:23<00:00,  5.78s/it]
2024-11-21 21:05:24 [INFO] 全部任务完成，数据已保存至 /path/to/data
==========================================
超时股票数据抓取完成！
==========================================
```

## 故障排查

### 问题1：仍然超时

**解决**：
```bash
# 进一步降低并发
python3 fetch_kline.py --codes "你的股票代码" --workers 2
```

### 问题2：Token限流

**解决**：
- 等待10-15分钟后重试
- 检查token积分是否充足
- 分批次抓取（每次10-20只）

### 问题3：部分股票无数据

**解决**：
- 检查股票代码是否正确
- 某些股票可能在指定日期范围内未上市
- 查看 `fetch.log` 日志文件了解详情

---

**祝抓取顺利！** 📊

