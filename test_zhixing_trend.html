<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>çŸ¥è¡Œè¶‹åŠ¿çº¿æµ‹è¯•</title>
    <script src="https://cdn.jsdelivr.net/npm/plotly.js@2.27.0/dist/plotly.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
        .container { max-width: 1400px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; }
        h1 { color: #333; border-bottom: 3px solid #1976D2; padding-bottom: 10px; }
        .info { background: #e3f2fd; padding: 15px; border-radius: 5px; margin: 15px 0; }
        .success { color: #4caf50; font-weight: bold; }
        .warning { color: #ff9800; font-weight: bold; }
        .error { color: #f44336; font-weight: bold; }
        #chart { width: 100%; height: 600px; margin: 20px 0; }
        .stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin: 20px 0; }
        .stat-card { background: #f9f9f9; padding: 15px; border-radius: 5px; border-left: 4px solid #1976D2; }
        .stat-label { font-size: 12px; color: #666; }
        .stat-value { font-size: 24px; font-weight: bold; color: #333; margin: 5px 0; }
        button { background: #1976D2; color: white; border: none; padding: 12px 24px; border-radius: 5px; cursor: pointer; font-size: 16px; }
        button:hover { background: #1565C0; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“ˆ çŸ¥è¡Œä½“ç³»è¶‹åŠ¿çº¿æµ‹è¯•</h1>
        
        <div class="info">
            <h3>ğŸ“Š å…¬å¼è¯´æ˜</h3>
            <p><strong>çŸ­æœŸè¶‹åŠ¿çº¿</strong> = EMA(EMA(CLOSE, 10), 10) - åŒé‡æŒ‡æ•°ç§»åŠ¨å¹³å‡</p>
            <p><strong>çŸ¥è¡Œå¤šç©ºçº¿</strong> = (MA(14) + MA(28) + MA(57) + MA(114)) / 4 - å››å‡çº¿å¹³å‡</p>
            <p><strong>å·®å€¼ç™¾åˆ†æ¯”</strong> = ABS((CLOSE - çŸ­æœŸè¶‹åŠ¿çº¿) / çŸ­æœŸè¶‹åŠ¿çº¿) Ã— 100</p>
        </div>
        
        <button onclick="loadData()">ğŸ”„ åŠ è½½æµ‹è¯•æ•°æ®ï¼ˆ603027ï¼‰</button>
        
        <div id="status" style="margin: 20px 0;"></div>
        
        <div class="stats" id="stats"></div>
        
        <div id="chart"></div>
        
        <div id="trend-analysis"></div>
    </div>
    
    <script>
        async function loadData() {
            const statusDiv = document.getElementById('status');
            statusDiv.innerHTML = '<p>â³ åŠ è½½ä¸­...</p>';
            
            try {
                const response = await fetch('http://127.0.0.1:5000/api/stock/603027?days=120');
                const data = await response.json();
                
                if (!data.success) {
                    statusDiv.innerHTML = `<p class="error">âŒ åŠ è½½å¤±è´¥: ${data.error}</p>`;
                    return;
                }
                
                statusDiv.innerHTML = '<p class="success">âœ… æ•°æ®åŠ è½½æˆåŠŸ</p>';
                
                // æ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯
                displayStats(data);
                
                // ç»˜åˆ¶å›¾è¡¨
                drawChart(data);
                
                // è¶‹åŠ¿åˆ†æ
                analyzeTrend(data);
                
            } catch (error) {
                statusDiv.innerHTML = `<p class="error">âŒ é”™è¯¯: ${error.message}</p>`;
            }
        }
        
        function displayStats(data) {
            const idx = data.dates.length - 1;
            const close = data.close[idx];
            const trendShort = data.trend_short[idx];
            const trendLong = data.trend_long[idx];
            const diffPct = data.trend_diff_pct[idx];
            const shortAbove = data.trend_short_above[idx];
            
            const statsHtml = `
                <div class="stat-card">
                    <div class="stat-label">æ”¶ç›˜ä»·</div>
                    <div class="stat-value">Â¥${close.toFixed(2)}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">çŸ­æœŸè¶‹åŠ¿çº¿</div>
                    <div class="stat-value">Â¥${trendShort.toFixed(2)}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">çŸ¥è¡Œå¤šç©ºçº¿</div>
                    <div class="stat-value">Â¥${trendLong.toFixed(2)}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">å·®å€¼ç™¾åˆ†æ¯”</div>
                    <div class="stat-value">${diffPct.toFixed(2)}%</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">çŸ­æœŸåœ¨ä¸Š</div>
                    <div class="stat-value">${shortAbove ? 'âœ… æ˜¯' : 'âŒ å¦'}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">æ•°æ®ç‚¹æ•°</div>
                    <div class="stat-value">${data.dates.length}</div>
                </div>
            `;
            
            document.getElementById('stats').innerHTML = statsHtml;
        }
        
        function drawChart(data) {
            // Kçº¿
            const candlestick = {
                x: data.dates,
                open: data.open,
                high: data.high,
                low: data.low,
                close: data.close,
                type: 'candlestick',
                name: 'Kçº¿',
                increasing: {line: {color: '#ef5350'}, fillcolor: '#ef5350'},
                decreasing: {line: {color: '#26a69a'}, fillcolor: '#26a69a'}
            };
            
            // çŸ­æœŸè¶‹åŠ¿çº¿
            const trendShort = {
                x: data.dates,
                y: data.trend_short,
                type: 'scatter',
                mode: 'lines',
                name: 'çŸ­æœŸè¶‹åŠ¿çº¿ EMA(EMA(10))',
                line: {color: '#FF6B6B', width: 3}
            };
            
            // çŸ¥è¡Œå¤šç©ºçº¿
            const trendLong = {
                x: data.dates,
                y: data.trend_long,
                type: 'scatter',
                mode: 'lines',
                name: 'çŸ¥è¡Œå¤šç©ºçº¿ (MA14+28+57+114)/4',
                line: {color: '#1976D2', width: 3}
            };
            
            // äº¤æ˜“ä¿¡å·
            const b1Signals = (data.signals || []).filter(s => s.type === 'B1');
            const s1Signals = (data.signals || []).filter(s => s.type === 'S1');
            
            const traces = [candlestick, trendShort, trendLong];
            
            if (b1Signals.length > 0) {
                traces.push({
                    x: b1Signals.map(s => s.date),
                    y: b1Signals.map(s => s.price * 0.97),
                    mode: 'markers+text',
                    type: 'scatter',
                    name: 'B1ä¹°ç‚¹',
                    marker: {color: '#00C853', size: 15, symbol: 'triangle-up'},
                    text: b1Signals.map(() => 'B1'),
                    textposition: 'bottom center'
                });
            }
            
            if (s1Signals.length > 0) {
                traces.push({
                    x: s1Signals.map(s => s.date),
                    y: s1Signals.map(s => s.price * 1.03),
                    mode: 'markers+text',
                    type: 'scatter',
                    name: 'S1å–ç‚¹',
                    marker: {color: '#D32F2F', size: 15, symbol: 'triangle-down'},
                    text: s1Signals.map(() => 'S1'),
                    textposition: 'top center'
                });
            }
            
            const layout = {
                title: `603027 - çŸ¥è¡Œä½“ç³»è¶‹åŠ¿çº¿ ã€B1:${b1Signals.length} S1:${s1Signals.length}ã€‘`,
                xaxis: {
                    type: 'date',
                    rangeslider: {visible: false}
                },
                yaxis: {
                    title: 'ä»·æ ¼ (Â¥)'
                },
                height: 600,
                showlegend: true,
                legend: {
                    orientation: 'h',
                    y: -0.15
                }
            };
            
            Plotly.newPlot('chart', traces, layout);
        }
        
        function analyzeTrend(data) {
            const idx = data.dates.length - 1;
            const close = data.close[idx];
            const trendShort = data.trend_short[idx];
            const trendLong = data.trend_long[idx];
            const diffPct = data.trend_diff_pct[idx];
            const shortAbove = data.trend_short_above[idx];
            
            let trendType = '';
            let trendColor = '';
            let advice = '';
            
            if (shortAbove && close > trendShort) {
                trendType = 'ğŸŸ¢ å¼ºåŠ¿å¤šå¤´';
                trendColor = '#4caf50';
                advice = 'âœ… æœ€ä½³ä¹°å…¥æ—¶æœºï¼ä»·æ ¼åœ¨çŸ­æœŸè¶‹åŠ¿çº¿ä¸Šæ–¹ï¼ŒçŸ­æœŸè¶‹åŠ¿çº¿åœ¨çŸ¥è¡Œå¤šç©ºçº¿ä¸Šæ–¹ã€‚B1ä¿¡å·å¯é‡ä»“ï¼ˆ30-50%ï¼‰ã€‚';
            } else if (shortAbove) {
                trendType = 'ğŸŸ¡ ä¸­æ€§æ•´ç†';
                trendColor = '#ff9800';
                advice = 'âš ï¸ è°¨æ…ä¹°å…¥ã€‚çŸ­æœŸè¶‹åŠ¿å‘ä¸Šï¼Œä½†ä»·æ ¼åœ¨çŸ­æœŸè¶‹åŠ¿çº¿ä¸‹æ–¹ã€‚B1ä¿¡å·è½»ä»“ï¼ˆ10-20%ï¼‰ã€‚';
            } else {
                trendType = 'ğŸ”´ å¼±åŠ¿ç©ºå¤´';
                trendColor = '#f44336';
                advice = 'âŒ ä¸å»ºè®®ä¹°å…¥ã€‚çŸ­æœŸè¶‹åŠ¿çº¿åœ¨çŸ¥è¡Œå¤šç©ºçº¿ä¸‹æ–¹ï¼Œè¶‹åŠ¿åå¼±ã€‚å³ä½¿å‡ºç°B1ä¿¡å·ä¹Ÿè¦è°¨æ…ã€‚';
            }
            
            let diffAdvice = '';
            if (diffPct < 1) {
                diffAdvice = 'ä»·æ ¼è´´è¿‘è¶‹åŠ¿çº¿ï¼Œå¯èƒ½å³å°†çªç ´æˆ–å›è°ƒã€‚';
            } else if (diffPct < 3) {
                diffAdvice = 'å·®å€¼æ­£å¸¸ï¼Œè¶‹åŠ¿å»¶ç»­ä¸­ã€‚';
            } else if (diffPct < 5) {
                diffAdvice = 'å·®å€¼è¾ƒå¤§ï¼Œè­¦æƒ•å›è°ƒé£é™©ã€‚';
            } else {
                diffAdvice = 'å·®å€¼è¿‡å¤§ï¼Œé«˜æ¦‚ç‡å›è°ƒï¼Œä¸å»ºè®®è¿½é«˜ã€‚';
            }
            
            const analysisHtml = `
                <div class="info" style="border-left: 5px solid ${trendColor};">
                    <h3>ğŸ“Š è¶‹åŠ¿åˆ†æ</h3>
                    <p><strong>è¶‹åŠ¿ç±»å‹ï¼š</strong><span style="color: ${trendColor}; font-size: 20px;">${trendType}</span></p>
                    <p><strong>æ“ä½œå»ºè®®ï¼š</strong>${advice}</p>
                    <p><strong>å·®å€¼åˆ†æï¼š</strong>${diffAdvice}</p>
                    <hr>
                    <h4>æŠ€æœ¯ç»†èŠ‚ï¼š</h4>
                    <ul>
                        <li>æ”¶ç›˜ä»· ${close > trendShort ? '>' : '<'} çŸ­æœŸè¶‹åŠ¿çº¿ (${close.toFixed(2)} vs ${trendShort.toFixed(2)})</li>
                        <li>çŸ­æœŸè¶‹åŠ¿çº¿ ${shortAbove ? '>' : '<'} çŸ¥è¡Œå¤šç©ºçº¿ (${trendShort.toFixed(2)} vs ${trendLong.toFixed(2)})</li>
                        <li>å·®å€¼ç™¾åˆ†æ¯”ï¼š${diffPct.toFixed(2)}%</li>
                    </ul>
                </div>
            `;
            
            document.getElementById('trend-analysis').innerHTML = analysisHtml;
        }
        
        // é¡µé¢åŠ è½½åè‡ªåŠ¨æ‰§è¡Œ
        window.addEventListener('load', () => {
            setTimeout(loadData, 500);
        });
    </script>
</body>
</html>
