# 抓取全量股票数据使用说明

## 📋 快速开始

### 方法1：使用脚本（推荐）

```bash
# 1. 设置TUSHARE_TOKEN环境变量
export TUSHARE_TOKEN="你的token"

# 2. 运行抓取脚本
./fetch_all_stocks.sh
```

### 方法2：直接使用Python命令

```bash
# 设置token并运行
export TUSHARE_TOKEN="你的token"
python3 fetch_kline.py --start 20240101 --end today --stocklist stocklist.csv --out ./data --workers 6
```

## 📝 参数说明

### 基础参数

| 参数 | 说明 | 默认值 | 示例 |
|------|------|--------|------|
| `--start` | 起始日期 | `20190101` | `20240101` 或 `today` |
| `--end` | 结束日期 | `today` | `20241231` 或 `today` |
| `--stocklist` | 股票清单文件 | `./stocklist.csv` | `./stocklist.csv` |
| `--codes` | 指定股票代码 | 无 | `"000001 000002 600000"` |
| `--out` | 输出目录 | `./data` | `./data` |
| `--workers` | 并发线程数 | `6` | `4` 或 `8` |

### 板块过滤参数

| 参数 | 说明 | 示例 |
|------|------|------|
| `--exclude-boards` | 排除板块 | `gem`(创业板) `star`(科创板) `bj`(北交所) |

## 🎯 常用场景

### 场景1：抓取全量数据（2024年至今）

```bash
export TUSHARE_TOKEN="你的token"
python3 fetch_kline.py \
    --start 20240101 \
    --end today \
    --stocklist stocklist.csv \
    --out ./data \
    --workers 6
```

### 场景2：抓取全量数据（排除创业板和科创板）

```bash
export TUSHARE_TOKEN="你的token"
python3 fetch_kline.py \
    --start 20240101 \
    --end today \
    --stocklist stocklist.csv \
    --exclude-boards gem star \
    --out ./data \
    --workers 6
```

### 场景3：抓取指定日期范围

```bash
export TUSHARE_TOKEN="你的token"
python3 fetch_kline.py \
    --start 20230101 \
    --end 20241231 \
    --stocklist stocklist.csv \
    --out ./data \
    --workers 8
```

### 场景4：只抓取测试股票（快速测试）

```bash
export TUSHARE_TOKEN="你的token"
python3 fetch_kline.py \
    --start 20240101 \
    --end today \
    --stocklist test_stocklist.csv \
    --out ./data \
    --workers 4
```

### 场景5：抓取指定股票代码（补抓超时股票）

```bash
# 方法1：直接使用--codes参数
export TUSHARE_TOKEN="你的token"
python3 fetch_kline.py \
    --start 20240101 \
    --end today \
    --codes "000001 000002 600000 300001" \
    --out ./data \
    --workers 3

# 方法2：使用便捷脚本（已包含所有超时股票）
export TUSHARE_TOKEN="你的token"
./fetch_timeout_stocks.sh
```

**注意**：
- `--codes` 参数优先级高于 `--stocklist`
- 股票代码用空格分隔
- 降低并发数（如3-4）可以减少超时
- 适合补抓少量失败的股票

## ⚙️ 性能优化

### 并发数设置

- **低并发（4线程）**：适合网络不稳定或token权限较低
- **中并发（6线程）**：默认值，平衡速度和稳定性
- **高并发（8-10线程）**：适合网络稳定且token权限高

⚠️ **注意**：并发数过高可能导致被限流，建议从6开始逐步增加

### 日期范围选择

- **短期数据（1年）**：速度快，适合策略测试
- **中期数据（2-3年）**：平衡数据量和速度
- **长期数据（5年+）**：数据完整，但耗时较长

## 📊 数据说明

### 数据格式

每个股票生成一个CSV文件，格式如下：

```csv
date,open,close,high,low,volume
2024-01-02,16.1,16.14,16.44,16.05,28867.0
2024-01-03,16.13,16.3,16.3,15.9,30331.0
...
```

### 数据特点

- ✅ **前复权数据**：使用qfq（前复权）处理
- ✅ **日线数据**：每日一条记录
- ✅ **自动去重**：相同日期只保留一条
- ✅ **全量覆盖**：每次运行会覆盖已有数据

## 🔍 检查数据

### 查看已下载的股票数量

```bash
ls -1 data/*.csv | wc -l
```

### 查看数据日期范围

```bash
# 查看某只股票的数据范围
head -1 data/000001.csv
tail -1 data/000001.csv
```

### 检查数据完整性

```python
import pandas as pd
from pathlib import Path

data_dir = Path("./data")
files = list(data_dir.glob("*.csv"))
print(f"总文件数: {len(files)}")

# 检查数据完整性
for f in files[:10]:  # 检查前10个
    df = pd.read_csv(f)
    print(f"{f.stem}: {len(df)} 条记录, 日期范围: {df['date'].min()} ~ {df['date'].max()}")
```

## ⚠️ 注意事项

### 1. Token设置

- 确保TUSHARE_TOKEN环境变量已设置
- Token需要有足够的权限（积分）
- 免费用户有调用频率限制

### 2. 网络问题

- 如果遇到限流，脚本会自动等待并重试
- 建议在网络稳定时运行
- 大量数据抓取可能需要数小时

### 3. 数据更新

- 每次运行会**覆盖**已有数据
- 建议定期更新（如每周更新一次）
- 更新时只需设置`--end today`即可

### 4. 磁盘空间

- 每只股票约20KB（1年数据）
- 5000只股票约需要100MB
- 5年数据约需要500MB

## 🐛 常见问题

### Q1: 提示"请先设置环境变量 TUSHARE_TOKEN"

**解决方法**：
```bash
export TUSHARE_TOKEN="你的token"
# 或者
TUSHARE_TOKEN="你的token" python3 fetch_kline.py ...
```

### Q2: 遇到"访问频繁"或"429"错误

**解决方法**：
- 降低并发数：`--workers 4`
- 等待一段时间后重试
- 检查token积分是否充足

### Q3: 部分股票下载失败

**解决方法**：
- 检查股票代码是否正确
- 某些股票可能已退市
- 重新运行脚本会自动重试失败的股票
- 使用`--codes`参数单独抓取失败的股票：
  ```bash
  python3 fetch_kline.py --codes "000001 000002" --workers 3
  ```

### Q4: 数据不完整

**解决方法**：
- 检查日期范围是否正确
- 某些股票可能上市时间较晚
- 重新运行会覆盖并更新数据

## 📈 预计时间

| 股票数量 | 并发数 | 预计时间 |
|---------|--------|---------|
| 200只 | 6 | 5-10分钟 |
| 1000只 | 6 | 30-60分钟 |
| 5000只 | 6 | 2-4小时 |
| 5000只 | 4 | 3-5小时 |

*注：实际时间取决于网络速度和API限制*

## 🎯 下一步

数据抓取完成后，可以：

1. **运行选股测试**：
   ```bash
   python3 test_breakout_strategy.py --data-dir ./data
   ```

2. **运行回测**：
   ```bash
   python3 backtest.py
   ```

3. **查看数据统计**：
   ```bash
   python3 -c "from pathlib import Path; print(f'已下载: {len(list(Path(\"./data\").glob(\"*.csv\")))} 只股票')"
   ```

---

**祝你数据抓取顺利！** 📊

