# 📊 战法回测功能说明

## 🎯 功能概述

系统自动识别B1买入和S1卖出信号，模拟交易过程，计算收益率和统计指标。

---

## 🔄 回测逻辑

### 交易规则
```
1. B1信号出现 → 开仓买入
2. 持仓期间等待S1信号
3. S1信号出现 → 平仓卖出
4. 计算本次交易收益率
5. 继续等待下一个B1信号
```

### 配对逻辑
```
时间线: ---B1---B2---S1---B1---S1---B1---[持仓中]

交易1: B1买入 → S1卖出 ✅（完整交易）
交易2: B1买入 → S1卖出 ✅（完整交易）
交易3: B1买入 → 持仓中 ⏳（未平仓，用最新价计算浮盈）

注意: B2加仓暂不处理（简化模型）
```

---

## 📊 统计指标

### 1. 交易次数
- 完整交易数（B1→S1配对成功）
- 包含未平仓持仓

### 2. 胜率
```
胜率 = (盈利交易数 / 总交易数) × 100%

示例：
- 总交易: 10笔
- 盈利: 6笔
- 胜率: 60%
```

### 3. 平均收益
```
平均收益 = 所有交易收益率的平均值

示例：
- 交易1: +5%
- 交易2: -2%
- 交易3: +8%
平均收益 = (5 + (-2) + 8) / 3 = 3.67%
```

### 4. 累计收益
```
累计收益 = 复利计算的总收益

公式：
初始资金 1000元
交易1: +5% → 1050元
交易2: -2% → 1029元
交易3: +8% → 1111.32元
累计收益 = (1111.32 - 1000) / 1000 = 11.13%
```

### 5. 最大回撤
```
最大回撤 = 从最高点到最低点的最大跌幅

示例：
累计收益曲线：0% → 5% → 3% → 11% → 8% → 15%
                      ↓ 最大回撤
最大回撤 = 11% - 3% = 8%
```

---

## 📈 回测报告示例

### 优秀案例（胜率高）
```
📊 603027 回测报告（B1买入 → S1卖出）

交易次数: 8笔
胜率: 75% (6胜2负)
平均收益: +5.2%
累计收益: +45.8%
最大回撤: -8.3%

交易明细：
#1: 2025-06-15 买¥10.50 → 2025-06-25 卖¥11.20 = +6.67%
#2: 2025-07-05 买¥11.00 → 2025-07-12 卖¥10.80 = -1.82%
#3: 2025-07-20 买¥11.50 → 2025-07-28 卖¥12.30 = +6.96%
... 共8笔交易

评价：✅ 优秀战法，胜率高，累计收益强劲
```

### 一般案例（胜率中等）
```
📊 600123 回测报告

交易次数: 5笔
胜率: 60% (3胜2负)
平均收益: +2.1%
累计收益: +10.8%
最大回撤: -5.2%

评价：⚠️ 一般战法，胜率尚可，需结合其他指标
```

### 较差案例（胜率低）
```
📊 002456 回测报告

交易次数: 6笔
胜率: 33% (2胜4负)
平均收益: -1.5%
累计收益: -8.7%
最大回撤: -15.3%

评价：❌ 该股不适合此战法，建议观望
```

---

## 🎨 前端显示

### 统计卡片
```
┌─────────────────────────────────────────────┐
│  交易次数  │  胜率   │  平均收益 │ 累计收益 │ 最大回撤 │
│    8      │  75%   │  +5.2%  │ +45.8% │  -8.3%  │
│           │ 6胜2负  │         │        │         │
└─────────────────────────────────────────────┘
```

### 交易明细表
```
┌──┬───────────┬────────┬───────────┬────────┬────────┬────────┐
│# │ 买入日期   │ 买入价 │ 卖出日期   │ 卖出价 │ 收益率 │ 持有   │
├──┼───────────┼────────┼───────────┼────────┼────────┼────────┤
│1 │2025-06-15│ ¥10.50 │2025-06-25│ ¥11.20 │ +6.67% │ 10天   │
│2 │2025-07-05│ ¥11.00 │2025-07-12│ ¥10.80 │ -1.82% │ 7天    │
│3 │2025-07-20│ ¥11.50 │2025-07-28│ ¥12.30 │ +6.96% │ 8天    │
└──┴───────────┴────────┴───────────┴────────┴────────┴────────┘
```

---

## 💡 回测结果解读

### 胜率解读
```
✅ ≥70%：优秀，战法在该股上效果很好
⭐ 60-70%：良好，可以考虑买入
⚠️ 50-60%：一般，需要谨慎
❌ <50%：较差，不建议买入
```

### 累计收益解读
```
🎉 ≥30%：非常好，显著跑赢大盘
✅ 10-30%：良好，值得持有
⚠️ 0-10%：一般，勉强盈利
❌ <0%：亏损，战法失效
```

### 最大回撤解读
```
✅ <10%：风险可控
⚠️ 10-20%：中等风险
❌ >20%：高风险，心理压力大
```

### 综合评价
```
最佳组合：
  胜率≥70% + 累计收益≥30% + 最大回撤<10%
  → 🌟🌟🌟🌟🌟 五星推荐

良好组合：
  胜率≥60% + 累计收益≥15% + 最大回撤<15%
  → ⭐⭐⭐⭐ 四星推荐

谨慎组合：
  胜率≥50% + 累计收益≥5%
  → ⭐⭐⭐ 三星，可尝试小仓位

不推荐：
  胜率<50% 或 累计收益<0%
  → ❌ 不推荐
```

---

## 🔍 使用方法

### 查看回测结果
```
1. 打开 http://127.0.0.1:5000
2. 点击【出坑战法】
3. 点击任意股票
4. 在K线图下方查看【回测报告】
5. 分析统计指标和交易明细
```

### 对比多只股票
```
1. 查看股票A的回测结果
2. 记录胜率、累计收益
3. 查看股票B的回测结果
4. 对比选择最佳标的
```

---

## ⚠️ 注意事项

### 1. 回测局限性
```
✅ 优点：
  - 快速验证战法有效性
  - 提供量化参考数据
  - 帮助筛选优质标的

❌ 局限：
  - 基于历史数据，不代表未来
  - 未考虑滑点和手续费
  - 未考虑市场流动性
  - 信号可能有滞后性
```

### 2. 实盘差异
```
回测假设：
  - B1信号当日收盘价买入
  - S1信号当日收盘价卖出
  - 忽略滑点（实际会有1-2%）
  - 忽略手续费（买0.03%+卖0.13%）

实盘修正：
  - 实际收益需要扣除1-2%交易成本
  - 示例：回测+10% → 实盘约+8%
```

### 3. 信号质量
```
⚠️ 如果回测交易次数<3：
  → 样本量太小，参考价值有限
  → 建议拉长回测周期（增加days参数）

⚠️ 如果没有完整交易：
  → 显示"暂无完整交易"
  → 可能该股最近没有明显的B1/S1信号
```

---

## 🛠️ 高级功能（未来）

### 待开发功能
```
□ B2加仓逻辑
□ 止损机制（跌破B1最低价）
□ 手续费计算
□ 滑点模拟
□ 资金管理（Kelly公式）
□ 风险收益比分析
□ 月度/年度收益统计
□ 收益曲线图
□ 回撤曲线图
```

---

## 📊 API接口

### 获取回测数据
```javascript
// 请求
GET /api/stock/603027?days=120

// 响应
{
  "success": true,
  "code": "603027",
  "backtest": {
    "total_trades": 8,
    "win_rate": 75.0,
    "avg_return": 5.2,
    "total_return": 45.8,
    "max_drawdown": 8.3,
    "win_count": 6,
    "loss_count": 2,
    "trades": [
      {
        "buy_date": "2025-06-15",
        "buy_price": 10.50,
        "sell_date": "2025-06-25",
        "sell_price": 11.20,
        "return_pct": 6.67,
        "days_held": 10
      },
      ...
    ]
  }
}
```

---

## 📚 延伸阅读

- [B1交易体系快速指南.md](B1交易体系快速指南.md)
- [交易信号系统说明.md](交易信号系统说明.md)
- [知行体系趋势线说明.md](知行体系趋势线说明.md)

---

**更新时间**：2025-11-21 23:50  
**版本**：v1.0 回测功能  
**祝你选股顺利！** 📈✨

