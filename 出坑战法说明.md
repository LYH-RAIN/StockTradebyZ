# 出坑战法（突破前高战法）- 完整说明文档

## 📋 目录
1. [战法概述](#战法概述)
2. [核心理念](#核心理念)
3. [形态识别](#形态识别)
4. [买入时机](#买入时机)
5. [技术实现](#技术实现)
6. [参数说明](#参数说明)
7. [使用示例](#使用示例)
8. [风险控制](#风险控制)
9. [实战技巧](#实战技巧)

---

## 🎯 战法概述

**出坑战法**（BreakoutPreviousHighSelector）是一种捕捉"调整后二次启动"机会的量化选股策略。

### 核心思想
```
前高突破 + 放量确认 = 二次启动信号
```

### 适用场景
- ✅ 震荡市场中的强势股回调
- ✅ 牛市初期的龙头股整理
- ✅ 主力洗盘后的拉升前夜
- ❌ 不适合单边下跌的弱势股
- ❌ 不适合长期横盘的僵尸股

---

## 💡 核心理念

### 市场逻辑

股票在创出新高后往往会经历：
1. **获利回吐**：早期买入者获利了结
2. **主力洗盘**：清理浮筹，降低拉升成本
3. **平台整理**：在关键均线附近震荡
4. **再次启动**：放量突破前高，开启新一轮上涨

### 为什么有效？

**心理学角度**：
- 前高是重要的心理关口
- 突破前高意味着打破套牢盘压力
- 放量突破说明新资金积极介入

**技术面角度**：
- 平台整理期间筹码换手充分
- 均线系统收敛形成"势能积累"
- 缩量震荡说明抛压减轻
- 放量突破是主力发动信号

---

## 🔍 形态识别

### 完整走势结构

```
价格
 ^
 |        ①前高          ④放量突破
 |         /\             /↗
 |        /  \           /
 |       /    \    ③横盘 /
 |      /      \  ______ /
 |     /        \/      
 |    /         ②回调
 |   /
 |__/________________________> 时间
   拉升期  |  震荡期  | 突破期
```

### 关键阶段详解

#### 阶段①：第一波拉升
```python
特征：
- 股价从底部快速上涨
- 创出阶段性新高
- 成交量放大明显
- 至少上涨10%以上

识别方法：
使用 scipy.signal.find_peaks 检测峰值
要求峰值之间至少相隔5日
峰值显著性（prominence）≥ 0.02
```

#### 阶段②：高位回调
```python
特征：
- 从前高回落5%-25%
- 不破坏上升趋势
- 回调有底（不能无限下跌）

检查方法：
pullback_pct = (前高 - 震荡期最低) / 前高
要求：0.05 ≤ pullback_pct ≤ 0.25
```

#### 阶段③：平台震荡
```python
特征：
- 股价在短期均线(MA5/MA10)和长期均线(MA20/MA30)之间震荡
- 震荡时间：5-30个交易日
- 成交量逐步萎缩（相对拉升期）
- 至少60%的时间在长期均线上方

均线系统：
MA5/MA10：短期压力线
MA20/MA30：长期支撑线
震荡区间：在两组均线之间反复
```

#### 阶段④：放量突破
```python
特征：
- 当日成交量突然放大（量比≥2）
- 股价快速接近前高（95%-100%）
- 突破短期均线压力
- 换手率明显提升

买点：
- 突破确认点：接近前高95%以上
- 当日收盘价在前高附近（±5%以内）
```

---

## ⏰ 买入时机

### 最佳进场点

#### 时机1：突破确认点（推荐）
```
条件：
✓ 当日放量突破短期均线（MA5/MA10）
✓ 股价接近前高的95%-100%位置
✓ 量比 ≥ 2.0
✓ 分时图呈现强势上攻态势

进场时间：
- 9:35-10:00: 开盘后放量突破，确认强势
- 10:00-10:30: 回踩短期均线不破，二次上攻
```

#### 时机2：突破后回踩（安全）
```
条件：
✓ 已突破前高
✓ 回踩前高不破（前高变支撑）
✓ 短期均线拐头向上

进场时间：
- 突破后1-3日内回踩
- 回踩不破前高位置
```

### 买入信号确认清单

**必备条件（全部满足）：**
```
□ 放量突破：成交量较震荡期放大2倍以上
□ 价格位置：股价接近前高，距离前高15%以内
□ 均线支撑：短期均线拐头向上，长期均线托底
□ 回调适中：从前高回调5%-25%
□ 震荡充分：整理时间5-30日
```

**加分项（满足越多越好）：**
```
□ 大盘同步走强，市场氛围良好
□ 所属板块有热点题材支撑
□ 个股有利好消息或资金持续流入
□ K线形态为大阳线或涨停板
□ 均线形成金叉或多头排列
□ 突破日换手率≥5%
```

---

## 💻 技术实现

### 核心算法流程

```python
def _passes_filters(self, hist: pd.DataFrame) -> bool:
    """
    完整筛选流程
    """
    # Step 1: 基础检查
    if 数据不足 or 不满足统一当日过滤:
        return False
    
    # Step 2: 寻找前高
    前高信息 = _find_previous_high(hist)
    if 前高信息 is None:
        return False
    
    # Step 3: 检查回调幅度
    回调幅度 = (前高 - 震荡期最低) / 前高
    if 回调幅度 < 5% or 回调幅度 > 25%:
        return False
    
    # Step 4: 检查震荡整理
    震荡信息 = _check_consolidation_phase(hist, 前高位置)
    if 震荡信息 is None:  # 震荡不充分
        return False
    
    # Step 5: 检查当日接近前高
    if 当日距离前高 > 15%:
        return False
    
    # Step 6: 检查放量突破
    量比 = 当日成交量 / 震荡期平均成交量
    if 量比 < 2.0:
        return False
    
    # Step 7: 检查缩量震荡
    缩量比 = 震荡期平均量 / 拉升期平均量
    if 缩量比 > 0.6:  # 震荡期未明显缩量
        return False
    
    # Step 8: 检查均线系统
    if 短期均线未向上 or 价格未在长期均线上方:
        return False
    
    # Step 9: 知行约束
    if not (收盘>长期线 and 短期线>长期线):
        return False
    
    return True
```

### 关键函数详解

#### 1. `_find_previous_high()` - 前高识别

```python
def _find_previous_high(self, hist: pd.DataFrame) -> Optional[Dict]:
    """
    在回看窗口内寻找前期高点
    
    算法：
    1. 取最近lookback_days天（排除最近5日）
    2. 使用scipy.signal.find_peaks检测峰值
    3. 选择最高的峰值作为前高
    
    参数：
    - distance=5: 峰值间隔至少5日
    - prominence=0.5: 峰值显著性阈值
    
    返回：
    {
        'high_price': 前高价格,
        'high_idx': 前高位置(iloc),
        'high_date': 前高日期
    }
    """
    # 在lookback_days窗口内寻找（排除最近5日）
    window = hist.iloc[-(self.lookback_days + 5):-5]
    
    # 使用scipy检测峰值
    peaks_df = _find_peaks(
        window, 
        column="high",
        distance=5,      # 峰值间隔
        prominence=0.5   # 显著性
    )
    
    if peaks_df.empty:
        # 没有显著峰值，使用最高价
        max_idx = window["high"].idxmax()
    else:
        # 选择最高的峰值
        highest_peak = peaks_df.nlargest(1, "high").iloc[0]
        max_idx = highest_peak.name
    
    return {
        'high_price': float(window.loc[max_idx, 'high']),
        'high_idx': hist.index.get_loc(max_idx),
        'high_date': window.loc[max_idx, 'date']
    }
```

#### 2. `_check_consolidation_phase()` - 震荡期检查

```python
def _check_consolidation_phase(
    self, 
    hist: pd.DataFrame, 
    high_idx: int
) -> Optional[Dict]:
    """
    检查是否存在有效的震荡整理阶段
    
    检查项：
    1. 震荡时间：5-30个交易日
    2. 价格位置：至少60%时间在长期均线上方
    3. 成交量：计算震荡期平均量
    
    返回：
    {
        'consol_start_idx': 震荡开始位置,
        'consol_end_idx': 震荡结束位置,
        'avg_volume': 震荡期平均成交量
    }
    """
    # 从前高之后到当日前一日
    consol_seg = hist.iloc[high_idx + 1 : -1]
    
    # 检查震荡时间
    if len(consol_seg) < self.consolidation_min_days:
        return None
    if len(consol_seg) > self.consolidation_max_days:
        consol_seg = consol_seg.iloc[-self.consolidation_max_days:]
    
    # 计算均线
    consol_seg['MA5'] = consol_seg['close'].rolling(5).mean()
    consol_seg['MA10'] = consol_seg['close'].rolling(10).mean()
    consol_seg['MA20'] = consol_seg['close'].rolling(20).mean()
    consol_seg['MA30'] = consol_seg['close'].rolling(30).mean()
    
    # 检查价格位置
    long_ma = consol_seg[['MA20', 'MA30']].max(axis=1)
    above_long_ma_ratio = (
        consol_seg['close'] >= long_ma * 0.98
    ).sum() / len(consol_seg)
    
    if above_long_ma_ratio < 0.6:  # 至少60%在长期均线上方
        return None
    
    return {
        'consol_start_idx': hist.index.get_loc(consol_seg.index[0]),
        'consol_end_idx': hist.index.get_loc(consol_seg.index[-1]),
        'avg_volume': float(consol_seg['volume'].mean())
    }
   ```

---

## ⚙️ 参数说明

### 配置文件 (configs.json)

```json
{
  "class": "BreakoutPreviousHighSelector",
  "alias": "出坑战法",
  "activate": true,
  "params": {
    "lookback_days": 60,              // 前高查找窗口（60个交易日）
    "consolidation_min_days": 5,      // 震荡整理最小天数
    "consolidation_max_days": 30,     // 震荡整理最大天数
    "approach_pct": 0.15,             // 接近前高的最大距离（15%）
    "vol_ratio_threshold": 2.0,       // 突破日量比阈值（2倍）
    "turnover_threshold": 0.05,       // 换手率阈值（5%）
    "consolidation_shrink_ratio": 0.6, // 震荡期缩量比例（60%）
    "pullback_pct_min": 0.05,         // 回调幅度下限（5%）
    "pullback_pct_max": 0.25,         // 回调幅度上限（25%）
    "ma_converge_threshold": 0.05,    // 均线收敛阈值（5%）
    "max_window": 120                 // 最大回看窗口
  }
}
```

### 参数详解

#### `lookback_days` - 前高查找窗口
```
默认值：60
范围：20-120
说明：在最近N个交易日内寻找前高
调整建议：
  - 短线操作：30-40天
  - 中线操作：60-80天（推荐）
  - 长线操作：80-120天
```

#### `consolidation_min_days` / `consolidation_max_days`
```
默认值：5-30天
说明：震荡整理的时间窗口
调整建议：
  - 激进型：3-20天（捕捉更多机会）
  - 稳健型：10-40天（确保充分整理）
  - 超短线：3-10天
```

#### `approach_pct` - 接近前高距离
```
默认值：0.15（15%）
范围：0.05-0.25
说明：当日价格距离前高的最大允许距离
调整建议：
  - 保守型：0.05-0.10（更接近前高）
  - 中性：0.10-0.15（推荐）
  - 激进型：0.15-0.25（更早介入）
```

#### `vol_ratio_threshold` - 量比阈值
```
默认值：2.0（2倍）
范围：1.5-3.0
说明：突破日成交量相对震荡期的倍数
调整建议：
  - 宽松：1.5-1.8（捕捉更多）
  - 标准：2.0-2.5（推荐）
  - 严格：2.5-3.0（更强突破）
```

#### `consolidation_shrink_ratio` - 缩量比例
```
默认值：0.6（60%）
范围：0.4-0.8
说明：震荡期平均量 / 拉升期平均量
调整建议：
  - 严格：0.4-0.5（要求强烈缩量）
  - 中等：0.5-0.7（推荐）
  - 宽松：0.7-0.8（允许温和缩量）
```

#### `pullback_pct_min` / `pullback_pct_max`
```
默认值：5%-25%
说明：从前高回调的幅度范围
调整建议：
  - 强势股：3%-15%
  - 一般股：5%-25%（推荐）
  - 弱势股：10%-30%
```

### 参数调优场景

#### 场景1：牛市环境
```json
{
  "approach_pct": 0.20,              // 放宽接近距离
  "vol_ratio_threshold": 1.8,        // 降低量比要求
  "consolidation_min_days": 3,       // 缩短整理时间
  "pullback_pct_max": 0.20           // 允许更浅回调
}
```

#### 场景2：震荡市
```json
{
  "approach_pct": 0.10,              // 要求更接近前高
  "vol_ratio_threshold": 2.5,        // 提高量比要求
  "consolidation_min_days": 10,      // 延长整理时间
  "consolidation_shrink_ratio": 0.5  // 要求更强缩量
}
```

#### 场景3：熊市环境
```json
{
  "approach_pct": 0.05,              // 严格要求接近前高
  "vol_ratio_threshold": 3.0,        // 大幅提高量比
  "consolidation_max_days": 20,      // 缩短最大整理时间
  "pullback_pct_min": 0.10           // 至少10%回调
}
```

---

## 📖 使用示例

### 基础使用

```bash
# 1. 确保配置文件中已激活出坑战法
cat configs.json | grep -A 15 "出坑战法"

# 2. 运行选股
python select_stock.py --date 2025-09-10

# 3. 查看结果
tail -f select_results.log | grep "出坑战法"
```

### 单独运行出坑战法

```python
# test_breakout.py
from pathlib import Path
import pandas as pd
from Selector import BreakoutPreviousHighSelector
from select_stock import load_data

# 1. 初始化选择器
selector = BreakoutPreviousHighSelector(
    lookback_days=60,
    consolidation_min_days=5,
    consolidation_max_days=30,
    approach_pct=0.15,
    vol_ratio_threshold=2.0,
    turnover_threshold=0.05,
    consolidation_shrink_ratio=0.6,
    pullback_pct_min=0.05,
    pullback_pct_max=0.25,
    ma_converge_threshold=0.05,
    max_window=120
)

# 2. 加载数据
data_dir = Path("./data")
codes = [f.stem for f in data_dir.glob("*.csv")][:100]  # 测试100只
data = load_data(data_dir, codes)

# 3. 执行选股
trade_date = pd.Timestamp("2025-09-10")
picks = selector.select(trade_date, data)

# 4. 输出结果
print(f"出坑战法选中：{len(picks)}只")
print("股票代码：", ", ".join(picks))
```

### 参数测试脚本

```python
# param_test.py
"""测试不同参数组合的效果"""

param_sets = [
    {"name": "保守型", "vol_ratio_threshold": 2.5, "approach_pct": 0.10},
    {"name": "标准型", "vol_ratio_threshold": 2.0, "approach_pct": 0.15},
    {"name": "激进型", "vol_ratio_threshold": 1.8, "approach_pct": 0.20},
]

for params in param_sets:
    selector = BreakoutPreviousHighSelector(
        vol_ratio_threshold=params["vol_ratio_threshold"],
        approach_pct=params["approach_pct"]
    )
    
    picks = selector.select(trade_date, data)
    print(f"{params['name']}：选中{len(picks)}只")
```

---

## 🛡️ 风险控制

### 止损策略

#### 止损位设置（重要！）

```
严格止损三原则：

1. 价格止损
   - 买入后跌破短期均线(MA5/MA10) → 止损
   - 止损幅度：-3% 至 -5%
   - 跌破长期均线果断清仓

2. 时间止损
   - 买入后3日内不涨反跌 → 考虑止损
   - 突破后5日内未突破前高 → 减仓观察

3. 形态止损
   - 出现长上影线 → 警惕
   - 放量下跌 → 立即止损
   - 跌破前高支撑 → 果断离场
```

#### 止损示例

```python
# 实盘止损监控
def check_stop_loss(buy_price, current_data):
    """
    检查是否触发止损
    """
    current_price = current_data['close'].iloc[-1]
    ma5 = current_data['close'].rolling(5).mean().iloc[-1]
    ma10 = current_data['close'].rolling(10).mean().iloc[-1]
    
    # 止损条件1：跌幅超过5%
    loss_pct = (current_price - buy_price) / buy_price
    if loss_pct <= -0.05:
        return True, "跌幅止损：-5%"
    
    # 止损条件2：跌破MA5和MA10
    if current_price < ma5 and current_price < ma10:
        return True, "跌破短期均线"
    
    # 止损条件3：当日放量下跌
    vol_today = current_data['volume'].iloc[-1]
    vol_avg = current_data['volume'].iloc[-5:-1].mean()
    if vol_today > vol_avg * 1.5 and current_price < current_data['close'].iloc[-2]:
        return True, "放量下跌"
    
    return False, "持仓"

# 使用
should_stop, reason = check_stop_loss(buy_price=10.0, current_data=df)
if should_stop:
    print(f"触发止损：{reason}")
```

### 止盈策略

#### 分批止盈（推荐）

```
三段式止盈：

第一目标：前高 + 5%
  → 卖出30%仓位
  → 锁定部分利润

第二目标：前高 + 10%
  → 卖出40%仓位
  → 落袋为安

第三目标：前高 + 15%以上
  → 卖出剩余30%
  → 或移动止盈
```

#### 动态止盈

```python
def check_take_profit(buy_price, current_data, high_after_buy):
    """
    动态止盈检查
    """
    current_price = current_data['close'].iloc[-1]
    profit_pct = (current_price - buy_price) / buy_price
    
    # 利润回撤止盈
    if high_after_buy > 0:
        drawdown = (high_after_buy - current_price) / high_after_buy
        if profit_pct > 0.10 and drawdown > 0.30:
            return True, "利润回撤30%，止盈"
    
    # 滞涨止盈
    last_5_days = current_data.iloc[-5:]
    if (last_5_days['close'].max() == current_price and
        last_5_days['volume'].iloc[-1] < last_5_days['volume'].mean()):
        return True, "缩量滞涨，止盈"
    
    return False, "继续持有"
```

### 仓位管理

```
建议仓位配置：

单只股票：
  - 保守型：≤5%
  - 中性：5%-10%
  - 激进型：10%-15%

总仓位：
  - 熊市：≤30%
  - 震荡市：30%-50%
  - 牛市：50%-70%

分批建仓：
  第一批：40%（突破确认）
  第二批：30%（回踩不破）
  第三批：30%（趋势确立）
```

---

## 🎓 实战技巧

### 真假突破识别

#### 真突破特征✅

```
1. 量能特征
   ✓ 放量明显：量比≥2，换手率≥5%
   ✓ 持续放量：突破后连续3日量能维持
   
2. 价格特征
   ✓ 突破果断：不拖泥带水
   ✓ 不回头：突破后不跌回前高下方
   ✓ 收盘价在前高上方或接近前高
   
3. 形态特征
   ✓ K线实体大：大阳线或涨停
   ✓ 上影线短：上攻意愿强
   ✓ 次日继续上攻
   
4. 均线特征
   ✓ 短期均线金叉
   ✓ 均线多头排列或即将形成
```

#### 假突破特征❌

```
1. 量能不足
   ✗ 缩量冲高：量比<1.5
   ✗ 换手率低：<3%
   
2. 价格回落
   ✗ 冲高回落：上影线长
   ✗ 突破后快速回落：跌回前高下方
   
3. 形态恶化
   ✗ 次日缩量下跌
   ✗ 十字星或阴线
   
4. 均线压制
   ✗ 均线空头排列
   ✗ 短期均线向下
```

### 最佳买入时间点

```
时间段        特征                    风险等级
────────────────────────────────────────────
9:35-10:00   开盘放量突破            中等
             确认强势，追高风险

10:00-10:30  回踩不破再次上攻        较低 ✓推荐
             相对安全，价格更优

13:30-14:00  午后继续放量            中等
             确认有效，追高风险

14:00-14:30  尾盘拉升                较高
             可能是诱多，谨慎

隔日买入     回踩前高不破            低 ✓最安全
             最安全，但可能追空
```

### 配合其他指标

#### 配合MACD
```python
# 突破时MACD金叉或即将金叉
hist_with_macd = compute_dif(hist)
dif = hist_with_macd.iloc[-1]

if dif > 0:
    # MACD多头，加分
    confidence += 1
```

#### 配合RSI
```python
# RSI在40-70之间最佳
rsi = compute_rsi(hist, 14)
rsi_today = rsi.iloc[-1]

if 40 <= rsi_today <= 70:
    # RSI适中，既不超买也不超卖
    confidence += 1
```

#### 配合成交量
```python
# 检查量能连续性
last_3_days_vol = hist['volume'].iloc[-3:]
if (last_3_days_vol > last_3_days_vol.mean()).all():
    # 连续3日放量
    confidence += 1
```

### 操作纪律

```
三看原则：
  ✓ 看量能：放量是突破的必要条件
  ✓ 看位置：必须接近前高，不能距离太远
  ✓ 看趋势：均线系统必须向上

三不做原则：
  ✗ 不做缩量突破：量能不足的突破不参与
  ✗ 不做远离前高：距离前高超过20%的不做
  ✗ 不做破位股票：跌破长期均线的不做

三必做原则：
  ✓ 做错立即止损：不抱幻想，严格执行
  ✓ 分批止盈：不贪心，落袋为安
  ✓ 跟踪记录：每笔交易做复盘分析
```

---

## 📊 案例分析

### 案例1：标准突破形态

```
股票代码：600XXX（示例）
选中日期：2025-08-20

形态特征：
  前高：15.50元（2025-07-10）
  回调低点：13.20元（2025-07-28）
  震荡期：18个交易日
  突破日：2025-08-20
  突破价：15.30元

技术指标：
  量比：2.3
  换手率：6.8%
  回调幅度：14.8%
  震荡期缩量：拉升期的52%

均线系统：
  MA5: 14.80 ↗
  MA10: 14.50 ↗
  MA20: 14.00 →
  MA30: 13.80 →
  排列：即将形成多头排列

操作建议：
  买入：15.30元
  止损：14.50元（-5.2%）
  目标1：16.28元（+6.4%）→ 卖出30%
  目标2：16.83元（+10%）→ 卖出40%
  目标3：17.60元（+15%）→ 卖出30%

后续走势：
  T+1: 15.80元（+3.3%）
  T+3: 16.50元（+7.8%）达到目标1
  T+7: 17.20元（+12.4%）达到目标2
  T+12: 18.50元（+20.9%）超预期上涨
```

### 案例2：假突破陷阱

```
股票代码：000XXX（示例）
日期：2025-08-15

形态特征：
  前高：10.00元
  突破日：9.85元（距离前高1.5%）
  
问题诊断：
  ✗ 量比只有1.4（不足2.0）
  ✗ 换手率2.8%（不足5%）
  ✗ 当日收长上影线
  ✗ 次日缩量下跌

结果：
  假突破，次日回落至9.40元
  
教训：
  - 量能不足的突破不可信
  - 必须等待充分放量确认
  - 长上影线是警告信号
```

---

## ⚠️ 注意事项

### 市场环境影响

```
适合：
  ✓ 震荡市后期（蓄势待发）
  ✓ 牛市初期（龙头股补涨）
  ✓ 板块轮动（强势股调整）

不适合：
  ✗ 单边下跌（趋势向下）
  ✗ 大盘崩盘（系统性风险）
  ✗ 个股利空（基本面恶化）
```

### 板块选择

```
优选板块：
  ✓ 热点板块的龙头股
  ✓ 有政策支持的行业
  ✓ 业绩持续增长的公司
  ✓ 资金持续流入的板块

回避板块：
  ✗ 下跌趋势的板块
  ✗ 题材炒作过度的板块
  ✗ 估值过高的板块
  ✗ 资金持续流出的板块
```

### 个股筛选

```
优选特征：
  ✓ 流通市值适中（30-200亿）
  ✓ 基本面良好（不亏损）
  ✓ 主力持仓集中
  ✓ 有题材或概念支撑

回避特征：
  ✗ ST、*ST股票
  ✗ 长期横盘的僵尸股
  ✗ 超跌反弹的垃圾股
  ✗ 高位套牢盘重的股票
```

---

## 📚 总结

### 优势

✅ **逻辑清晰**：前高突破是经典技术形态  
✅ **胜率较高**：充分整理后突破成功率高  
✅ **风险可控**：止损位明确，回撤可预期  
✅ **易于执行**：信号明确，操作简单  
✅ **适用广泛**：各类市场环境都有机会  

### 局限

⚠️ **假突破风险**：需要量价配合验证  
⚠️ **时间成本**：等待整理需要耐心  
⚠️ **大盘依赖**：系统性风险影响大  
⚠️ **参数敏感**：不同市场需调整参数  

### 适用人群

**适合：**
- 有一定技术分析基础的投资者
- 能够严格执行止损的纪律性强的交易者
- 关注中短线机会的波段操作者
- 有时间盯盘和及时决策的投资者

**不适合：**
- 完全不懂技术分析的新手
- 无法承受短期波动的保守投资者
- 没时间盯盘的上班族（建议用隔日买入法）
- 追求长期价值投资的投资者

---

## 🔧 调试与优化

### 查看选股详情

```python
# debug_breakout.py
selector = BreakoutPreviousHighSelector()

# 开启调试模式
import logging
logging.basicConfig(level=logging.DEBUG)

# 单只股票测试
code = "000001"
df = pd.read_csv(f"data/{code}.csv", parse_dates=['date'])
hist = df[df['date'] <= '2025-09-10']

# 逐步检查
print("Step 1: 基础检查")
print(f"  数据量：{len(hist)}")
print(f"  当日涨跌幅：{(hist.iloc[-1]['close']/hist.iloc[-2]['close']-1)*100:.2f}%")

print("\nStep 2: 前高识别")
prev_high = selector._find_previous_high(hist)
if prev_high:
    print(f"  前高价格：{prev_high['high_price']}")
    print(f"  前高日期：{prev_high['high_date']}")

print("\nStep 3: 震荡检查")
if prev_high:
    consol = selector._check_consolidation_phase(hist, prev_high['high_idx'])
    if consol:
        print(f"  震荡天数：{consol['consol_end_idx'] - consol['consol_start_idx']}")
        print(f"  平均成交量：{consol['avg_volume']:.0f}")

# 最终判断
result = selector._passes_filters(hist)
print(f"\n最终结果：{'✓ 符合' if result else '✗ 不符合'}")
```

### 批量回测

```python
# backtest_breakout.py
from datetime import datetime, timedelta
import pandas as pd

def backtest_strategy(start_date, end_date, hold_days=5):
    """
    回测出坑战法
    """
    selector = BreakoutPreviousHighSelector()
    
    results = []
    current = start_date
    
    while current <= end_date:
        # 执行选股
        picks = selector.select(current, data)
        
        # 计算收益
        for code in picks:
            df = data[code]
            buy_date = current
            sell_date = current + timedelta(days=hold_days)
            
            buy_price = df[df['date'] == buy_date]['close'].iloc[0]
            sell_price = df[df['date'] <= sell_date]['close'].iloc[-1]
            
            profit = (sell_price / buy_price - 1) * 100
            
            results.append({
                'code': code,
                'buy_date': buy_date,
                'buy_price': buy_price,
                'sell_price': sell_price,
                'profit_pct': profit
            })
        
        current += timedelta(days=1)
    
    # 统计分析
    df_results = pd.DataFrame(results)
    print(f"总交易次数：{len(df_results)}")
    print(f"平均收益：{df_results['profit_pct'].mean():.2f}%")
    print(f"胜率：{(df_results['profit_pct'] > 0).sum() / len(df_results) * 100:.2f}%")
    print(f"最大收益：{df_results['profit_pct'].max():.2f}%")
    print(f"最大亏损：{df_results['profit_pct'].min():.2f}%")
    
    return df_results
```

---

## 💬 常见问题

**Q1：为什么选出的股票很少？**
```
A：出坑战法要求较严格，需要同时满足多个条件。
   可以尝试：
   - 降低vol_ratio_threshold（如1.8）
   - 增大approach_pct（如0.20）
   - 缩短consolidation_min_days（如3）
```

**Q2：如何提高胜率？**
```
A：建议：
   1. 配合大盘走势，大盘上涨时操作
   2. 选择热点板块的龙头股
   3. 严格执行止损，不抱幻想
   4. 等待充分放量确认后再买入
```

**Q3：震荡期太长怎么办？**
```
A：超过consolidation_max_days的股票会被过滤。
   可以适当延长max_days（如40-50天），
   但要注意时间太长可能失去动能。
```

**Q4：假突破如何识别？**
```
A：关键看量能：
   - 量比必须≥2
   - 次日继续放量
   - 不能冲高回落
   - 建议突破后第二天再买入更安全
```

---

**⚠️ 风险提示**

本策略为技术分析方法，不构成投资建议。股市有风险，入市需谨慎。

使用本策略的注意事项：
1. 严格设置止损，控制单笔亏损在5%以内
2. 不要重仓单只股票，建议单只≤10%
3. 配合基本面分析，避开地雷股
4. 关注市场环境，系统性风险来临时空仓
5. 做好交易记录，定期复盘优化

---

## 📞 技术支持

如有问题或建议，欢迎通过以下方式联系：
- GitHub Issues: 提交问题或建议
- 邮件: your-email@example.com
- 微信群: 量化交流群

---

**更新日志**
- 2025-09-10: 初始版本发布
- 增加完整的形态识别逻辑
- 实现放量突破确认机制
- 添加知行约束
- 完善文档和参数说明
