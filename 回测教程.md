# é‡åŒ–ç­–ç•¥å›æµ‹å®Œæ•´æ•™ç¨‹

## ğŸ“‹ ç›®å½•
1. [å›æµ‹åŸºç¡€æ¦‚å¿µ](#å›æµ‹åŸºç¡€æ¦‚å¿µ)
2. [å¿«é€Ÿå¼€å§‹](#å¿«é€Ÿå¼€å§‹)
3. [è¯¦ç»†ä½¿ç”¨è¯´æ˜](#è¯¦ç»†ä½¿ç”¨è¯´æ˜)
4. [å‚æ•°é…ç½®è¯¦è§£](#å‚æ•°é…ç½®è¯¦è§£)
5. [ç»“æœåˆ†æ](#ç»“æœåˆ†æ)
6. [ä¼˜åŒ–å»ºè®®](#ä¼˜åŒ–å»ºè®®)
7. [å¸¸è§é—®é¢˜](#å¸¸è§é—®é¢˜)

---

## ğŸ¯ å›æµ‹åŸºç¡€æ¦‚å¿µ

### ä»€ä¹ˆæ˜¯å›æµ‹ï¼Ÿ

å›æµ‹ï¼ˆBacktestingï¼‰æ˜¯ä½¿ç”¨å†å²æ•°æ®æ¥æµ‹è¯•äº¤æ˜“ç­–ç•¥çš„è¿‡ç¨‹ï¼Œç›®çš„æ˜¯è¯„ä¼°ç­–ç•¥åœ¨è¿‡å»çš„è¡¨ç°ï¼Œä»è€Œåˆ¤æ–­å…¶æœªæ¥çš„æœ‰æ•ˆæ€§ã€‚

### ä¸ºä»€ä¹ˆè¦å›æµ‹ï¼Ÿ

```
âœ… éªŒè¯ç­–ç•¥æœ‰æ•ˆæ€§
âœ… è¯„ä¼°é£é™©æ”¶ç›Šæ¯”
âœ… ä¼˜åŒ–å‚æ•°é…ç½®
âœ… å»ºç«‹äº¤æ˜“ä¿¡å¿ƒ
âœ… é¿å…è¿‡åº¦æ‹Ÿåˆ
```

### å›æµ‹çš„å±€é™æ€§

```
âš ï¸ å†å²ä¸ä»£è¡¨æœªæ¥
âš ï¸ å¯èƒ½å­˜åœ¨è¿‡æ‹Ÿåˆ
âš ï¸ éš¾ä»¥æ¨¡æ‹ŸçœŸå®å¸‚åœºç¯å¢ƒ
âš ï¸ æ»‘ç‚¹å’Œä½£é‡‘å½±å“
âš ï¸ å¿ƒç†å› ç´ æ— æ³•æ¨¡æ‹Ÿ
```

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### æ­¥éª¤1ï¼šç¡®ä¿æ•°æ®å·²å‡†å¤‡å¥½

```bash
# é¦–å…ˆç¡®ä¿å·²ç»ä¸‹è½½äº†å†å²æ•°æ®
python fetch_kline.py --start 20240101 --end today

# æ£€æŸ¥æ•°æ®ç›®å½•
ls data/*.csv | wc -l  # åº”è¯¥æ˜¾ç¤ºè‚¡ç¥¨æ•°é‡
```

### æ­¥éª¤2ï¼šè¿è¡ŒåŸºç¡€å›æµ‹

```bash
# å›æµ‹å‡ºå‘æˆ˜æ³•ï¼ˆé»˜è®¤å‚æ•°ï¼‰
python backtest.py

# è¾“å‡ºç¤ºä¾‹ï¼š
# ============================================================
# å›æµ‹ç­–ç•¥ï¼šBreakoutPreviousHighSelector
# ============================================================
# 
# åŠ è½½æ•°æ®ï¼š./data
# æˆåŠŸåŠ è½½ 500 åªè‚¡ç¥¨
# å›æµ‹æœŸé—´ï¼š2024-01-01 è‡³ 2024-12-31
# äº¤æ˜“æ—¥æ•°é‡ï¼š244
# 
# å›æµ‹è¿›åº¦ï¼š0/244 (0.0%)
# å›æµ‹è¿›åº¦ï¼š50/244 (20.5%)
# ...
# 
# æœ€ç»ˆèµ„é‡‘ï¼š105823.45
# æ€»æ”¶ç›Šï¼š5823.45
# æ€»æ”¶ç›Šç‡ï¼š5.82%
```

### æ­¥éª¤3ï¼šæŸ¥çœ‹ç»“æœ

```bash
# æŸ¥çœ‹äº¤æ˜“è®°å½•
cat å‡ºå‘æˆ˜æ³•_å›æµ‹è®°å½•.csv

# æŸ¥çœ‹ç»Ÿè®¡æŠ¥å‘Šï¼ˆå·²åœ¨æ§åˆ¶å°è¾“å‡ºï¼‰
```

---

## ğŸ“– è¯¦ç»†ä½¿ç”¨è¯´æ˜

### åŸºç¡€å›æµ‹

```python
from backtest import Backtest

# 1. åˆ›å»ºå›æµ‹å®ä¾‹
bt = Backtest(
    data_dir="./data",          # æ•°æ®ç›®å½•
    start_date="2024-01-01",    # å›æµ‹å¼€å§‹æ—¥æœŸ
    end_date="2024-12-31",      # å›æµ‹ç»“æŸæ—¥æœŸ
    initial_capital=100000.0,   # åˆå§‹èµ„é‡‘10ä¸‡
    commission_rate=0.0003,     # ä½£é‡‘ç‡ä¸‡3
    slippage_rate=0.001         # æ»‘ç‚¹0.1%
)

# 2. è¿è¡Œå›æµ‹
trades = bt.run_strategy(
    selector_class="BreakoutPreviousHighSelector",  # ç­–ç•¥ç±»å
    params={                                        # ç­–ç•¥å‚æ•°
        "lookback_days": 60,
        "consolidation_min_days": 5,
        # ... å…¶ä»–å‚æ•°
    },
    hold_days=5,                # æŒæœ‰å¤©æ•°
    stop_loss_pct=-0.05,        # æ­¢æŸ-5%
    take_profit_pct=0.15,       # æ­¢ç›ˆ+15%
    position_per_stock=0.1,     # å•åªä»“ä½10%
    max_positions=5,            # æœ€å¤šæŒä»“5åª
    stop_loss_method="price"    # æ­¢æŸæ–¹å¼
)

# 3. æŸ¥çœ‹ç»Ÿè®¡
bt.print_stats(trades)

# 4. å¯¼å‡ºç»“æœ
bt.export_trades(trades, "å›æµ‹ç»“æœ.csv")

# 5. ç»˜åˆ¶èµ„é‡‘æ›²çº¿ï¼ˆéœ€è¦å®‰è£…matplotlibï¼‰
bt.plot_equity_curve(trades, "èµ„é‡‘æ›²çº¿.png")
```

### å¯¹æ¯”å¤šä¸ªç­–ç•¥

```python
from backtest import Backtest

bt = Backtest(
    data_dir="./data",
    start_date="2024-01-01",
    end_date="2024-12-31"
)

# å®šä¹‰è¦å¯¹æ¯”çš„ç­–ç•¥
strategies = [
    {
        "name": "å°‘å¦‡æˆ˜æ³•",
        "class": "BBIKDJSelector",
        "params": {
            "j_threshold": 15,
            "bbi_min_window": 20,
            "max_window": 120,
            "price_range_pct": 1,
            "bbi_q_threshold": 0.2,
            "j_q_threshold": 0.10
        }
    },
    {
        "name": "å‡ºå‘æˆ˜æ³•",
        "class": "BreakoutPreviousHighSelector",
        "params": {
            "lookback_days": 60,
            "consolidation_min_days": 5,
            "consolidation_max_days": 30,
            "approach_pct": 0.15,
            "vol_ratio_threshold": 2.0,
            # ... å…¶ä»–å‚æ•°
        }
    },
    {
        "name": "å¡«å‘æˆ˜æ³•",
        "class": "PeakKDJSelector",
        "params": {
            "j_threshold": 10,
            "max_window": 120,
            "fluc_threshold": 0.03,
            "j_q_threshold": 0.10,
            "gap_threshold": 0.2
        }
    }
]

# è¿è¡Œå¯¹æ¯”
results = bt.compare_strategies(strategies, hold_days=5)

# è¾“å‡ºå¯¹æ¯”è¡¨æ ¼
print(results)

# å¯¼å‡ºå¯¹æ¯”ç»“æœ
results.to_csv("ç­–ç•¥å¯¹æ¯”.csv", index=False, encoding='utf-8-sig')
```

### å‘½ä»¤è¡Œä½¿ç”¨

```bash
# å•ä¸ªç­–ç•¥å›æµ‹
python backtest.py

# ç­–ç•¥å¯¹æ¯”
python backtest.py compare
```

---

## âš™ï¸ å‚æ•°é…ç½®è¯¦è§£

### å›æµ‹åŸºç¡€å‚æ•°

#### `data_dir` - æ•°æ®ç›®å½•
```python
data_dir="./data"  # é»˜è®¤å€¼

è¯´æ˜ï¼šåŒ…å«æ‰€æœ‰è‚¡ç¥¨CSVæ–‡ä»¶çš„ç›®å½•
è¦æ±‚ï¼šæ¯ä¸ªCSVæ–‡ä»¶åä¸ºè‚¡ç¥¨ä»£ç ï¼ˆå¦‚000001.csvï¼‰
```

#### `start_date` / `end_date` - å›æµ‹æ—¥æœŸèŒƒå›´
```python
start_date="2024-01-01"  # å¼€å§‹æ—¥æœŸ
end_date="2024-12-31"    # ç»“æŸæ—¥æœŸ

è¯´æ˜ï¼šå›æµ‹çš„æ—¶é—´èŒƒå›´
æ ¼å¼ï¼šYYYY-MM-DD
å»ºè®®ï¼šè‡³å°‘6ä¸ªæœˆæ•°æ®ä»¥è·å¾—ç»Ÿè®¡æ„ä¹‰
```

#### `initial_capital` - åˆå§‹èµ„é‡‘
```python
initial_capital=100000.0  # é»˜è®¤10ä¸‡

è¯´æ˜ï¼šå›æµ‹èµ·å§‹èµ„é‡‘
å•ä½ï¼šå…ƒ
å»ºè®®ï¼š
  - å°èµ„é‡‘æµ‹è¯•ï¼š10000-50000
  - å¸¸è§„æµ‹è¯•ï¼š100000-500000
  - å¤§èµ„é‡‘æ¨¡æ‹Ÿï¼š1000000+
```

#### `commission_rate` - ä½£é‡‘ç‡
```python
commission_rate=0.0003  # ä¸‡3

è¯´æ˜ï¼šä¹°å–ä½£é‡‘æ¯”ä¾‹
å¸¸è§å€¼ï¼š
  - 0.0003: ä¸‡3ï¼ˆå¸¸è§ï¼‰
  - 0.0002: ä¸‡2.5ï¼ˆç¨ä½ï¼‰
  - 0.0001: ä¸‡1ï¼ˆå¾ˆä½ï¼‰
æœ€ä½ä½£é‡‘ï¼š5å…ƒï¼ˆå·²å†…ç½®ï¼‰
```

#### `slippage_rate` - æ»‘ç‚¹ç‡
```python
slippage_rate=0.001  # 0.1%

è¯´æ˜ï¼šä¹°å–æ—¶çš„ä»·æ ¼æ»‘åŠ¨
å½±å“ï¼š
  - ä¹°å…¥ä»· = æ”¶ç›˜ä»· Ã— (1 + æ»‘ç‚¹ç‡)
  - å–å‡ºä»· = æ”¶ç›˜ä»· Ã— (1 - æ»‘ç‚¹ç‡)
å»ºè®®å€¼ï¼š
  - æµåŠ¨æ€§å¥½ï¼š0.001 (0.1%)
  - æµåŠ¨æ€§ä¸€èˆ¬ï¼š0.002 (0.2%)
  - æµåŠ¨æ€§å·®ï¼š0.005 (0.5%)
```

### ç­–ç•¥æ‰§è¡Œå‚æ•°

#### `hold_days` - æŒæœ‰å¤©æ•°
```python
hold_days=5  # é»˜è®¤5å¤©

è¯´æ˜ï¼šè‚¡ç¥¨çš„æœ€å¤§æŒæœ‰æ—¶é—´
å½±å“ï¼šåˆ°æœŸè‡ªåŠ¨å–å‡º
è°ƒæ•´å»ºè®®ï¼š
  - è¶…çŸ­çº¿ï¼š1-3å¤©
  - çŸ­çº¿ï¼š5-10å¤©ï¼ˆæ¨èï¼‰
  - ä¸­çº¿ï¼š15-30å¤©
  - é•¿çº¿ï¼š30-60å¤©
```

#### `stop_loss_pct` - æ­¢æŸç™¾åˆ†æ¯”
```python
stop_loss_pct=-0.05  # -5%

è¯´æ˜ï¼šä»·æ ¼æ­¢æŸé˜ˆå€¼
è§¦å‘ï¼šå½“å‰æ”¶ç›Šç‡ â‰¤ æ­¢æŸç™¾åˆ†æ¯”
è°ƒæ•´å»ºè®®ï¼š
  - ä¿å®ˆå‹ï¼š-0.03 (-3%)
  - ä¸­æ€§ï¼š-0.05 (-5%)ï¼ˆæ¨èï¼‰
  - æ¿€è¿›ï¼š-0.08 (-8%)
```

#### `take_profit_pct` - æ­¢ç›ˆç™¾åˆ†æ¯”
```python
take_profit_pct=0.15  # +15%

è¯´æ˜ï¼šä»·æ ¼æ­¢ç›ˆé˜ˆå€¼
è§¦å‘ï¼šå½“å‰æ”¶ç›Šç‡ â‰¥ æ­¢ç›ˆç™¾åˆ†æ¯”
è°ƒæ•´å»ºè®®ï¼š
  - ä¿å®ˆå‹ï¼š0.08-0.10 (8-10%)
  - ä¸­æ€§ï¼š0.12-0.15 (12-15%)ï¼ˆæ¨èï¼‰
  - æ¿€è¿›ï¼š0.20+ (20%+)
```

#### `position_per_stock` - å•åªä»“ä½æ¯”ä¾‹
```python
position_per_stock=0.1  # 10%

è¯´æ˜ï¼šæ¯åªè‚¡ç¥¨å æ€»èµ„é‡‘çš„æ¯”ä¾‹
å½±å“ï¼šä¹°å…¥é‡‘é¢ = æ€»èµ„é‡‘ Ã— å•åªä»“ä½
è°ƒæ•´å»ºè®®ï¼š
  - ä¿å®ˆå‹ï¼š0.05 (5%)
  - ä¸­æ€§ï¼š0.10 (10%)ï¼ˆæ¨èï¼‰
  - æ¿€è¿›ï¼š0.15-0.20 (15-20%)
```

#### `max_positions` - æœ€å¤§æŒä»“æ•°é‡
```python
max_positions=5  # æœ€å¤š5åª

è¯´æ˜ï¼šåŒæ—¶æŒæœ‰çš„è‚¡ç¥¨æ•°é‡ä¸Šé™
å½±å“ï¼šåˆ†æ•£é£é™©ç¨‹åº¦
è°ƒæ•´å»ºè®®ï¼š
  - é›†ä¸­æŒä»“ï¼š3-5åª
  - åˆ†æ•£æŒä»“ï¼š8-12åª
  - é«˜åº¦åˆ†æ•£ï¼š15-20åª
```

#### `stop_loss_method` - æ­¢æŸæ–¹å¼
```python
stop_loss_method="price"  # é»˜è®¤ä»·æ ¼æ­¢æŸ

å¯é€‰å€¼ï¼š
  - "price": å›ºå®šæ¯”ä¾‹æ­¢æŸï¼ˆæ¨èï¼‰
  - "ma": è·Œç ´MA5æ­¢æŸ
  - "none": ä¸æ­¢æŸï¼ˆä»…åˆ°æœŸå–å‡ºï¼‰

ç‰¹ç‚¹å¯¹æ¯”ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ–¹å¼     â”‚ çµæ´»æ€§ â”‚ é£é™©   â”‚ é€‚ç”¨åœºæ™¯ â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ price    â”‚ ä¸­     â”‚ ä¸­     â”‚ é€šç”¨     â”‚
â”‚ ma       â”‚ é«˜     â”‚ ä½     â”‚ è¶‹åŠ¿è·Ÿè¸ª â”‚
â”‚ none     â”‚ ä½     â”‚ é«˜     â”‚ é•¿çº¿     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š ç»“æœåˆ†æ

### äº¤æ˜“è®°å½•æ ¼å¼

å›æµ‹ä¼šç”ŸæˆCSVæ–‡ä»¶ï¼ŒåŒ…å«ä»¥ä¸‹å­—æ®µï¼š

```
code           è‚¡ç¥¨ä»£ç 
buy_date       ä¹°å…¥æ—¥æœŸ
sell_date      å–å‡ºæ—¥æœŸ
buy_price      ä¹°å…¥ä»·æ ¼
sell_price     å–å‡ºä»·æ ¼
shares         è‚¡æ•°
hold_days      æŒæœ‰å¤©æ•°
profit_pct     æ”¶ç›Šç‡(%)
profit_amount  ç›ˆäºé‡‘é¢
sell_reason    å–å‡ºåŸå› 
commission     æ€»ä½£é‡‘
```

### ç»Ÿè®¡æŒ‡æ ‡è§£è¯»

#### åŸºç¡€æŒ‡æ ‡

```
äº¤æ˜“æ¬¡æ•°ï¼šæ€»å…±æ‰§è¡Œçš„ä¹°å–æ¬¡æ•°
ç›ˆåˆ©æ¬¡æ•°ï¼šæ”¶ç›Šä¸ºæ­£çš„äº¤æ˜“æ¬¡æ•°
äºæŸæ¬¡æ•°ï¼šæ”¶ç›Šä¸ºè´Ÿçš„äº¤æ˜“æ¬¡æ•°
èƒœç‡ï¼šç›ˆåˆ©æ¬¡æ•° / äº¤æ˜“æ¬¡æ•°

è§£è¯»ï¼š
âœ“ èƒœç‡ > 50%: ç­–ç•¥æœ‰æ­£å‘é¢„æœŸ
âœ“ èƒœç‡ 40-50%: éœ€è¦æé«˜ç›ˆäºæ¯”
âœ“ èƒœç‡ < 40%: ç­–ç•¥å¯èƒ½æœ‰é—®é¢˜
```

#### æ”¶ç›ŠæŒ‡æ ‡

```
å¹³å‡æ”¶ç›Šç‡ï¼šæ‰€æœ‰äº¤æ˜“çš„å¹³å‡æ”¶ç›Šç‡
ä¸­ä½æ•°æ”¶ç›Šç‡ï¼šæ”¶ç›Šç‡çš„ä¸­ä½æ•°ï¼ˆæ›´ç¨³å¥ï¼‰
æœ€å¤§å•ç¬”æ”¶ç›Šï¼šå•æ¬¡äº¤æ˜“çš„æœ€é«˜æ”¶ç›Šç‡
æœ€å¤§å•ç¬”äºæŸï¼šå•æ¬¡äº¤æ˜“çš„æœ€å¤§äºæŸç‡

è§£è¯»ï¼š
âœ“ å¹³å‡æ”¶ç›Šç‡ > 2%: è¾ƒå¥½
âœ“ ä¸­ä½æ•° > å¹³å‡æ•°: æ”¶ç›Šåˆ†å¸ƒå‡åŒ€
âœ“ æœ€å¤§äºæŸ < æ­¢æŸè®¾ç½®: é£æ§æœ‰æ•ˆ
```

#### ç›ˆäºæ¯”

```
ç›ˆäºæ¯” = å¹³å‡ç›ˆåˆ© / å¹³å‡äºæŸ

è§£è¯»ï¼š
âœ“ ç›ˆäºæ¯” > 2: ä¼˜ç§€
âœ“ ç›ˆäºæ¯” 1.5-2: è‰¯å¥½
âœ“ ç›ˆäºæ¯” 1-1.5: ä¸€èˆ¬
âœ“ ç›ˆäºæ¯” < 1: éœ€è¦ä¼˜åŒ–
```

#### å¤æ™®æ¯”ç‡

```
å¤æ™®æ¯”ç‡ = (å¹´åŒ–æ”¶ç›Šç‡ - æ— é£é™©åˆ©ç‡) / å¹´åŒ–æ³¢åŠ¨ç‡

è§£è¯»ï¼š
âœ“ å¤æ™®æ¯”ç‡ > 2: ä¼˜ç§€
âœ“ å¤æ™®æ¯”ç‡ 1-2: è‰¯å¥½
âœ“ å¤æ™®æ¯”ç‡ 0.5-1: ä¸€èˆ¬
âœ“ å¤æ™®æ¯”ç‡ < 0.5: é£é™©åé«˜
```

### ç¤ºä¾‹åˆ†æ

```
============================================================
å›æµ‹ç»Ÿè®¡æŠ¥å‘Š
============================================================

ã€åŸºç¡€ä¿¡æ¯ã€‘
äº¤æ˜“æ¬¡æ•°ï¼š45
ç›ˆåˆ©æ¬¡æ•°ï¼š28
äºæŸæ¬¡æ•°ï¼š17
èƒœç‡ï¼š62.22%               â† èƒœç‡è¶…è¿‡60%ï¼Œä¸é”™

ã€æ”¶ç›Šç»Ÿè®¡ã€‘
å¹³å‡æ”¶ç›Šç‡ï¼š3.15%          â† å¹³å‡æ¯ç¬”3.15%ï¼Œå¾ˆå¥½
ä¸­ä½æ•°æ”¶ç›Šç‡ï¼š2.80%        â† ä¸­ä½æ•°æ¥è¿‘å¹³å‡ï¼Œåˆ†å¸ƒå‡åŒ€
æœ€å¤§å•ç¬”æ”¶ç›Šï¼š18.50%       â† æœ€å¤§ç›ˆåˆ©18.5%
æœ€å¤§å•ç¬”äºæŸï¼š-5.00%       â† æœ€å¤§äºæŸ-5%ï¼Œç¬¦åˆæ­¢æŸè®¾ç½®
æ€»ç›ˆåˆ©é‡‘é¢ï¼š8520.00        â† æ€»ç›ˆåˆ©8520å…ƒ
æ€»äºæŸé‡‘é¢ï¼š-2650.00       â† æ€»äºæŸ2650å…ƒ
å‡€åˆ©æ¶¦ï¼š5870.00            â† å‡€åˆ©æ¶¦5870å…ƒ

ã€æŒä»“ç»Ÿè®¡ã€‘
å¹³å‡æŒä»“å¤©æ•°ï¼š3.2å¤©        â† å¹³å‡3.2å¤©ï¼Œç¬¦åˆçŸ­çº¿ç­–ç•¥
æœ€é•¿æŒä»“ï¼š5å¤©              â† æœ€é•¿5å¤©ï¼Œç¬¦åˆè®¾ç½®
æœ€çŸ­æŒä»“ï¼š1å¤©              â† æœ€çŸ­1å¤©ï¼Œè¯´æ˜æœ‰å¿«é€Ÿæ­¢ç›ˆ

ã€è´¹ç”¨ç»Ÿè®¡ã€‘
æ€»äº¤æ˜“ä½£é‡‘ï¼š135.00         â† ä½£é‡‘å å‡€åˆ©æ¶¦2.3%

ã€å–å‡ºåŸå› ã€‘
  åˆ°æœŸ(5å¤©,+3.15%): 28æ¬¡ (62.2%)   â† å¤§éƒ¨åˆ†æ˜¯æ­£å¸¸åˆ°æœŸ
  æ­¢ç›ˆ(+15.00%): 8æ¬¡ (17.8%)        â† 18%è¾¾åˆ°æ­¢ç›ˆç›®æ ‡
  æ­¢æŸ(-5.00%): 9æ¬¡ (20.0%)         â† 20%è§¦å‘æ­¢æŸ

åˆ†æç»“è®ºï¼š
âœ… èƒœç‡62%ï¼Œè¶…è¿‡50%çš„åˆæ ¼çº¿
âœ… ç›ˆäºæ¯”çº¦3.2:1 (8520/2650)ï¼Œä¼˜ç§€
âœ… é£æ§æœ‰æ•ˆï¼Œæœ€å¤§äºæŸç¬¦åˆé¢„æœŸ
âœ… ç­–ç•¥è¡¨ç°ç¨³å®šï¼Œæ”¶ç›Šåˆ†å¸ƒå‡åŒ€
âš ï¸ ä½£é‡‘å æ¯”2.3%ï¼Œå¯ä»¥æ¥å—
```

---

## ğŸ¯ ä¼˜åŒ–å»ºè®®

### 1. å‚æ•°ä¼˜åŒ–

#### ç½‘æ ¼æœç´¢æ³•

```python
from backtest import Backtest
import itertools

bt = Backtest(
    data_dir="./data",
    start_date="2024-01-01",
    end_date="2024-12-31"
)

# å®šä¹‰å‚æ•°ç½‘æ ¼
param_grid = {
    'hold_days': [3, 5, 7, 10],
    'stop_loss_pct': [-0.03, -0.05, -0.08],
    'take_profit_pct': [0.10, 0.15, 0.20],
    'position_per_stock': [0.08, 0.10, 0.15]
}

# ç”Ÿæˆæ‰€æœ‰ç»„åˆ
keys = param_grid.keys()
values = param_grid.values()
combinations = list(itertools.product(*values))

best_result = None
best_return = -float('inf')

# éå†æ‰€æœ‰ç»„åˆ
for combo in combinations:
    params = dict(zip(keys, combo))
    print(f"\næµ‹è¯•å‚æ•°ï¼š{params}")
    
    trades = bt.run_strategy(
        selector_class="BreakoutPreviousHighSelector",
        params={},  # ç­–ç•¥å‚æ•°ä¿æŒä¸å˜
        **params
    )
    
    if not trades.empty:
        total_return = trades['profit_amount'].sum() / bt.initial_capital * 100
        win_rate = (trades['profit_pct'] > 0).sum() / len(trades) * 100
        
        print(f"æ€»æ”¶ç›Šç‡ï¼š{total_return:.2f}%")
        print(f"èƒœç‡ï¼š{win_rate:.2f}%")
        
        if total_return > best_return:
            best_return = total_return
            best_result = params

print(f"\næœ€ä¼˜å‚æ•°ï¼š{best_result}")
print(f"æœ€ä¼˜æ”¶ç›Šç‡ï¼š{best_return:.2f}%")
```

#### é€å‚æ•°ä¼˜åŒ–

```python
# ç¤ºä¾‹ï¼šä¼˜åŒ–æŒæœ‰å¤©æ•°
hold_days_list = [1, 3, 5, 7, 10, 15, 20]
results = []

for days in hold_days_list:
    trades = bt.run_strategy(
        selector_class="BreakoutPreviousHighSelector",
        params={},
        hold_days=days,
        stop_loss_pct=-0.05,
        take_profit_pct=0.15
    )
    
    if not trades.empty:
        total_return = trades['profit_amount'].sum() / bt.initial_capital * 100
        win_rate = (trades['profit_pct'] > 0).sum() / len(trades) * 100
        avg_return = trades['profit_pct'].mean()
        
        results.append({
            'hold_days': days,
            'total_return': total_return,
            'win_rate': win_rate,
            'avg_return': avg_return,
            'trades_count': len(trades)
        })

df_results = pd.DataFrame(results)
print(df_results.to_string(index=False))

# æ‰¾å‡ºæœ€ä¼˜æŒæœ‰å¤©æ•°
best_days = df_results.loc[df_results['total_return'].idxmax(), 'hold_days']
print(f"\næœ€ä¼˜æŒæœ‰å¤©æ•°ï¼š{best_days}å¤©")
```

### 2. ç­–ç•¥ç»„åˆ

```python
# å¤šç­–ç•¥ç»„åˆå›æµ‹
class PortfolioBacktest(Backtest):
    """ç»„åˆç­–ç•¥å›æµ‹"""
    
    def run_portfolio(self, strategies: List[Dict], weight_per_strategy: float = 0.3):
        """
        è¿è¡Œç»„åˆç­–ç•¥
        
        Args:
            strategies: ç­–ç•¥åˆ—è¡¨
            weight_per_strategy: æ¯ä¸ªç­–ç•¥çš„èµ„é‡‘æƒé‡
        """
        all_picks = {}
        
        for date in self.trade_dates:
            date_picks = []
            
            for strategy in strategies:
                selector = self._instantiate_selector(strategy)
                picks = selector.select(date, self.data)
                date_picks.extend(picks)
            
            # å»é‡å¹¶é™åˆ¶æ•°é‡
            all_picks[date] = list(set(date_picks))[:self.max_positions]
        
        # æ‰§è¡Œäº¤æ˜“é€»è¾‘...
```

### 3. æ»šåŠ¨å›æµ‹

```python
def rolling_backtest(
    start_date: str,
    end_date: str,
    window_months: int = 6,
    step_months: int = 1
):
    """
    æ»šåŠ¨çª—å£å›æµ‹
    
    Args:
        start_date: æ€»èµ·å§‹æ—¥æœŸ
        end_date: æ€»ç»“æŸæ—¥æœŸ  
        window_months: å›æµ‹çª—å£ï¼ˆæœˆï¼‰
        step_months: æ»šåŠ¨æ­¥é•¿ï¼ˆæœˆï¼‰
    """
    results = []
    
    current_start = pd.Timestamp(start_date)
    total_end = pd.Timestamp(end_date)
    
    while current_start < total_end:
        current_end = current_start + pd.DateOffset(months=window_months)
        
        if current_end > total_end:
            break
        
        print(f"\nå›æµ‹çª—å£ï¼š{current_start.date()} è‡³ {current_end.date()}")
        
        bt = Backtest(
            data_dir="./data",
            start_date=str(current_start.date()),
            end_date=str(current_end.date())
        )
        
        trades = bt.run_strategy(
            selector_class="BreakoutPreviousHighSelector",
            params={},
            hold_days=5
        )
        
        if not trades.empty:
            total_return = trades['profit_amount'].sum() / bt.initial_capital * 100
            win_rate = (trades['profit_pct'] > 0).sum() / len(trades) * 100
            
            results.append({
                'period': f"{current_start.date()} ~ {current_end.date()}",
                'return': total_return,
                'win_rate': win_rate,
                'trades': len(trades)
            })
        
        current_start += pd.DateOffset(months=step_months)
    
    df_results = pd.DataFrame(results)
    print(f"\næ»šåŠ¨å›æµ‹ç»“æœï¼š")
    print(df_results.to_string(index=False))
    
    return df_results
```

---

## â“ å¸¸è§é—®é¢˜

### Q1ï¼šå›æµ‹ç»“æœå¾ˆå¥½ï¼Œä½†å®ç›˜äºæŸï¼Ÿ

```
å¯èƒ½åŸå› ï¼š
1. è¿‡åº¦æ‹Ÿåˆ
   - å‚æ•°è¿‡äºç²¾ç»†
   - æ ·æœ¬é‡ä¸è¶³
   è§£å†³ï¼šä½¿ç”¨æ›´é•¿æ—¶é—´çª—å£ï¼Œç®€åŒ–å‚æ•°

2. æ»‘ç‚¹å’Œä½£é‡‘ä½ä¼°
   - å®ç›˜æ»‘ç‚¹æ›´å¤§
   - æ²¡è€ƒè™‘å†²å‡»æˆæœ¬
   è§£å†³ï¼šæé«˜æ»‘ç‚¹ç‡åˆ°0.2-0.5%

3. å¸‚åœºç¯å¢ƒå˜åŒ–
   - å›æµ‹æœŸæ˜¯ç‰›å¸‚ï¼Œå®ç›˜æ˜¯ç†Šå¸‚
   è§£å†³ï¼šåœ¨ä¸åŒå¸‚åœºç¯å¢ƒä¸‹æµ‹è¯•

4. æµåŠ¨æ€§é—®é¢˜
   - å›æµ‹å‡è®¾éƒ½èƒ½æˆäº¤
   - å®ç›˜å¯èƒ½ä¹°ä¸åˆ°
   è§£å†³ï¼šæ·»åŠ æˆäº¤é‡è¿‡æ»¤
```

### Q2ï¼šå¦‚ä½•é¿å…è¿‡æ‹Ÿåˆï¼Ÿ

```
é˜²æ­¢è¿‡æ‹Ÿåˆçš„æ–¹æ³•ï¼š

1. æ ·æœ¬å¤–æµ‹è¯•
   - è®­ç»ƒæœŸï¼š2023-2024
   - æµ‹è¯•æœŸï¼š2022
   - éªŒè¯æœŸï¼š2021

2. äº¤å‰éªŒè¯
   - æ»šåŠ¨çª—å£å›æµ‹
   - å¤šä¸ªæ—¶é—´æ®µéªŒè¯

3. ç®€åŒ–ç­–ç•¥
   - å‚æ•°ä¸è¦å¤ªå¤š
   - é€»è¾‘è¦ç®€å•æ¸…æ™°

4. ç»Ÿè®¡æ£€éªŒ
   - tæ£€éªŒ
   - è’™ç‰¹å¡æ´›æ¨¡æ‹Ÿ
```

### Q3ï¼šèƒœç‡å’Œç›ˆäºæ¯”å“ªä¸ªæ›´é‡è¦ï¼Ÿ

```
ä¸¤è€…éƒ½é‡è¦ï¼Œä½†ä¾§é‡ç‚¹ä¸åŒï¼š

é«˜èƒœç‡ä½ç›ˆäºæ¯”ï¼ˆ60%èƒœç‡ï¼Œ1.5ç›ˆäºæ¯”ï¼‰ï¼š
âœ“ äº¤æ˜“èˆ’é€‚åº¦é«˜
âœ“ é€‚åˆæ–°æ‰‹
âœ“ èµ„é‡‘æ›²çº¿å¹³æ»‘

ä½èƒœç‡é«˜ç›ˆäºæ¯”ï¼ˆ40%èƒœç‡ï¼Œ3.0ç›ˆäºæ¯”ï¼‰ï¼š
âœ“ é•¿æœŸæ”¶ç›Šå¯èƒ½æ›´é«˜
âœ“ éœ€è¦å¼ºå¤§å¿ƒç†ç´ è´¨
âœ“ èµ„é‡‘æ›²çº¿æ³¢åŠ¨å¤§

ç†æƒ³çŠ¶æ€ï¼š
èƒœç‡50-60% + ç›ˆäºæ¯”2-3
```

### Q4ï¼šå›æµ‹è¦å¤šé•¿æ—¶é—´çš„æ•°æ®ï¼Ÿ

```
æ¨èæ—¶é•¿ï¼š

æœ€å°‘ï¼š6ä¸ªæœˆï¼ˆ1ä¸ªå®Œæ•´å¸‚åœºå‘¨æœŸï¼‰
å¸¸è§„ï¼š1-2å¹´ï¼ˆåŒ…å«ç‰›ç†Šè½¬æ¢ï¼‰
ç†æƒ³ï¼š3-5å¹´ï¼ˆå¤šä¸ªå¸‚åœºå‘¨æœŸï¼‰
é•¿æœŸï¼š5å¹´ä»¥ä¸Šï¼ˆå……åˆ†éªŒè¯ï¼‰

æ³¨æ„ï¼š
- å¤ªçŸ­ï¼šç»Ÿè®¡æ„ä¹‰ä¸è¶³
- å¤ªé•¿ï¼šå¸‚åœºç¯å¢ƒå¯èƒ½å·²å˜
- å»ºè®®ï¼šè‡³å°‘åŒ…å«1æ¬¡ç†Šå¸‚
```

### Q5ï¼šå¦‚ä½•è®¾ç½®åˆç†çš„æ­¢æŸæ­¢ç›ˆï¼Ÿ

```
æ­¢æŸè®¾ç½®ï¼š

åŸºäºæ³¢åŠ¨ç‡ï¼š
- ATR Ã— 2ï¼šé€‚åˆè¶‹åŠ¿ç­–ç•¥
- æ—¥å†…æŒ¯å¹…ï¼š-3% ~ -5%
- å›ºå®šæ¯”ä¾‹ï¼š-5%ï¼ˆæ¨èï¼‰

åŸºäºæŠ€æœ¯ä½ï¼š
- è·Œç ´MA5/MA10
- è·Œç ´æ”¯æ’‘ä½
- è·Œç ´ä¹°å…¥ä»·Ã—(1-3%)

æ­¢ç›ˆè®¾ç½®ï¼š

åˆ†æ‰¹æ­¢ç›ˆï¼ˆæ¨èï¼‰ï¼š
- ç¬¬ä¸€ç›®æ ‡ï¼š+5%ï¼Œå–30%
- ç¬¬äºŒç›®æ ‡ï¼š+10%ï¼Œå–40%
- ç¬¬ä¸‰ç›®æ ‡ï¼š+15%ï¼Œå–30%

å›ºå®šæ­¢ç›ˆï¼š
- çŸ­çº¿ï¼š+8% ~ +12%
- ä¸­çº¿ï¼š+15% ~ +20%
- é•¿çº¿ï¼š+30%+

ç§»åŠ¨æ­¢ç›ˆï¼š
- è¾¾åˆ°+10%åï¼Œæ­¢æŸæå‡åˆ°+5%
- è¾¾åˆ°+15%åï¼Œæ­¢æŸæå‡åˆ°+10%
```

---

## ğŸ“š é«˜çº§è¯é¢˜

### è’™ç‰¹å¡æ´›æ¨¡æ‹Ÿ

```python
def monte_carlo_simulation(trades: pd.DataFrame, n_simulations: int = 1000):
    """
    è’™ç‰¹å¡æ´›æ¨¡æ‹Ÿï¼šéšæœºæ‰“ä¹±äº¤æ˜“é¡ºåºï¼Œè¯„ä¼°ç­–ç•¥ç¨³å¥æ€§
    """
    import random
    
    returns = trades['profit_pct'].values
    n_trades = len(returns)
    
    simulated_returns = []
    
    for _ in range(n_simulations):
        # éšæœºæ‰“ä¹±
        shuffled = random.sample(list(returns), n_trades)
        cumulative_return = sum(shuffled)
        simulated_returns.append(cumulative_return)
    
    # ç»Ÿè®¡
    mean_return = np.mean(simulated_returns)
    std_return = np.std(simulated_returns)
    
    # 95%ç½®ä¿¡åŒºé—´
    lower_bound = np.percentile(simulated_returns, 2.5)
    upper_bound = np.percentile(simulated_returns, 97.5)
    
    print(f"è’™ç‰¹å¡æ´›æ¨¡æ‹Ÿç»“æœï¼ˆ{n_simulations}æ¬¡ï¼‰ï¼š")
    print(f"å¹³å‡æ€»æ”¶ç›Šç‡ï¼š{mean_return:.2f}%")
    print(f"æ ‡å‡†å·®ï¼š{std_return:.2f}%")
    print(f"95%ç½®ä¿¡åŒºé—´ï¼š[{lower_bound:.2f}%, {upper_bound:.2f}%]")
```

### æœ€å¤§å›æ’¤åˆ†æ

```python
def calculate_max_drawdown(trades: pd.DataFrame):
    """è®¡ç®—æœ€å¤§å›æ’¤"""
    trades = trades.sort_values('sell_date')
    cumulative = trades['profit_amount'].cumsum()
    
    # è®¡ç®—å›æ’¤
    running_max = cumulative.cummax()
    drawdown = (cumulative - running_max) / running_max
    
    max_dd = drawdown.min()
    max_dd_date = trades.iloc[drawdown.idxmin()]['sell_date']
    
    print(f"æœ€å¤§å›æ’¤ï¼š{max_dd*100:.2f}%")
    print(f"å‘ç”Ÿæ—¥æœŸï¼š{max_dd_date}")
    
    return max_dd
```

---

## ğŸ“ å­¦ä¹ è·¯å¾„

### å…¥é—¨ï¼ˆ1-2å‘¨ï¼‰
1. ç†è§£å›æµ‹åŸºæœ¬æ¦‚å¿µ
2. è¿è¡Œé»˜è®¤å‚æ•°å›æµ‹
3. å­¦ä¼šåˆ†æç»Ÿè®¡æŠ¥å‘Š
4. å°è¯•è°ƒæ•´ç®€å•å‚æ•°

### è¿›é˜¶ï¼ˆ2-4å‘¨ï¼‰
1. ç½‘æ ¼æœç´¢ä¼˜åŒ–å‚æ•°
2. å¯¹æ¯”å¤šä¸ªç­–ç•¥
3. ç†è§£ç›ˆäºæ¯”å’Œèƒœç‡
4. å­¦ä¹ é£é™©ç®¡ç†

### é«˜çº§ï¼ˆ1-3æœˆï¼‰
1. å®ç°è‡ªå®šä¹‰å›æµ‹æŒ‡æ ‡
2. å¼€å‘ç»„åˆç­–ç•¥
3. è’™ç‰¹å¡æ´›æ¨¡æ‹Ÿ
4. æ»šåŠ¨çª—å£éªŒè¯

---

**âš ï¸ é£é™©æç¤º**

å›æµ‹ç»“æœä¸ä»£è¡¨æœªæ¥æ”¶ç›Šã€‚å®ç›˜äº¤æ˜“å‰è¯·ï¼š
- âœ… å……åˆ†ç†è§£ç­–ç•¥é€»è¾‘
- âœ… åœ¨æ¨¡æ‹Ÿç›˜éªŒè¯
- âœ… å°èµ„é‡‘è¯•é”™
- âœ… ä¸¥æ ¼é£é™©æ§åˆ¶
- âœ… æŒç»­å­¦ä¹ æ”¹è¿›

---

**ç¥ä½ å›æµ‹é¡ºåˆ©ï¼Œäº¤æ˜“æ„‰å¿«ï¼** ğŸ“ˆ


