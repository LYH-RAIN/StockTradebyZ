# 📈 知行体系趋势线 - 标准公式

## 🎯 核心算法

### 1. 短期趋势线
```
短期趋势线 = EMA(EMA(CLOSE, 10), 10)
```

**说明**：
- 对收盘价进行10日EMA（指数移动平均）
- 再对结果进行第二次10日EMA
- **双重平滑**，更稳定，减少毛刺

**特点**：
- 比单一均线更平滑
- 对价格变化的响应速度适中
- 适合判断短期趋势方向

---

### 2. 知行多空线
```
知行多空线 = (MA(14) + MA(28) + MA(57) + MA(114)) / 4
```

**说明**：
- 计算14日、28日、57日、114日简单移动平均
- 对四条均线求平均值
- 综合短中长期趋势

**特点**：
- 更平滑的长期趋势线
- 反应较慢，但稳定性强
- 适合判断整体趋势方向

---

### 3. 差值百分比
```
差值百分比 = ABS((CLOSE - 短期趋势线) / 短期趋势线) × 100
```

**用途**：
- 衡量价格偏离短期趋势的程度
- 差值过大（>5%）可能回调
- 差值过小（<1%）可能突破

---

### 4. 短期趋势在上
```
短期趋势在上 = 短期趋势线 > 知行多空线
```

**用途**：
- 判断当前是多头还是空头
- `True` = 多头市场
- `False` = 空头市场

---

## 📊 趋势判断标准

### 🟢 强势多头（最佳）
```
条件：
✅ 收盘价 > 短期趋势线 > 知行多空线
✅ 短期趋势线向上
✅ 差值百分比 < 5%

操作：
→ 积极做多
→ B1信号可重仓（30-50%）
→ 持股为主
```

### 🟡 中性整理
```
条件：
⚠️ 短期趋势线 > 知行多空线
⚠️ 但价格在短期趋势线下方

或者：
⚠️ 短期趋势线 < 知行多空线
⚠️ 但价格在短期趋势线上方

操作：
→ 观望为主
→ B1信号轻仓（10-20%）
→ 快进快出
```

### 🔴 弱势空头（危险）
```
条件：
❌ 收盘价 < 短期趋势线 < 知行多空线
❌ 短期趋势线向下

操作：
→ 不做B1
→ 看到S1立即离场
→ 空仓观望
```

---

## 🎨 K线图显示

### 颜色和样式
- **短期趋势线**：
  - 颜色：红色（#FF6B6B）
  - 宽度：2.5px（粗线）
  - 名称："短期趋势线"

- **知行多空线**：
  - 颜色：蓝色（#1976D2）
  - 宽度：2.5px（粗线）
  - 名称："知行多空线"

### 视觉判断
```
价格位置高 ━━━━━━━━━━━━━━━━━━━
              K线价格区域
━━━━━━━━ 短期趋势线（红色）━━━━━━
              
━━━━━━━━ 知行多空线（蓝色）━━━━━━
价格位置低 ━━━━━━━━━━━━━━━━━━━

✅ 理想形态：K线在红线上方，红线在蓝线上方
⚠️ 警惕形态：K线在红线下方，或红线在蓝线下方
```

---

## 💡 实战应用

### 案例1：强势多头买入

**图表特征**：
```
Day 1-10: 
  价格持续上涨
  短期趋势线（红）向上
  知行多空线（蓝）向上
  红线在蓝线上方
  
Day 11:
  出现B1信号（绿色▲）
  价格在红线上方
  红线在蓝线上方
  差值百分比 = 2.5%（正常）
```

**操作**：
```
✅ 这是最佳买点！
→ 重仓买入（30-50%）
→ 止损设在短期趋势线下方
→ 持有至S1或跌破短期趋势线
```

---

### 案例2：弱势反弹（谨慎）

**图表特征**：
```
Day 1-10:
  价格下跌
  短期趋势线（红）向下
  知行多空线（蓝）向下
  红线在蓝线下方
  
Day 11:
  出现B1信号（绿色▲）
  价格短暂反弹至红线
  但红线仍在蓝线下方
```

**操作**：
```
⚠️ 这是弱势反弹！
→ 不建议买入
→ 或极轻仓（5-10%）
→ 设置更严格的止损
→ 快进快出
```

---

### 案例3：趋势转折点

**图表特征**：
```
Day 1-20:
  价格下跌
  红线在蓝线下方（空头）
  
Day 21-25:
  价格开始企稳
  红线向上拐头
  
Day 26:
  红线上穿蓝线（金叉）✨
  出现B1信号
  价格站上红线
```

**操作**：
```
⭐ 这是趋势转折的关键点！
→ 积极买入（20-30%）
→ 这可能是波段底部
→ 止损设在蓝线下方
→ 目标看上一个高点
```

---

## 📐 差值百分比的应用

### 差值 < 1%（价格贴近趋势线）
```
含义：价格与趋势线非常接近
信号：可能即将突破或回调

操作：
→ 观察K线形态
→ 如果是大阳线突破，追涨
→ 如果是阴线，等待回调
```

### 差值 1-3%（正常范围）
```
含义：价格在趋势线附近波动
信号：趋势延续

操作：
→ 持股为主
→ 不追涨不杀跌
→ 等待B1或S1信号
```

### 差值 3-5%（警戒区域）
```
含义：价格偏离趋势线较多
信号：可能回调或加速

操作：
→ 警惕回调风险
→ 如果盈利，考虑部分止盈
→ 不要追高
```

### 差值 > 5%（危险区域）
```
含义：价格严重偏离趋势线
信号：高概率回调

操作：
→ 不买入
→ 持仓者减仓或止盈
→ 等待回调至趋势线附近
```

---

## 🎯 配合B1信号使用

### 最佳B1买点（五星推荐⭐⭐⭐⭐⭐）
```
✅ 出现B1信号（绿色▲）
✅ 价格 > 短期趋势线 > 知行多空线
✅ 短期趋势线向上
✅ 差值百分比 < 3%
✅ MACD金叉
✅ KDJ低位金叉

→ 重仓买入（30-50%）
```

### 一般B1买点（三星推荐⭐⭐⭐）
```
✅ 出现B1信号
⚠️ 短期趋势线 > 知行多空线
⚠️ 但价格在短期趋势线下方
或者差值百分比 > 3%

→ 轻仓买入（10-20%）
```

### 不建议的B1（不推荐❌）
```
✅ 出现B1信号
❌ 短期趋势线 < 知行多空线（空头排列）
❌ 短期趋势线向下

→ 不买入
```

---

## 🔍 趋势线与止损

### 动态止损设置

**初始止损**：
```
止损位 = B1当日K线最低价 - (2-5个价位)
```

**趋势跟踪止损**（持仓中）：
```
如果盈利 > 5%：
  止损位 = MAX(B1最低价, 短期趋势线 - 1%)
  
如果盈利 > 10%：
  止损位 = MAX(B1最低价, 短期趋势线)
  
如果盈利 > 20%：
  止损位 = 短期趋势线
```

**趋势破坏止损**：
```
如果价格跌破短期趋势线：
  → 观察1-2天
  → 如果不能快速收回，离场
  
如果短期趋势线下穿知行多空线：
  → 趋势转空
  → 立即离场
```

---

## 📊 数据验证

### API返回数据示例
```json
{
  "dates": ["2025-06-15", "2025-06-16", ...],
  "close": [10.50, 10.80, ...],
  "trend_short": [10.45, 10.52, ...],
  "trend_long": [10.30, 10.32, ...],
  "trend_diff_pct": [0.48, 2.67, ...],
  "trend_short_above": [true, true, ...]
}
```

### 前端显示
- 红色粗线：短期趋势线（EMA双重平滑）
- 蓝色粗线：知行多空线（四均线平均）
- 鼠标悬停显示数值
- 图例清晰标注

---

## 🔧 参数调整（高级）

如果需要调整趋势线的敏感度，可修改 `web_app.py`:

### 调整短期趋势线
```python
# 当前：EMA(EMA(CLOSE, 10), 10)
# 更敏感：EMA(EMA(CLOSE, 5), 5)   # 改为5日
# 更平滑：EMA(EMA(CLOSE, 20), 20) # 改为20日

ema1 = df['close'].ewm(span=10, adjust=False).mean()  # 这里改
df['trend_short'] = ema1.ewm(span=10, adjust=False).mean()  # 这里改
```

### 调整知行多空线
```python
# 当前：(MA(14)+MA(28)+MA(57)+MA(114))/4
# 更敏感：(MA(7)+MA(14)+MA(28)+MA(57))/4
# 更平滑：(MA(28)+MA(57)+MA(114)+MA(228))/4

ma14 = df['close'].rolling(14, min_periods=1).mean()  # 改这些数字
ma28 = df['close'].rolling(28, min_periods=1).mean()
ma57 = df['close'].rolling(57, min_periods=1).mean()
ma114 = df['close'].rolling(114, min_periods=1).mean()
```

---

## 📚 延伸阅读

- [B1交易体系快速指南.md](B1交易体系快速指南.md)
- [交易信号系统说明.md](交易信号系统说明.md)
- [K线图优化说明.md](K线图优化说明.md)

---

**更新时间**：2025-11-21 23:35  
**版本**：v1.0 知行体系标准版  
**公式来源**：知行交易系统标准算法

**祝你交易顺利！** 📈✨

