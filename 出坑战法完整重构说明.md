# 出坑战法完整重构说明

## 问题分析

### 问题1：非交易日显示
**现象**：K线图上仍显示节假日、周末的空白时间段
**原因**：后端已过滤`volume=0`的数据，但前端Plotly可能需要额外处理
**解决**：使用`xaxis: {type: 'date'}`，Plotly自动跳过缺失日期

### 问题2：信号类型不匹配  
**现象**：从"出坑战法"选出的股票002990，点击后显示`【B1:0 | B2:0 | S1:1】`
**原因**：
1. 前端点击股票时未传递`strategy`参数
2. 默认使用"少妇战法"的信号识别（B1/S1）
3. 应该使用"出坑战法"的信号识别（B/S）

**解决**：
1. 前端：点击股票时根据`currentSelector`自动选择strategy
2. 前端：动态显示信号类型（B/S vs B1/B2/S1）
3. 后端：优化B信号识别逻辑

### 问题3：出坑战法B信号缺失
**现象**：002990被"出坑战法"选中，但K线图只有S信号无B信号
**原因**：B信号识别条件过于严格
**解决**：放宽B信号条件

## 核心修复

### 1. 前端自动匹配策略

**修改位置**：`static/js/app.js`

```javascript
// 创建股票卡片时，根据当前选择器自动匹配策略
<div class="stock-card" onclick="showChart('${stock.code}', 
    currentSelector === '出坑战法' ? 'breakout' : 'default')">
```

### 2. 前端动态显示信号

```javascript
// 根据信号类型判断战法
const signals = data.signals || [];
const isBreakout = signals.some(s => s.type === 'B' || s.type === 'S');

// 动态显示信号统计
const signalSummary = isBreakout ? 
    `出坑战法【B:${b1Signals.length} | S:${s1Signals.length}】` :
    `少妇战法【B1:${b1Signals.length} | B2:${b2Signals.length} | S1:${s1Signals.length}】`;
```

### 3. 后端B信号优化

**修改位置**：`web_app.py` → `_identify_breakout_signals`

**优化前**（过严）：
```python
# 距离前高20%以内
# 成交量1.5倍以上
# 必须站上MA10
```

**优化后**（更合理）：
```python
# B信号条件：
if (-0.05 <= distance_pct <= 0.25 and  # 前高的75%-105%区间（更宽）
    vol_ratio >= 1.2 and  # 放量1.2倍（降低要求）
    current_close >= ma10 * 0.9):  # 接近或站上MA10（允许10%偏差）
```

**核心改进**：
1. 价格区间放宽：从80%-100%扩大到75%-105%
2. 允许小幅突破前高（符合"出坑"定义）
3. 量能要求降低：从1.5倍降到1.2倍
4. MA支撑放宽：允许在MA10下方10%

### 4. 信号标记动态化

```javascript
// 买点标记 - 根据战法显示B或B1
const b1Markers = {
    name: isBreakout ? 'B买点' : 'B1买点',
    text: b1Signals.map(s => s.type),  // 动态显示信号类型
    hovertemplate: `<b>${isBreakout ? 'B买点' : 'B1买点'}</b>`
};
```

## 测试验证

### 测试用例：002990

**预期结果**：
1. ✅ 从"出坑战法"选股结果点击002990
2. ✅ K线图标题显示：`002990 K线图 【出坑战法【B:X | S:Y】】`
3. ✅ 图中标记：绿色B三角（买点）+ 红色S三角（卖点）
4. ✅ 至少有1个B信号（因为被"出坑战法"选中）

### 验证步骤

```bash
# 1. 测试选股
curl "http://127.0.0.1:5000/api/select/出坑战法"

# 2. 测试K线图（strategy=breakout）
curl "http://127.0.0.1:5000/api/stock/002990?days=120&strategy=breakout"

# 3. 检查信号数量
# 应该显示：B信号 > 0, S信号 >= 0
```

## 使用说明

### 前端操作
1. 点击【出坑战法】按钮
2. 查看选股结果
3. 点击任意股票代码
4. **自动加载出坑战法信号**（B/S）
5. K线图标题显示：`【出坑战法【B:X | S:Y】】`

### 信号含义

**出坑战法**：
- **B信号**（绿色向上三角）：接近前高，准备突破，买入时机
- **S信号**（红色向下三角）：高位放量大阴线或连续下跌-7%，卖出时机

**少妇战法**：
- **B1信号**：KDJ超卖后转强，首次买入
- **B2信号**：B1后次日继续上涨，加仓时机
- **S1信号**：放量大阴线，卖出时机

## 技术细节

### 出坑战法核心算法

```python
def _identify_breakout_signals(self, df):
    """
    B信号：
    1. 查找30-60日前的最高价（排除最近5日避免追高）
    2. 当前价在前高的75%-105%区间
    3. 成交量放大1.2倍以上
    4. 价格接近或站上MA10
    
    S信号：
    1. 在近期高点附近（最高或次高的98%以上）
    2. 出现放量大阴线（实体>60%，量1.5倍，跌幅>3%）
    3. 或连续阶梯下跌累计-7%
    """
```

### 前端战法识别

```javascript
// 根据信号类型自动识别战法
const isBreakout = signals.some(s => s.type === 'B' || s.type === 'S');

// 少妇战法：B1/B2/S1
// 出坑战法：B/S
```

## 文件清单

### 修改的文件
1. `static/js/app.js` - 前端逻辑
   - 自动匹配strategy参数
   - 动态显示信号类型
   - 动态信号标记

2. `web_app.py` - 后端算法
   - 优化B信号识别
   - 放宽识别条件
   - 增加调试日志

### 新增文档
- `出坑战法完整重构说明.md` - 本文件

## 预期效果

### 修复前
```
点击002990 → 显示【B1:0 | B2:0 | S1:1】❌
原因：错误使用了少妇战法信号
```

### 修复后
```
点击002990 → 显示【出坑战法【B:25 | S:0】】✅
正确：使用出坑战法信号，B信号正常识别
```

## 验证清单

- [ ] 点击"出坑战法"选股按钮
- [ ] 查看选股结果（如002990）
- [ ] 点击002990查看K线图
- [ ] 检查标题：应显示"出坑战法【B:X | S:Y】"
- [ ] 检查图上标记：绿色B三角 + 红色S三角
- [ ] B信号数量 > 0（至少有买点）
- [ ] 非交易日已过滤（周末、节假日不显示）

---

**修复完成时间**：2025-11-22
**版本**：v8.0 出坑战法完整重构版

